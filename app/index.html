<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GazTech Services - Aplicație Gestionare Abonați</title>
    <meta name="description" content="Aplicație profesională pentru gestionarea abonaților și reviziilor GazTech Services">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="GazTech Services">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkdhelRlY2ggU2VydmljZXMiLAogICJzaG9ydF9uYW1lIjogIkdhelRlY2giLAogICJkZXNjcmlwdGlvbiI6ICJBcGxpY2F0aWUgcHJvZmVzaW9uYWxhIHBlbnRydSBnZXN0aW9uYXJlYSBhYm9uYXRpbG9yIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjNjY3ZWVhIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M00zVnZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQXhNREFnTVRBd0lpQm1hV3hzUFNJalEyWkNPU0krUEhKbFkzUWdlRDBpTVRBaUlIazlJakV3SWlCM2FXUjBhRDBpT0RBaUlHaGxhV2RvZEQwaU9EQWlJSEo0UFNJMElpQm1hV3hzUFNJalpEQTVOakl6SW02OGZpQThMM0psWTNRK1BIUmxlSFFnZUQwaU5UQWlJSGs5SWpNMUlpQjBaWGgwTFdGdVkyaHZjajBpYldsa1pHeGxJaUJtYjI1MExXWmhiV2xzZVQwaWMyRnVjeTF6WlhKcFppSWdZMnh2Y2owaUkyWm1abVptWmlJZ1ptOXVkQzF6YVhwbFBTSXhPVGRKVWlJK1F6d3ZkR1Y0ZEQ0OEwzTjJaejQ9IiwKICAgICAgInNpemVzIjogIjEwMHgxMDAiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjNjY3ZWVhIj4KPHJlY3QgeD0iMTAiIHk9IjEwIiB3aWR0aD0iODAiIGhlaWdodD0iODAiIHJ4PSI0IiBmaWxsPSIjZDA5NjIzIi8+Cjx0ZXh0IHg9IjUwIiB5PSIzNSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGNvbG9yPSIjZmZmZmZmIiBmb250LXNpemU9IjE5cHgiPkc8L3RleHQ+CjwvbW9yPgo+">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            height: 70px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #4a5568;
            text-decoration: none;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 40px;
            align-items: center;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            text-decoration: none;
            color: #4a5568;
            font-weight: 500;
            font-size: 15px;
            padding: 10px 0;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .nav-link:hover {
            color: #667eea;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 0;
            width: 0;
            height: 2px;
            background: #667eea;
            transition: width 0.3s ease;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .nav-link.active {
            color: #667eea;
        }

        .nav-link.active::after {
            width: 100%;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: #4a5568;
            cursor: pointer;
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .section {
            display: none;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.5s ease-out;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-separator {
            height: 3px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50px;
            margin: 40px 0;
            position: relative;
        }

        .section-separator::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            border: 3px solid #667eea;
        }

        .alerts-section {
            margin-bottom: 30px;
        }

        .lists-section {
            margin-bottom: 40px;
        }

        .forms-section {
            margin-top: 40px;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input, .form-select {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-select {
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
            transform: translateY(-2px);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            font-size: 13px;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
        }

        .data-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-inactive {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-pending {
            background: #fef5e7;
            color: #744210;
        }

        .status-urgent {
            background: #fbb6ce;
            color: #97266d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .address-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .client-type-container {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .revizie-container {
            background: #e6fffa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #38b2ac;
        }

        .servicii-container {
            background: #faf5ff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #9f7aea;
        }

        .form-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #667eea;
        }

        .oferta-speciala {
            background: linear-gradient(135deg, #fef5e7, #fed7aa);
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #f6ad55;
            animation: pulse-offer 3s infinite;
        }

        .oferta-speciala label {
            color: #c05621 !important;
            font-size: 15px;
        }

        .file-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f7fafc;
            transition: all 0.3s ease;
            margin-top: 15px;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .file-upload-area.dragover {
            border-color: #667eea;
            background: #e6fffa;
        }

        .file-list {
            margin-top: 15px;
        }

        .file-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            font-size: 20px;
        }

        .file-details {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: 600;
            color: #2d3748;
        }

        .file-size {
            font-size: 12px;
            color: #718096;
        }

        .date-range-container {
            background: #fff5f5;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #f56565;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #2d3748;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-warning {
            background: #fef5e7;
            color: #744210;
            border-left: 4px solid #ed8936;
        }

        .alert-danger {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        .alert-info {
            background: #ebf8ff;
            color: #2a4365;
            border-left: 4px solid #4299e1;
        }

        .alert-success {
            background: #f0fff4;
            color: #22543d;
            border-left: 4px solid #38a169;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .nav-menu {
                position: fixed;
                top: 70px;
                left: -100%;
                width: 100%;
                height: calc(100vh - 70px);
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                flex-direction: column;
                justify-content: flex-start;
                padding-top: 50px;
                gap: 30px;
                transition: left 0.3s ease;
            }

            .nav-menu.active {
                left: 0;
            }

            .nav-link {
                font-size: 18px;
                padding: 15px 0;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .address-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                font-size: 11px;
            }

            .data-table th,
            .data-table td {
                padding: 6px 4px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification {
            position: fixed;
            top: 90px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #48bb78;
        }

        .notification.error {
            background: #f56565;
        }

        .notification.warning {
            background: #ed8936;
        }

        .notification.info {
            background: #4299e1;
        }

        .urgent-reminder {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes pulse-offer {
            0%, 100% { box-shadow: 0 0 0 0 rgba(246, 173, 85, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(246, 173, 85, 0); }
        }

        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sync-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="nav-container">
            <a href="#" class="logo">🔧 GazTech Services</a>
            
            <nav>
                <ul class="nav-menu" id="navMenu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-section="dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="abonati">Abonați</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="programari">Programări</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="remindere">Remindere</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="rapoarte">Rapoarte</a>
                    </li>
                </ul>
            </nav>

            <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>
        </div>
    </header>

    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <h1 class="section-title">📊 Dashboard</h1>
            
            <div class="alerts-section">
                <div id="alerteUrgente"></div>
            </div>
            
            <div class="form-grid">
                <div class="form-container">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">📈 Statistici Rapide</h3>
                    <p style="color: #718096;">Total Abonați: <strong id="totalAbonati">0</strong></p>
                    <p style="color: #718096;">Programări Astăzi: <strong id="programariAstazi">0</strong></p>
                    <p style="color: #718096;">Remindere Active: <strong id="remindereActive">0</strong></p>
                    <p style="color: #718096;">Revizii în 7 zile: <strong id="reviziiSaptamana">0</strong></p>
                </div>
                <div class="form-container">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">⚡ Acțiuni Rapide</h3>
                    <button class="btn btn-primary" onclick="showSection('abonati')" style="margin-bottom: 10px; width: 100%;">Adaugă Abonat</button>
                    <button class="btn btn-secondary" onclick="showSection('programari')" style="margin-bottom: 10px; width: 100%;">Programare Nouă</button>
                    <button class="btn btn-secondary" onclick="sincronizareAvansata()" style="margin-bottom: 10px; width: 100%;">🔄 Sincronizare Avansată</button>
                    <button class="btn btn-secondary" onclick="creeazaBackup()" style="width: 100%;">💾 Backup Date</button>
                </div>
                <div class="form-container">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">📱 Notificări & Firebase</h3>
                    <button class="btn btn-primary" onclick="verificaNotificariAutomated()" style="margin-bottom: 10px; width: 100%;">📱 Verifică Notificări</button>
                    <button class="btn btn-secondary" onclick="sincronizareCuFirestore()" style="margin-bottom: 10px; width: 100%;">🔥 Sync Firebase</button>
                    <button class="btn btn-secondary" onclick="trimiteNotificariInMasa()" style="margin-bottom: 10px; width: 100%;">📢 Notificări în Masă</button>
                    <button class="btn btn-success" onclick="testeazaWhatsApp()" style="margin-bottom: 10px; width: 100%; background: #25d366; color: white;">💬 Test WhatsApp</button>
                    <div style="margin-top: 10px; padding: 10px; background: #f0fff4; border-radius: 6px; border-left: 3px solid #38a169;">
                        <small style="color: #22543d;">Firebase: <span id="firebaseStatus">Verificare...</span></small><br>
                        <small style="color: #22543d;">Telefon firmă: <strong id="telefonFirma">0762614402</strong></small><br>
                        <small style="color: #22543d;">WhatsApp: <strong>Activ ✅</strong></small>
                    </div>
                </div>
            </div>

            <!-- Secțiune pentru preview mesaje -->
            <div class="form-container" style="margin-top: 30px;">
                <h3 style="color: #4a5568; margin-bottom: 15px;">📋 Exemple Mesaje SMS & WhatsApp</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #4299e1;">
                        <h4 style="color: #2b6cb0; margin-bottom: 10px;">🔔 Expirare Revizie</h4>
                        <div style="background: white; padding: 10px; border-radius: 6px; font-size: 13px; color: #4a5568; white-space: pre-line;">${messageTemplates.expirareRevizie('Popescu Ion', '7', 'Verificare Instalație Gaz')}</div>
                    </div>
                    <div style="background: #fef5e7; padding: 15px; border-radius: 8px; border-left: 4px solid #ed8936;">
                        <h4 style="color: #c05621; margin-bottom: 10px;">💰 Plată Pendentă</h4>
                        <div style="background: white; padding: 10px; border-radius: 6px; font-size: 13px; color: #4a5568; white-space: pre-line;">${messageTemplates.plataPendenta('Ionescu Maria', '250', 'Revizie Instalație Gaz')}</div>
                    </div>
                    <div style="background: #f0fff4; padding: 15px; border-radius: 8px; border-left: 4px solid #38a169;">
                        <h4 style="color: #22543d; margin-bottom: 10px;">✅ Confirmare Programare</h4>
                        <div style="background: white; padding: 10px; border-radius: 6px; font-size: 13px; color: #4a5568; white-space: pre-line;">${messageTemplates.confirmareProgramare('Georgescu Andrei', '15.12.2024 10:00', 'Verificare Centrală', 'Alexandria, Str. Libertății 12')}</div>
                    </div>
                    <div style="background: #fed7d7; padding: 15px; border-radius: 8px; border-left: 4px solid #f56565;">
                        <h4 style="color: #742a2a; margin-bottom: 10px;">🚨 Problemă Tehnică (WhatsApp)</h4>
                        <div style="background: white; padding: 10px; border-radius: 6px; font-size: 13px; color: #4a5568; white-space: pre-line;">🚨 ATENȚIE - ${CONFIGURARI_FIRMA.nume}

Bună ziua Popescu Ion!

Am fost notificați despre următoarea problemă:
⚠️ Scăpare de gaz

🔧 Vă rugăm să:
• Nu folosiți instalația până la verificare
• Aerisiți încăperea
• Sunați URGENT la ${CONFIGURARI_FIRMA.telefon}

${CONFIGURARI_FIRMA.nume} - Intervenție Rapidă</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #ebf8ff; border-radius: 8px; border-left: 4px solid #4299e1;">
                    <p style="color: #2a4365; margin: 0;"><strong>🎯 Cum funcționează:</strong></p>
                    <p style="color: #2a4365; margin: 5px 0 0 0;">• <strong>📱 SMS</strong> → mesaj simulat (vezi în consolă F12)</p>
                    <p style="color: #2a4365; margin: 5px 0 0 0;">• <strong>💬 WhatsApp</strong> → deschide WhatsApp Web cu mesajul pregătit</p>
                    <p style="color: #2a4365; margin: 5px 0 0 0;">• <strong>Probleme urgente</strong> → trimite automat pe WhatsApp</p>
                    <p style="color: #2a4365; margin: 5px 0 0 0;">• <strong>Test WhatsApp</strong> → butonul "💬 Test WhatsApp" în dashboard</p>
                </div>
            </div>
        </section>

        <!-- Abonați Section -->
        <section id="abonati" class="section">
            <h1 class="section-title">👥 Gestionare Abonați</h1>
            
            <!-- Alerts Section -->
            <div class="alerts-section">
                <div id="alerteAbonati"></div>
                
                <!-- Alertă pentru notificări -->
                <div class="alert alert-info" style="border-left: 4px solid #4299e1;">
                    <strong>📱 Notificări Profesionale Active!</strong><br>
                    • <strong>📱 SMS:</strong> Click pe 📱 SMS pentru notificări expirări/plăți<br>
                    • <strong>💬 WhatsApp:</strong> Click pe 💬 WA pentru mesaje business instant<br>
                    • <strong>🚨 Automat:</strong> WhatsApp pentru revizii expirate (urgent)<br>
                    • <strong>Telefon firmă:</strong> <span id="telefonAlert1">0762614402</span> (în toate mesajele)
                </div>
            </div>

            <!-- Lists Section -->
            <div class="lists-section">
                <div class="search-container">
                    <input type="text" class="search-input" id="searchAbonati" placeholder="🔍 Caută abonați...">
                </div>

                <div id="listaAbonati">
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <h3>Nu există abonați înregistrați</h3>
                        <p>Adaugă primul abonat folosind formularul de mai jos.</p>
                    </div>
                </div>
            </div>

            <!-- Separator -->
            <div class="section-separator"></div>

            <!-- Forms Section -->
            <div class="forms-section">
                <div class="form-container">
                    <h3 style="color: #4a5568; margin-bottom: 20px;">➕ Adaugă Abonat Nou</h3>
                    
                    <div class="client-type-container">
                        <div class="form-section-title">👤 Tip Client</div>
                        <div class="form-group">
                            <select class="form-select" id="tipClient">
                                <option value="">Selectează tipul clientului</option>
                                <option value="nou">Client Nou</option>
                                <option value="actual">Client Actual</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-section-title">📝 Date Personale</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nume Complet *</label>
                            <input type="text" class="form-input" id="numeAbonat" placeholder="Introduceți numele complet" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefon *</label>
                            <input type="tel" class="form-input" id="telefonAbonat" placeholder="0721234567" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="emailAbonat" placeholder="email@exemplu.ro">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CNP</label>
                            <input type="text" class="form-input" id="cnpAbonat" placeholder="1234567890123">
                        </div>
                    </div>

                    <div class="form-section-title">📍 Adresă Completă</div>
                    <div class="address-grid">
                        <div class="form-group">
                            <label class="form-label">Oraș *</label>
                            <select class="form-select" id="orasAbonat" required>
                                <option value="">Selectează orașul</option>
                                <option value="Roșiorii de Vede">Roșiorii de Vede</option>
                                <option value="Alexandria">Alexandria</option>
                                <option value="Turnu Măgurele">Turnu Măgurele</option>
                                <option value="Videle">Videle</option>
                                <option value="Zimnicea">Zimnicea</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Strada</label>
                            <input type="text" class="form-input" id="stradaAbonat" placeholder="Str. Exemplu">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numărul</label>
                            <input type="text" class="form-input" id="numarAbonat" placeholder="Nr. 123">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tip Locuință</label>
                            <select class="form-select" id="tipAdresa">
                                <option value="">Selectează tipul</option>
                                <option value="Casa">Casă</option>
                                <option value="Bloc">Bloc</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bloc (ex: Bl. 413, K1)</label>
                            <input type="text" class="form-input" id="numeBlocAbonat" placeholder="Bl. 413, K1, etc.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Scara</label>
                            <input type="text" class="form-input" id="scaraAbonat" placeholder="A, B, C...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Etaj</label>
                            <input type="text" class="form-input" id="etajAbonat" placeholder="1, 2, 3...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Apartament</label>
                            <input type="text" class="form-input" id="apartamentAbonat" placeholder="12, 34...">
                        </div>
                    </div>

                    <div class="servicii-container">
                        <div class="form-section-title">🛠️ Servicii Contractate cu Prețuri</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="serviciu_verificare_gaz" value="Verificare Instalație Gaz">
                                <label for="serviciu_verificare_gaz">Verificare Instalație Gaz - <strong>150 Lei</strong> <small>(valabilitate 2 ani)</small></label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="serviciu_revizie_gaz" value="Revizie Instalație Gaz">
                                <label for="serviciu_revizie_gaz">Revizie Instalație Gaz - <strong>250 Lei</strong> <small>(valabilitate 2 ani)</small></label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="serviciu_verificare_centrala" value="Verificare Centrală">
                                <label for="serviciu_verificare_centrala">Verificare Centrală - <strong>150 Lei</strong> <small>(valabilitate 2 ani)</small></label>
                            </div>
                            <div class="checkbox-item oferta-speciala">
                                <input type="checkbox" id="serviciu_pachet_complet" value="Instalații Gaz + Centrală">
                                <label for="serviciu_pachet_complet"><strong>🔥 OFERTĂ: Instalații Gaz + Centrală - 250 Lei</strong> <small>(valabilitate 2 ani)</small></label>
                            </div>
                        </div>
                        <div style="background: #e6fffa; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #38b2ac;">
                            <p style="color: #2c7a7b; font-weight: 600; margin: 0;">ℹ️ Toate serviciile au valabilitate de 2 ani și se programează automat următoarea verificare!</p>
                            <div id="costTotal" style="margin-top: 10px; font-size: 18px; font-weight: bold; color: #2c7a7b;">
                                💰 Cost total: <span id="valoareTotala">0</span> Lei
                            </div>
                        </div>
                    </div>

                    <div class="date-range-container">
                        <div class="form-section-title">📅 Date Importante Revizie</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Data Revizie Efectuată</label>
                                <input type="date" class="form-input" id="dataRevizieEfectuata">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data Expirare (calculată automat)</label>
                                <input type="date" class="form-input" id="dataExpirare" readonly style="background: #f7fafc;">
                            </div>
                        </div>
                    </div>

                    <div class="revizie-container">
                        <div class="form-section-title">🔍 Sistem Revizii Automate</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Data Primei Revizii/Verificări</label>
                                <input type="date" class="form-input" id="dataPrimaRevizie">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Periodicitate Revizie (legal)</label>
                                <select class="form-select" id="periodicitateRevizie">
                                    <option value="2" selected>2 ani (obligatoriu legal pentru instalațiile de gaz)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Zile Notificare Înainte</label>
                                <select class="form-select" id="zileNotificare">
                                    <option value="1">1 zi înainte</option>
                                    <option value="2" selected>2 zile înainte</option>
                                    <option value="3">3 zile înainte</option>
                                    <option value="7">1 săptămână înainte</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data Următoarei Revizii</label>
                                <input type="date" class="form-input" id="dataUrmatoareaRevizie" readonly style="background: #f7fafc;">
                            </div>
                        </div>
                    </div>

                    <div class="form-container">
                        <div class="form-section-title">📎 Gestionare Documente</div>
                        <div class="file-upload-area" id="fileUploadArea">
                            <div style="font-size: 48px; color: #cbd5e0; margin-bottom: 15px;">📄</div>
                            <p style="color: #4a5568; font-weight: 600; margin-bottom: 10px;">Încarcă documente pentru client</p>
                            <p style="color: #718096; font-size: 14px;">Drag & drop sau click pentru a selecta fișiere</p>
                            <p style="color: #a0aec0; font-size: 12px;">PDF, DOC, DOCX, JPG, PNG (max 5MB per fișier)</p>
                            <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;">
                        </div>
                        <div class="file-list" id="fileList"></div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="adaugaAbonat()">
                            ➕ Adaugă Abonat
                        </button>
                        <button class="btn btn-secondary" onclick="resetFormAbonat()">
                            🔄 Resetează Formularul
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Programări Section -->
        <section id="programari" class="section">
            <h1 class="section-title">📅 Gestionare Programări</h1>
            
            <!-- Alerts Section -->
            <div class="alerts-section">
                <div id="alerteProgramari"></div>
            </div>

            <!-- Lists Section -->
            <div class="lists-section">
                <div id="listaProgramari">
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <h3>Nu există programări</h3>
                        <p>Adaugă prima programare folosind formularul de mai jos.</p>
                    </div>
                </div>
            </div>

            <!-- Separator -->
            <div class="section-separator"></div>

            <!-- Forms Section -->
            <div class="forms-section">
                <div class="form-container">
                    <h3 style="color: #4a5568; margin-bottom: 20px;">➕ Programare Nouă</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Client</label>
                            <select class="form-select" id="clientProgramare">
                                <option value="">Selectează clientul</option>
                                <option value="nou">➕ Client Nou</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tip Serviciu</label>
                            <select class="form-select" id="tipServiciu">
                                <option value="">Selectează serviciul</option>
                                <option value="Verificare Instalație Gaz">Verificare Instalație Gaz - 150 Lei</option>
                                <option value="Revizie Instalație Gaz">Revizie Instalație Gaz - 250 Lei</option>
                                <option value="Verificare Centrală">Verificare Centrală - 150 Lei</option>
                                <option value="Instalații Gaz + Centrală">🔥 OFERTĂ: Instalații Gaz + Centrală - 250 Lei</option>
                                <option value="Reparație">Reparație</option>
                                <option value="Consultanță">Consultanță</option>
                                <option value="Urgență">Urgență</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data Programării</label>
                            <input type="datetime-local" class="form-input" id="dataProgramare">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="statusProgramare">
                                <option value="Programată">📅 Programată</option>
                                <option value="În Progres">⚡ În Progres</option>
                                <option value="Finalizată">✅ Finalizată</option>
                                <option value="Anulată">❌ Anulată</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Observații</label>
                        <textarea class="form-input" id="observatiiProgramare" rows="3" placeholder="Detalii despre programare..."></textarea>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="adaugaProgramare()">
                            📅 Adaugă Programare
                        </button>
                        <button class="btn btn-secondary" onclick="resetFormProgramare()">
                            🔄 Resetează
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Remindere Section -->
        <section id="remindere" class="section">
            <h1 class="section-title">🔔 Gestionare Remindere</h1>
            
            <!-- Alerts Section -->
            <div class="alerts-section">
                <div id="alerteRemindere"></div>
                
                <!-- Alertă pentru remindere -->
                <div class="alert alert-success" style="border-left: 4px solid #38a169;">
                    <strong>📋 Sistem Remindere Profesional!</strong><br>
                    • <strong>Expirări:</strong> Urmărire verificări și revizii care expiră<br>
                    • <strong>Plăți:</strong> Remindere pentru facturi și plăți pendente<br>
                    • <strong>WhatsApp automat:</strong> Mesaje pentru revizii expirate (urgent)<br>
                    • <strong>Dropdown:</strong> 12 tipuri de detalii pentru remindere complete
                </div>
            </div>

            <!-- Lists Section -->
            <div class="lists-section">
                <div id="listaRemindere">
                    <div class="empty-state">
                        <div class="empty-state-icon">🔔</div>
                        <h3>Nu există remindere</h3>
                        <p>Adaugă primul reminder folosind formularul de mai jos.</p>
                    </div>
                </div>
            </div>

            <!-- Separator -->
            <div class="section-separator"></div>

            <!-- Forms Section -->
            <div class="forms-section">
                <div class="form-container">
                    <h3 style="color: #4a5568; margin-bottom: 20px;">➕ Reminder Nou</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Client</label>
                            <select class="form-select" id="clientReminder">
                                <option value="">Selectează clientul</option>
                                <option value="nou">➕ Client Nou</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tip Reminder</label>
                            <select class="form-select" id="tipReminder">
                                <option value="">Selectează tipul</option>
                                <option value="Verificare Instalație Gaz">🔍 Verificare Instalație Gaz - Expirare</option>
                                <option value="Revizie Instalație Gaz">🔧 Revizie Instalație Gaz - Expirare</option>
                                <option value="Verificare Centrală">🏠 Verificare Centrală - Expirare</option>
                                <option value="Instalații Gaz + Centrală">🔥 Pachet Complet - Expirare</option>
                                <option value="Urmărire Plată">📞 Urmărire Plată</option>
                                <option value="Facturare">💰 Facturare</option>
                                <option value="Reprogramare">📅 Reprogramare Necesară</option>
                                <option value="Documentație">📄 Documentație Lipsă</option>
                                <option value="Confirmare">✅ Confirmare Serviciu</option>
                                <option value="Altele">📝 Altele</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Detalii Reminder</label>
                            <select class="form-select" id="problemaSpecifica">
                                <option value="">Selectează detaliile</option>
                                <option value="Expirare în 30 zile">⏰ Expirare în 30 zile</option>
                                <option value="Expirare în 7 zile">🔴 Expirare în 7 zile</option>
                                <option value="Expirat - Reprogramare urgentă">🚨 Expirat - Reprogramare urgentă</option>
                                <option value="Factură neplătită">💳 Factură neplătită</option>
                                <option value="Plată parțială">💰 Plată parțială</option>
                                <option value="Programare amânată">📅 Programare amânată</option>
                                <option value="Documente incomplete">📄 Documente incomplete</option>
                                <option value="Confirmare necesară">✅ Confirmare necesară</option>
                                <option value="Client nou - urmărire">👤 Client nou - urmărire</option>
                                <option value="Feedback serviciu">⭐ Feedback serviciu</option>
                                <option value="Contact telefonic">📞 Contact telefonic</option>
                                <option value="Altele">❓ Altele</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data Reminder</label>
                            <input type="datetime-local" class="form-input" id="dataReminder">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prioritate</label>
                            <select class="form-select" id="prioritateReminder">
                                <option value="Joasă">🟢 Joasă</option>
                                <option value="Medie">🟡 Medie</option>
                                <option value="Înaltă">🔴 Înaltă</option>
                                <option value="Urgentă">🚨 Urgentă</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Mesaj Reminder</label>
                        <textarea class="form-input" id="mesajReminder" rows="3" placeholder="Descrierea reminder-ului..."></textarea>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="adaugaReminder()">
                            🔔 Adaugă Reminder
                        </button>
                        <button class="btn btn-secondary" onclick="resetFormReminder()">
                            🔄 Resetează
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Rapoarte Section -->
        <section id="rapoarte" class="section">
            <h1 class="section-title">📊 Rapoarte și Statistici</h1>
            
            <div class="form-grid">
                <div class="form-container">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">📈 Rezumat General</h3>
                    <p style="color: #718096;">Total Abonați: <strong id="raportTotalAbonati">0</strong></p>
                    <p style="color: #718096;">Programări Luna Aceasta: <strong id="raportProgramari">0</strong></p>
                    <p style="color: #718096;">Remindere Pending: <strong id="raportRemindere">0</strong></p>
                    <p style="color: #718096;">Revizii Următoarea Lună: <strong id="raportRevizii">0</strong></p>
                </div>
                <div class="form-container">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">🏙️ Distribuție pe Orașe</h3>
                    <div id="distributieOrase">
                        <p style="color: #718096;">Nu există date disponibile</p>
                    </div>
                </div>
            </div>

            <div class="form-container">
                <h3 style="color: #4a5568; margin-bottom: 15px;">🛠️ Servicii Contractate</h3>
                <div id="distributieServicii">
                    <p style="color: #718096;">Nu există date disponibile</p>
                </div>
            </div>

            <div class="form-container">
                <h3 style="color: #4a5568; margin-bottom: 20px;">📋 Export Rapoarte Complete</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="exportRaportPDF()">📄 Raport PDF Complet</button>
                    <button class="btn btn-primary" onclick="exportRaportExcel()">📊 Raport Excel Detaliat</button>
                    <button class="btn btn-secondary" onclick="exportAbonati()">📥 Export Abonați CSV</button>
                    <button class="btn btn-secondary" onclick="exportProgramari()">📥 Export Programări CSV</button>
                    <button class="btn btn-secondary" onclick="exportRemindere()">📥 Export Remindere CSV</button>
                    <button class="btn btn-secondary" onclick="exportRevizii()">📥 Export Revizii CSV</button>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding-top: 15px; border-top: 2px solid #e2e8f0;">
                    <button class="btn btn-primary" onclick="sincronizareAvansata()">🔄 Sincronizare Completă</button>
                    <button class="btn btn-secondary" onclick="creeazaBackup()">💾 Backup Date Complete</button>
                    <button class="btn btn-secondary" onclick="verificaConsistentaDatele(); showNotification('Verificare completă!', 'info')">🔍 Verifică Consistența</button>
                    <button class="btn btn-secondary" onclick="adaugaDateDeTest(); sincronizeazaDatele()">🧪 Reîncarcă Date Test</button>
                </div>
                
                <div style="background: #edf2f7; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #4a5568; margin-bottom: 10px;">📈 Statistici Raport:</h4>
                    <p style="color: #718096;">• PDF: Include toate datele, grafice și documente</p>
                    <p style="color: #718096;">• Excel: Fișier cu multiple foi pentru fiecare secțiune</p>
                    <p style="color: #718096;">• CSV: Format simplu pentru import în alte sisteme</p>
                    <p style="color: #38a169; font-weight: 600;">• Sincronizare: Actualizare automată la fiecare 30 secunde</p>
                    <p style="color: #38a169; font-weight: 600;">• Backup: Salvare completă a tuturor datelor în format JSON</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal pentru Gestionare Documente -->
    <div id="modalDocumente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📎 Documente Client</h2>
                <button class="close-modal" onclick="inchideModalDocumente()">&times;</button>
            </div>
            <div id="continutModalDocumente">
                <!-- Conținutul se va încărca dinamic -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Sync Indicator -->
    <div id="syncIndicator" class="sync-indicator">
        ✓ Sincronizat
    </div>

    <script>
        // ===========================================
        // FIREBASE CONFIGURATION & NOTIFICATIONS
        // ===========================================
        
        // Configurare Firebase
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "adinstalgaz-pwa.firebaseapp.com",
            projectId: "adinstalgaz-pwa",
            storageBucket: "adinstalgaz-pwa.appspot.com",
            messagingSenderId: "your-sender-id",
            appId: "your-app-id"
        };

        // Inițializează Firebase
        let db, functions;
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                functions = firebase.functions();
                console.log('✅ Firebase inițializat cu succes!');
            }
        } catch (error) {
            console.warn('⚠️ Firebase nu este disponibil:', error.message);
            console.log('📱 Aplicația va funcționa în modul offline');
        }

        // ===========================================
        // SISTEM NOTIFICĂRI AUTOMATE
        // ===========================================

        // ===========================================
        // CONFIGURĂRI FIRMĂ
        // ===========================================
        
        const CONFIGURARI_FIRMA = {
            nume: 'GazTech Services',
            telefon: '0762614402', // NUMĂRUL FIRMEI
            email: 'contact@gaztech.ro',
            adresa: 'Alexandria, Teleorman',
            website: 'www.gaztech.ro'
        };

        // Template-uri de mesaje
        const messageTemplates = {
            expirareRevizie: (nume, zile, servicii) => 
                `🔔 Bună ziua ${nume}!\n\n` +
                `Revizia dumneavoastră pentru ${servicii} expiră în ${zile} zile.\n\n` +
                `Pentru reprogramare, sunați la 📞 ${CONFIGURARI_FIRMA.telefon}\n\n` +
                `${CONFIGURARI_FIRMA.nume} - Servicii profesionale de instalații gaz`,

            plataPendenta: (nume, suma, servicii) => 
                `💰 Bună ziua ${nume}!\n\n` +
                `Aveți de plătit suma de ${suma} Lei pentru:\n${servicii}\n\n` +
                `Pentru plată: 📞 ${CONFIGURARI_FIRMA.telefon}\n\n` +
                `${CONFIGURARI_FIRMA.nume} - Mulțumim!`,

            confirmareProgramare: (nume, data, serviciu, adresa) => 
                `✅ Bună ziua ${nume}!\n\n` +
                `Confirmăm programarea pentru ${serviciu}\n` +
                `📅 Data: ${data}\n📍 Adresa: ${adresa}\n\n` +
                `Informații: 📞 ${CONFIGURARI_FIRMA.telefon}\n` +
                `${CONFIGURARI_FIRMA.nume}`,

            revizieCompletata: (nume, serviciu, valabilitate) => 
                `✅ Bună ziua ${nume}!\n\n` +
                `Revizia pentru ${serviciu} a fost finalizată cu succes!\n` +
                `📋 Valabilitate: ${valabilitate}\n\n` +
                `${CONFIGURARI_FIRMA.nume} - Mulțumim pentru încredere!\n` +
                `📞 ${CONFIGURARI_FIRMA.telefon}`,

            abonatNou: (nume, servicii) =>
                `✅ Bună ziua ${nume}!\n\n` +
                `Vă confirmăm înregistrarea în sistemul ${CONFIGURARI_FIRMA.nume}.\n` +
                `📋 Servicii contractate: ${servicii}\n\n` +
                `Pentru informații: 📞 ${CONFIGURARI_FIRMA.telefon}\n` +
                `${CONFIGURARI_FIRMA.nume} - Mulțumim pentru încredere!`,

            reminderGeneral: (nume, serviciu, zile) =>
                `🔔 Reminder ${CONFIGURARI_FIRMA.nume}\n\n` +
                `Bună ziua ${nume}!\n` +
                `${serviciu} programat în ${zile} zile.\n\n` +
                `Contact: 📞 ${CONFIGURARI_FIRMA.telefon}`
        };

        // Funcție pentru trimitere SMS (simulare)
        async function trimiteNotificare(telefon, mesaj, tip = 'SMS') {
            try {
                if (db && functions) {
                    // Trimite prin Firebase Functions
                    const sendNotification = functions.httpsCallable('sendNotification');
                    const result = await sendNotification({
                        phone: telefon,
                        message: mesaj,
                        type: tip
                    });
                    
                    console.log(`📱 ${tip} trimis cu succes:`, result.data);
                    return { success: true, result: result.data };
                } else {
                    // Simulare pentru demo
                    console.log(`📱 SIMULARE ${tip} către ${telefon}:`);
                    console.log(mesaj);
                    
                    showNotification(`📱 ${tip} trimis către ${telefon}`, 'success');
                    return { success: true, simulated: true };
                }
            } catch (error) {
                console.error(`❌ Eroare trimitere ${tip}:`, error);
                showNotification(`❌ Eroare trimitere ${tip}: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // FUNCȚIE NOUĂ PENTRU WHATSAPP
        function trimiteWhatsApp(telefon, mesaj) {
            // Curăță numărul de telefon (elimină 0 și adaugă +40)
            const telefonCurat = telefon.replace(/^0/, '+40').replace(/\s+/g, '');
            
            // Encode mesajul pentru URL
            const mesajEncoded = encodeURIComponent(mesaj);
            
            // Creează link-ul WhatsApp
            const linkWhatsApp = `https://wa.me/${telefonCurat}?text=${mesajEncoded}`;
            
            // Deschide WhatsApp în tab nou
            window.open(linkWhatsApp, '_blank');
            
            console.log(`📱 WHATSAPP către ${telefon}:`);
            console.log('='.repeat(50));
            console.log(mesaj);
            console.log('='.repeat(50));
            console.log(`🔗 Link: ${linkWhatsApp}`);
            
            showNotification(`📱 WhatsApp deschis pentru ${telefon}`, 'success');
            return { success: true, whatsappLink: linkWhatsApp };
        }

        // Funcție pentru notificare expirare revizie
        async function notificaExpirareRevizie(abonat) {
            const servicii = abonat.serviciiContractate ? abonat.serviciiContractate.join(', ') : 'servicii contractate';
            const dataExpirare = new Date(abonat.dataExpirare);
            const astazi = new Date();
            const zileRamase = Math.ceil((dataExpirare - astazi) / (1000 * 60 * 60 * 24));
            
            const mesaj = messageTemplates.expirareRevizie(
                abonat.nume,
                zileRamase,
                servicii
            );
            
            // Afișează mesajul în consolă pentru demonstrație
            console.log('📱 MESAJ TRIMIS:');
            console.log('='.repeat(50));
            console.log(mesaj);
            console.log('='.repeat(50));
            
            return await trimiteNotificare(abonat.telefon, mesaj, 'SMS');
        }

        // Funcție pentru notificare plată pendentă
        async function notificaPlata(abonat) {
            let costTotal = 0;
            if (abonat.serviciiContractate) {
                abonat.serviciiContractate.forEach(serviciu => {
                    switch(serviciu) {
                        case 'Verificare Instalație Gaz': costTotal += 150; break;
                        case 'Revizie Instalație Gaz': costTotal += 250; break;
                        case 'Verificare Centrală': costTotal += 150; break;
                        case 'Instalații Gaz + Centrală': costTotal += 250; break;
                    }
                });
            }
            
            const servicii = abonat.serviciiContractate ? abonat.serviciiContractate.join(', ') : 'servicii contractate';
            const mesaj = messageTemplates.plataPendenta(abonat.nume, costTotal, servicii);
            
            console.log('📱 MESAJ PLATĂ TRIMIS:');
            console.log('='.repeat(50));
            console.log(mesaj);
            console.log('='.repeat(50));
            
            return await trimiteNotificare(abonat.telefon, mesaj, 'SMS');
        }

        // Funcție pentru confirmare programare
        async function confirmareProgramare(programare) {
            const abonat = abonati.find(a => a.id == programare.clientId);
            if (!abonat) return;
            
            const data = new Date(programare.data).toLocaleString('ro-RO');
            const adresa = formatareAdresa(abonat.adresa);
            
            const mesaj = messageTemplates.confirmareProgramare(
                abonat.nume,
                data,
                programare.tipServiciu,
                adresa
            );
            
            console.log('📱 CONFIRMARE PROGRAMARE:');
            console.log('='.repeat(50));
            console.log(mesaj);
            console.log('='.repeat(50));
            
            return await trimiteNotificare(abonat.telefon, mesaj, 'SMS');
        }

        // ===========================================
        // FIREBASE FIRESTORE SYNC
        // ===========================================

        // Salvare în Firestore
        async function salveazaInFirestore(colectie, id, data) {
            if (!db) {
                console.log('📱 Firestore nu este disponibil - date salvate local');
                return false;
            }
            
            try {
                await db.collection(colectie).doc(id.toString()).set({
                    ...data,
                    lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                    source: 'gaztech-web-app'
                });
                
                console.log(`✅ ${colectie}/${id} salvat în Firestore`);
                return true;
            } catch (error) {
                console.error(`❌ Eroare salvare ${colectie}:`, error);
                return false;
            }
        }

        // Încărcare din Firestore
        async function incarcaDinFirestore(colectie) {
            if (!db) return [];
            
            try {
                const snapshot = await db.collection(colectie).get();
                const data = [];
                
                snapshot.forEach(doc => {
                    data.push({
                        id: parseInt(doc.id) || doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`✅ ${data.length} înregistrări încărcate din ${colectie}`);
                return data;
            } catch (error) {
                console.error(`❌ Eroare încărcare ${colectie}:`, error);
                return [];
            }
        }

        // Sincronizare completă cu Firestore
        async function sincronizareCuFirestore() {
            if (!db) {
                showNotification('📱 Firestore nu este disponibil', 'warning');
                return;
            }
            
            try {
                showNotification('🔄 Sincronizare cu Firebase...', 'info');
                
                // Salvează datele locale în Firestore
                const promiseSalvare = [];
                
                abonati.forEach(abonat => {
                    promiseSalvare.push(salveazaInFirestore('subscribers', abonat.id, abonat));
                });
                
                programari.forEach(programare => {
                    promiseSalvare.push(salveazaInFirestore('appointments', programare.id, programare));
                });
                
                remindere.forEach(reminder => {
                    promiseSalvare.push(salveazaInFirestore('reminders', reminder.id, reminder));
                });
                
                await Promise.all(promiseSalvare);
                
                showNotification('✅ Sincronizare Firebase completă!', 'success');
                showSyncIndicator();
                
            } catch (error) {
                console.error('❌ Eroare sincronizare:', error);
                showNotification('❌ Eroare sincronizare Firebase', 'error');
            }
        }

        // ===========================================
        // VERIFICARE AUTOMATĂ NOTIFICĂRI
        // ===========================================

        function verificaNotificariAutomated() {
            const astazi = new Date();
            
            abonati.forEach(async (abonat) => {
                if (!abonat.dataExpirare) return;
                
                const dataExpirare = new Date(abonat.dataExpirare);
                const zileRamase = Math.ceil((dataExpirare - astazi) / (1000 * 60 * 60 * 24));
                
                // Notificare la 30, 7 și 1 zi înainte de expirare
                if ([30, 7, 1].includes(zileRamase)) {
                    console.log(`📱 Trimite notificare expirare pentru ${abonat.nume} (${zileRamase} zile)`);
                    await notificaExpirareRevizie(abonat);
                    
                    // Marchează notificarea ca trimisă
                    abonat.ultimaNotificare = astazi.toISOString();
                    saveData();
                }
            });
        }

        // Global Variables
        let abonati = JSON.parse(localStorage.getItem('abonati')) || [];
        let programari = JSON.parse(localStorage.getItem('programari')) || [];
        let remindere = JSON.parse(localStorage.getItem('remindere')) || [];
        let documenteTemp = []; // Temporare pentru upload

        // Sync indicator
        function showSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Navigation
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const navMenu = document.getElementById('navMenu');

        mobileMenuBtn.addEventListener('click', () => {
            navMenu.classList.toggle('active');
            mobileMenuBtn.textContent = navMenu.classList.contains('active') ? '✕' : '☰';
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!navMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                navMenu.classList.remove('active');
                mobileMenuBtn.textContent = '☰';
            }
        });

        // Auto-calculate expiration date and next revision date
        document.getElementById('dataPrimaRevizie').addEventListener('change', calculeazaUrmatoareaRevizie);
        document.getElementById('periodicitateRevizie').addEventListener('change', calculeazaUrmatoareaRevizie);
        document.getElementById('dataRevizieEfectuata').addEventListener('change', calculeazaDataExpirare);

        function calculeazaDataExpirare() {
            const dataRevizie = document.getElementById('dataRevizieEfectuata').value;
            
            if (dataRevizie) {
                const data = new Date(dataRevizie);
                data.setFullYear(data.getFullYear() + 2); // Întotdeauna 2 ani pentru conformitatea legală
                
                const dataFormatata = data.toISOString().split('T')[0];
                document.getElementById('dataExpirare').value = dataFormatata;
                
                // Actualizează și următoarea revizie dacă nu este deja setată
                if (!document.getElementById('dataPrimaRevizie').value) {
                    document.getElementById('dataPrimaRevizie').value = dataRevizie;
                    calculeazaUrmatoareaRevizie();
                }
            } else {
                document.getElementById('dataExpirare').value = '';
            }
        }

        function calculeazaUrmatoareaRevizie() {
            const dataPrima = document.getElementById('dataPrimaRevizie').value;
            const periodicitate = document.getElementById('periodicitateRevizie').value;

            if (dataPrima && periodicitate) {
                const data = new Date(dataPrima);
                data.setFullYear(data.getFullYear() + parseInt(periodicitate));
                
                const dataFormatata = data.toISOString().split('T')[0];
                document.getElementById('dataUrmatoareaRevizie').value = dataFormatata;
            } else {
                document.getElementById('dataUrmatoareaRevizie').value = '';
            }
        }

        // Initialize file upload
        function initializeFileUpload() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');
            
            if (!fileUploadArea || !fileInput) return;

            fileUploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showNotification(`Fișierul ${file.name} este prea mare (max 5MB)`, 'error');
                    return;
                }

                const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    showNotification(`Tipul fișierului ${file.name} nu este permis`, 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const documentNou = {
                        id: Date.now() + Math.random(),
                        nume: file.name,
                        tip: file.type,
                        marime: file.size,
                        continut: e.target.result.split(',')[1], // Base64 fără header
                        dataIncarcare: new Date().toISOString()
                    };

                    documenteTemp.push(documentNou);
                    afiseazaListaFisiere();
                    showNotification(`Fișierul ${file.name} a fost încărcat`, 'success');
                };
                reader.readAsDataURL(file);
            });
        }

        function afiseazaListaFisiere() {
            const fileList = document.getElementById('fileList');
            if (!fileList || documenteTemp.length === 0) {
                if (fileList) fileList.innerHTML = '';
                return;
            }

            let html = '<h4 style="color: #4a5568; margin-bottom: 15px;">📄 Fișiere încărcate:</h4>';
            
            documenteTemp.forEach(doc => {
                const marimeMB = (doc.marime / (1024 * 1024)).toFixed(2);
                const iconFisier = getFileIcon(doc.tip);
                
                html += `
                    <div class="file-item">
                        <div class="file-info">
                            <span class="file-icon">${iconFisier}</span>
                            <div class="file-details">
                                <span class="file-name">${doc.nume}</span>
                                <span class="file-size">${marimeMB} MB • ${new Date(doc.dataIncarcare).toLocaleDateString('ro-RO')}</span>
                            </div>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="stergeFisierTemp(${doc.id})" title="Șterge fișier">🗑️</button>
                    </div>
                `;
            });

            fileList.innerHTML = html;
        }

        function getFileIcon(tipFisier) {
            switch(tipFisier) {
                case 'application/pdf': return '📄';
                case 'application/msword':
                case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document': return '📝';
                case 'image/jpeg':
                case 'image/png': return '🖼️';
                default: return '📎';
            }
        }

        function stergeFisierTemp(idFisier) {
            documenteTemp = documenteTemp.filter(doc => doc.id !== idFisier);
            afiseazaListaFisiere();
            showNotification('Fișierul a fost șters', 'success');
        }

        function gestioneazaDocumente(idAbonat) {
            const abonat = abonati.find(a => a.id === idAbonat);
            if (!abonat) return;

            const modal = document.getElementById('modalDocumente');
            const continut = document.getElementById('continutModalDocumente');
            
            let html = `
                <h3 style="color: #4a5568; margin-bottom: 20px;">📎 Documente pentru ${abonat.nume}</h3>
                
                <div class="file-upload-area" onclick="document.getElementById('modalFileInput').click()">
                    <div style="font-size: 48px; color: #cbd5e0; margin-bottom: 15px;">📄</div>
                    <p style="color: #4a5568; font-weight: 600; margin-bottom: 10px;">Adaugă documente noi</p>
                    <p style="color: #718096; font-size: 14px;">Click pentru a selecta fișiere</p>
                    <input type="file" id="modalFileInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;">
                </div>
                
                <div style="margin-top: 30px;">
                    <h4 style="color: #4a5568; margin-bottom: 15px;">📁 Documente existente:</h4>
                    <div id="documenteExistente">
            `;

            if (abonat.documente && abonat.documente.length > 0) {
                abonat.documente.forEach(doc => {
                    const marimeMB = (doc.marime / (1024 * 1024)).toFixed(2);
                    const iconFisier = getFileIcon(doc.tip);
                    
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <span class="file-icon">${iconFisier}</span>
                                <div class="file-details">
                                    <span class="file-name">${doc.nume}</span>
                                    <span class="file-size">${marimeMB} MB • ${new Date(doc.dataIncarcare).toLocaleDateString('ro-RO')}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary btn-small" onclick="descarcaDocument(${abonat.id}, ${doc.id})" title="Descarcă">📥</button>
                                <button class="btn btn-danger btn-small" onclick="stergeDocument(${abonat.id}, ${doc.id})" title="Șterge">🗑️</button>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: #718096; text-align: center; padding: 20px;">Nu există documente încărcate</p>';
            }

            html += `
                    </div>
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="inchideModalDocumente()">Închide</button>
                </div>
            `;

            continut.innerHTML = html;

            // Add event listener for new file uploads
            document.getElementById('modalFileInput').addEventListener('change', (e) => {
                adaugaDocumenteExistente(idAbonat, e.target.files);
            });

            modal.style.display = 'block';
        }

        function adaugaDocumenteExistente(idAbonat, files) {
            const abonat = abonati.find(a => a.id === idAbonat);
            if (!abonat) return;

            if (!abonat.documente) abonat.documente = [];

            Array.from(files).forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(`Fișierul ${file.name} este prea mare (max 5MB)`, 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const documentNou = {
                        id: Date.now() + Math.random(),
                        nume: file.name,
                        tip: file.type,
                        marime: file.size,
                        continut: e.target.result.split(',')[1],
                        dataIncarcare: new Date().toISOString()
                    };

                    abonat.documente.push(documentNou);
                    saveData();
                    showNotification(`Documentul ${file.name} a fost adăugat`, 'success');
                    
                    // Reîmprospătează modalul
                    gestioneazaDocumente(idAbonat);
                    updateListaAbonati();
                    showSyncIndicator();
                };
                reader.readAsDataURL(file);
            });
        }

        function descarcaDocument(idAbonat, idDocument) {
            const abonat = abonati.find(a => a.id === idAbonat);
            if (!abonat || !abonat.documente) return;

            const document = abonat.documente.find(d => d.id === idDocument);
            if (!document) return;

            const link = document.createElement('a');
            link.href = `data:${document.tip};base64,${document.continut}`;
            link.download = document.nume;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification(`Documentul ${document.nume} a fost descărcat`, 'success');
        }

        function stergeDocument(idAbonat, idDocument) {
            if (!confirm('Ești sigur că vrei să ștergi acest document?')) return;

            const abonat = abonati.find(a => a.id === idAbonat);
            if (!abonat || !abonat.documente) return;

            const document = abonat.documente.find(d => d.id === idDocument);
            if (!document) return;

            abonat.documente = abonat.documente.filter(d => d.id !== idDocument);
            saveData();
            showNotification(`Documentul ${document.nume} a fost șters`, 'success');
            
            // Reîmprospătează modalul și lista
            gestioneazaDocumente(idAbonat);
            updateListaAbonati();
            showSyncIndicator();
        }

        function inchideModalDocumente() {
            document.getElementById('modalDocumente').style.display = 'none';
        }

        // Section navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show target section
            document.getElementById(sectionId).classList.add('active');

            // Add active class to corresponding nav link
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');

            // Close mobile menu
            navMenu.classList.remove('active');
            mobileMenuBtn.textContent = '☰';

            // Update data when showing sections - SINCRONIZARE AUTOMATĂ
            sincronizeazaDatele();
            
            if (sectionId === 'dashboard') {
                updateDashboard();
                verificaReminderePendente();
            } else if (sectionId === 'abonati') {
                updateListaAbonati();
                verificaAlerteAbonati();
            } else if (sectionId === 'programari') {
                updateListaProgramari();
                verificaAlerteProgramari();
            } else if (sectionId === 'remindere') {
                updateListaRemindere();
                verificaAlerteRemindere();
            } else if (sectionId === 'rapoarte') {
                updateRapoarte();
            }
        }

        // FUNCȚIE DE SINCRONIZARE CENTRALIZATĂ
        function sincronizeazaDatele() {
            // Actualizează toate dropdown-urile cu abonați
            updateClientDropdowns();
            
            // Actualizează statisticile în toate secțiunile
            updateDashboard();
            updateRapoarte();
            
            // Verifică reminder-urile și alertele
            verificaReminderePendente();
            verificaAlerteAbonati();
            verificaAlerteProgramari();
            verificaAlerteRemindere();
            
            showSyncIndicator();
        }

        // Add event listeners to nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = link.getAttribute('data-section');
                if (sectionId) {
                    showSection(sectionId);
                }
            });
        });

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // FUNCȚII PENTRU NOTIFICĂRI INDIVIDUALE
        async function trimiteNotificareExpirare(idAbonat) {
            const abonat = abonati.find(a => a.id === idAbonat);
            if (!abonat) return;
            
            const rezultat = await notificaExpirareRevizie(abonat);
            if (rezultat.success) {
                // Marchează notificarea ca trimisă
                abonat.ultimaNotificare = new Date().toISOString();
                abonat.numarNotificari = (abonat.numarNotificari || 0) + 1;
                saveData();
                
                // Afișează mesajul și în interfață
                afiseazaMesajInInterfata('SMS Expirare Trimis', 
                    messageTemplates.expirareRevizie(
                        abonat.nume, 
                        Math.ceil((new Date(abonat.dataExpirare) - new Date()) / (1000 * 60 * 60 * 24)),
                        abonat.serviciiContractate ? abonat.serviciiContractate.join(', ') : 'servicii'
                    )
                );
                
                // Sincronizează cu Firebase
                if (db) {
                    await salveazaInFirestore('subscribers', abonat.id, abonat);
                }
                
                updateListaAbonati();
            }
        }

        // FUNCȚIE NOUĂ PENTRU WHATSAPP EXPIRARE
        function trimiteWhatsAppExpirare(idAbonat) {
            const abonat = abonati.find(a => a.id === idAbonat);
            if (!abonat) return;
            
            const servicii = abonat.serviciiContractate ? abonat.serviciiContractate.join(', ') : 'servicii contractate';
            const dataExpirare = new Date(abonat.dataExpirare);
            const astazi = new Date();
            const zileRamase = Math.ceil((dataExpirare - astazi) / (1000 * 60 * 60 * 24));
            
            const mesaj = messageTemplates.expirareRevizie(abonat.nume, zileRamase, servicii);
            
            // Trimite pe WhatsApp
            trimiteWhatsApp(abonat.telefon, mesaj);
            
            // Marchează ca trimis
            abonat.ultimaNotificare = new Date().toISOString();
            abonat.numarNotificari = (abonat.numarNotificari || 0) + 1;
            saveData();
            
            updateListaAbonati();
        }

        // FUNCȚIE PENTRU WHATSAPP EXPIRARE/PLATĂ
        function trimiteWhatsAppReminder(idAbonat, tipReminder, detalii) {
            const abonat = abonati.find(a => a.id === idAbonat);
            if (!abonat) return;
            
            let mesajReminder = '';
            
            // Mesaje pentru expirări
            if (tipReminder.includes('Expirare') || tipReminder.includes('Verificare') || tipReminder.includes('Revizie')) {
                const servicii = abonat.serviciiContractate ? abonat.serviciiContractate.join(', ') : 'serviciile contractate';
                
                if (detalii.includes('Expirat')) {
                    mesajReminder = `🚨 URGENT - ${CONFIGURARI_FIRMA.nume}\n\n` +
                        `Bună ziua ${abonat.nume}!\n\n` +
                        `Verificarea/Revizia pentru ${servicii} a EXPIRAT.\n\n` +
                        `🔧 Pentru reprogramare urgentă:\n` +
                        `📞 Sunați la ${CONFIGURARI_FIRMA.telefon}\n\n` +
                        `Este obligatoriu să refaceți verificarea conform legii!\n\n` +
                        `${CONFIGURARI_FIRMA.nume}`;
                } else {
                    const zileText = detalii.includes('30') ? '30 de zile' : '7 zile';
                    mesajReminder = messageTemplates.expirareRevizie(abonat.nume, zileText, servicii);
                }
            }
            
            // Mesaje pentru plăți
            else if (tipReminder.includes('Plată') || tipReminder.includes('Facturare')) {
                let costTotal = 0;
                if (abonat.serviciiContractate) {
                    abonat.serviciiContractate.forEach(serviciu => {
                        switch(serviciu) {
                            case 'Verificare Instalație Gaz': costTotal += 150; break;
                            case 'Revizie Instalație Gaz': costTotal += 250; break;
                            case 'Verificare Centrală': costTotal += 150; break;
                            case 'Instalații Gaz + Centrală': costTotal += 250; break;
                        }
                    });
                }
                const servicii = abonat.serviciiContractate ? abonat.serviciiContractate.join(', ') : 'serviciile efectuate';
                mesajReminder = messageTemplates.plataPendenta(abonat.nume, costTotal, servicii);
            }
            
            // Mesaje generale
            else {
                mesajReminder = `📋 ${CONFIGURARI_FIRMA.nume}\n\n` +
                    `Bună ziua ${abonat.nume}!\n\n` +
                    `Reminder: ${tipReminder}\n` +
                    `Detalii: ${detalii}\n\n` +
                    `Pentru informații:\n📞 ${CONFIGURARI_FIRMA.telefon}\n\n` +
                    `${CONFIGURARI_FIRMA.nume}`;
            }
            
            trimiteWhatsApp(abonat.telefon, mesajReminder);
            
            // Marchează ca trimis
            abonat.ultimaNotificare = new Date().toISOString();
            abonat.numarNotificari = (abonat.numarNotificari || 0) + 1;
            saveData();
            
            updateListaAbonati();
        }

        async function trimiteNotificarePlata(idAbonat) {
            const abonat = abonati.find(a => a.id === idAbonat);
            if (!abonat) return;
            
            const rezultat = await notificaPlata(abonat);
            if (rezultat.success) {
                abonat.ultimaNotificare = new Date().toISOString();
                abonat.numarNotificari = (abonat.numarNotificari || 0) + 1;
                saveData();
                
                // Afișează mesajul și în interfață
                let costTotal = 0;
                if (abonat.serviciiContractate) {
                    abonat.serviciiContractate.forEach(serviciu => {
                        switch(serviciu) {
                            case 'Verificare Instalație Gaz': costTotal += 150; break;
                            case 'Revizie Instalație Gaz': costTotal += 250; break;
                            case 'Verificare Centrală': costTotal += 150; break;
                            case 'Instalații Gaz + Centrală': costTotal += 250; break;
                        }
                    });
                }
                
                afiseazaMesajInInterfata('Notificare Plată Trimisă', 
                    messageTemplates.plataPendenta(
                        abonat.nume, 
                        costTotal,
                        abonat.serviciiContractate ? abonat.serviciiContractate.join(', ') : 'servicii'
                    )
                );
                
                if (db) {
                    await salveazaInFirestore('subscribers', abonat.id, abonat);
                }
                
                updateListaAbonati();
            }
        }

        // Funcție pentru afișarea mesajului în interfață
        function afiseazaMesajInInterfata(titlu, mesaj) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; z-index: 3000; left: 0; top: 0; 
                width: 100%; height: 100%; background: rgba(0,0,0,0.5);
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 16px; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="color: #2d3748; margin-bottom: 20px;">📱 ${titlu}</h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #4299e1; white-space: pre-line; font-family: monospace; font-size: 14px; color: #2d3748;">
${mesaj}
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="padding: 10px 20px; background: #4299e1; color: white; border: none; border-radius: 6px; cursor: pointer;">Închide</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal-overlay';
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            document.body.appendChild(modal);
            
            // Auto-remove după 10 secunde
            setTimeout(() => {
                if (modal && modal.parentNode) {
                    modal.remove();
                }
            }, 10000);
        }

        // FUNCȚII PENTRU NOTIFICĂRI ÎN MASĂ
        async function trimiteNotificariInMasa() {
            if (!confirm('Trimiteți notificări pentru toate reviziile care expiră în următoarele 30 de zile?')) {
                return;
            }
            
            const astazi = new Date();
            const in30Zile = new Date(astazi.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            const abonatiDeNotificat = abonati.filter(abonat => {
                if (!abonat.dataExpirare) return false;
                const dataExp = new Date(abonat.dataExpirare);
                return dataExp >= astazi && dataExp <= in30Zile;
            });
            
            if (abonatiDeNotificat.length === 0) {
                showNotification('Nu există abonați cu revizii care expiră în următoarele 30 de zile', 'info');
                return;
            }
            
            showNotification(`📱 Trimitere ${abonatiDeNotificat.length} notificări...`, 'info');
            
            let trimiseCuSucces = 0;
            for (const abonat of abonatiDeNotificat) {
                const rezultat = await notificaExpirareRevizie(abonat);
                if (rezultat.success) {
                    abonat.ultimaNotificare = new Date().toISOString();
                    abonat.numarNotificari = (abonat.numarNotificari || 0) + 1;
                    trimiseCuSucces++;
                }
                
                // Pauză între notificări pentru a nu supraîncărca sistemul
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            saveData();
            showNotification(`✅ ${trimiseCuSucces}/${abonatiDeNotificat.length} notificări trimise cu succes!`, 'success');
        }

        // FUNCȚIE TEST WHATSAPP
        function testeazaWhatsApp() {
            const mesajTest = `🧪 Test WhatsApp - ${CONFIGURARI_FIRMA.nume}\n\n` +
                `Acesta este un mesaj de test pentru a verifica funcționarea WhatsApp.\n\n` +
                `Dacă primiți acest mesaj, sistemul funcționează corect!\n\n` +
                `📞 ${CONFIGURARI_FIRMA.telefon}\n` +
                `${CONFIGURARI_FIRMA.nume}`;
            
            // Folosește numărul firmei pentru test
            trimiteWhatsApp(CONFIGURARI_FIRMA.telefon, mesajTest);
        }

        // Funcție pentru actualizarea valorilor în interfață
        function actualizeazaInterfata() {
            // Actualizează telefonul firmei în toate locurile
            const telefonElements = document.querySelectorAll('#telefonFirma, #telefonAlert1');
            telefonElements.forEach(element => {
                if (element) {
                    element.textContent = CONFIGURARI_FIRMA.telefon;
                }
            });

            // Actualizează exemplele de mesaje
            actualizeazaExempleMesaje();
        }

        // Funcție pentru actualizarea exemplelor de mesaje
        function actualizeazaExempleMesaje() {
            // Găsește containerul exemplelor în Dashboard
            setTimeout(() => {
                const containerExemple = Array.from(document.querySelectorAll('h3')).find(h3 => 
                    h3.textContent.includes('Exemple Mesaje')
                );
                
                if (containerExemple) {
                    const parentContainer = containerExemple.parentElement;
                    
                    // Găsește grid-ul cu exemple
                    const gridExemple = parentContainer.querySelector('div[style*="display: grid"]');
                    if (gridExemple) {
                        gridExemple.innerHTML = `
                            <div style="background: #f7fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #4299e1;">
                                <h4 style="color: #2b6cb0; margin-bottom: 10px;">🔔 Expirare Revizie (7 zile)</h4>
                                <div style="background: white; padding: 10px; border-radius: 6px; font-size: 13px; color: #4a5568; white-space: pre-line;">🔔 Bună ziua Popescu Ion!

Revizia dumneavoastră pentru Verificare Instalație Gaz expiră în 7 zile.

Pentru reprogramare, sunați la 📞 ${CONFIGURARI_FIRMA.telefon}

${CONFIGURARI_FIRMA.nume} - Servicii profesionale de instalații gaz</div>
                            </div>
                            <div style="background: #fef5e7; padding: 15px; border-radius: 8px; border-left: 4px solid #ed8936;">
                                <h4 style="color: #c05621; margin-bottom: 10px;">💰 Plată Pendentă</h4>
                                <div style="background: white; padding: 10px; border-radius: 6px; font-size: 13px; color: #4a5568; white-space: pre-line;">💰 Bună ziua Ionescu Maria!

Aveți de plătit suma de 250 Lei pentru:
Revizie Instalație Gaz

Pentru plată: 📞 ${CONFIGURARI_FIRMA.telefon}

${CONFIGURARI_FIRMA.nume} - Mulțumim!</div>
                            </div>
                            <div style="background: #f0fff4; padding: 15px; border-radius: 8px; border-left: 4px solid #38a169;">
                                <h4 style="color: #22543d; margin-bottom: 10px;">✅ Confirmare Programare</h4>
                                <div style="background: white; padding: 10px; border-radius: 6px; font-size: 13px; color: #4a5568; white-space: pre-line;">✅ Bună ziua Georgescu Andrei!

Confirmăm programarea pentru Verificare Centrală
📅 Data: 15.12.2024 10:00
📍 Adresa: Alexandria, Str. Libertății 12

Informații: 📞 ${CONFIGURARI_FIRMA.telefon}
${CONFIGURARI_FIRMA.nume}</div>
                            </div>
                            <div style="background: #fed7d7; padding: 15px; border-radius: 8px; border-left: 4px solid #f56565;">
                                <h4 style="color: #742a2a; margin-bottom: 10px;">🚨 Expirare URGENTĂ (WhatsApp)</h4>
                                <div style="background: white; padding: 10px; border-radius: 6px; font-size: 13px; color: #4a5568; white-space: pre-line;">🚨 URGENT - ${CONFIGURARI_FIRMA.nume}

Bună ziua Popescu Ion!

Verificarea/Revizia pentru Verificare Instalație Gaz a EXPIRAT.

🔧 Pentru reprogramare urgentă:
📞 Sunați la ${CONFIGURARI_FIRMA.telefon}

Este obligatoriu să refaceți verificarea conform legii!

${CONFIGURARI_FIRMA.nume}</div>
                            </div>
                        `;
                    }
                }
            }, 1000); // Așteptă ca DOM-ul să fie complet încărcat
        }

        // Verificare status Firebase
        function verificaStatusFirebase() {
            const statusElement = document.getElementById('firebaseStatus');
            if (statusElement) {
                if (db) {
                    statusElement.textContent = '✅ Conectat';
                    statusElement.style.color = '#22543d';
                } else {
                    statusElement.textContent = '❌ Offline';
                    statusElement.style.color = '#742a2a';
                }
            }
        }

        // Încărcare inițială din Firebase
        async function incarcareInitialaDinFirebase() {
            if (!db) return;
            
            try {
                showNotification('🔄 Încărcare date din Firebase...', 'info');
                
                const [firestoreAbonati, firestoreProgramari, firestoreRemindere] = await Promise.all([
                    incarcaDinFirestore('subscribers'),
                    incarcaDinFirestore('appointments'),
                    incarcaDinFirestore('reminders')
                ]);
                
                // Îmbină datele locale cu cele din Firebase (prioritate Firebase)
                if (firestoreAbonati.length > 0) {
                    abonati = firestoreAbonati;
                }
                
                if (firestoreProgramari.length > 0) {
                    programari = firestoreProgramari;
                }
                
                if (firestoreRemindere.length > 0) {
                    remindere = firestoreRemindere;
                }
                
                // Salvează local datele actualizate
                localStorage.setItem('abonati', JSON.stringify(abonati));
                localStorage.setItem('programari', JSON.stringify(programari));
                localStorage.setItem('remindere', JSON.stringify(remindere));
                
                showNotification('✅ Date încărcate din Firebase!', 'success');
                
            } catch (error) {
                console.error('❌ Eroare încărcare Firebase:', error);
                showNotification('⚠️ Eroare încărcare Firebase - se folosesc datele locale', 'warning');
            }
        }

        // Modificare funcția saveData pentru a include Firebase
        function saveData() {
            localStorage.setItem('abonati', JSON.stringify(abonati));
            localStorage.setItem('programari', JSON.stringify(programari));
            localStorage.setItem('remindere', JSON.stringify(remindere));
            
            // Sincronizare automată cu Firebase
            if (db) {
                setTimeout(() => {
                    sincronizareCuFirestore();
                }, 500);
            }
            
            // Sincronizare automată după salvare
            setTimeout(() => {
                sincronizeazaDatele();
            }, 100);
        }

        // Get selected services
        function getServiciiSelectate() {
            const servicii = [];
            const checkboxes = document.querySelectorAll('#serviciu_verificare_gaz, #serviciu_revizie_gaz, #serviciu_verificare_centrala, #serviciu_pachet_complet');
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    servicii.push(checkbox.value);
                }
            });
            
            return servicii;
        }

        // Get total cost of selected services
        function calculeazaCostTotal() {
            const servicii = getServiciiSelectate();
            let costTotal = 0;
            
            servicii.forEach(serviciu => {
                switch(serviciu) {
                    case 'Verificare Instalație Gaz':
                        costTotal += 150;
                        break;
                    case 'Revizie Instalație Gaz':
                        costTotal += 250;
                        break;
                    case 'Verificare Centrală':
                        costTotal += 150;
                        break;
                    case 'Instalații Gaz + Centrală':
                        costTotal += 250;
                        break;
                }
            });
            
            return costTotal;
        }

        // Update cost display
        function actualizareaCostului() {
            const costTotal = calculeazaCostTotal();
            const valoareElement = document.getElementById('valoareTotala');
            if (valoareElement) {
                valoareElement.textContent = costTotal;
                
                // Add animation when cost changes
                if (costTotal > 0) {
                    valoareElement.style.color = '#38a169';
                    valoareElement.style.fontSize = '20px';
                } else {
                    valoareElement.style.color = '#2c7a7b';
                    valoareElement.style.fontSize = '18px';
                }
            }
        }

        // Add event listeners for cost calculation
        function adaugaListeneriCost() {
            const checkboxes = document.querySelectorAll('#serviciu_verificare_gaz, #serviciu_revizie_gaz, #serviciu_verificare_centrala, #serviciu_pachet_complet');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', actualizareaCostului);
            });
        }

        // Create automatic reminder for revision
        function creeazaReminderAutomat(abonat) {
            if (!abonat.dataUrmatoareaRevizie || !abonat.zileNotificare) return;

            const dataUrmatoarei = new Date(abonat.dataUrmatoareaRevizie);
            const dataReminder = new Date(dataUrmatoarei);
            dataReminder.setDate(dataReminder.getDate() - parseInt(abonat.zileNotificare));

            // Verifică dacă data reminder-ului nu a trecut deja
            if (dataReminder > new Date()) {
                // Calculează costul total
                let costTotal = 0;
                if (abonat.serviciiContractate) {
                    abonat.serviciiContractate.forEach(serviciu => {
                        switch(serviciu) {
                            case 'Verificare Instalație Gaz': costTotal += 150; break;
                            case 'Revizie Instalație Gaz': costTotal += 250; break;
                            case 'Verificare Centrală': costTotal += 150; break;
                            case 'Instalații Gaz + Centrală': costTotal += 250; break;
                        }
                    });
                }

                const reminderAutomat = {
                    id: Date.now() + Math.random(),
                    clientId: abonat.id,
                    clientNume: abonat.nume,
                    tip: 'Verificare/Revizie Automată',
                    data: dataReminder.toISOString(),
                    prioritate: 'Înaltă',
                    mesaj: `REVIZIE EXPIRING pentru ${abonat.nume} - Servicii: ${abonat.serviciiContractate.join(', ')} - Cost total: ${costTotal} Lei - Adresa: ${formatareAdresa(abonat.adresa)} - Tel: ${abonat.telefon}`,
                    status: 'Activ',
                    tipAutomat: 'revizie',
                    dataCreare: new Date().toISOString()
                };

                remindere.push(reminderAutomat);
                
                // Creează și programarea automată
                const programareAutomata = {
                    id: Date.now() + Math.random() + 1,
                    clientId: abonat.id,
                    clientNume: abonat.nume,
                    tipServiciu: 'Verificare/Revizie Programată',
                    data: abonat.dataUrmatoareaRevizie,
                    status: 'Programată',
                    observatii: `Revizie automată - Servicii: ${abonat.serviciiContractate.join(', ')} - Cost: ${costTotal} Lei - Valabilitate: 2 ani`,
                    tipAutomat: 'revizie',
                    dataCreare: new Date().toISOString()
                };

                programari.push(programareAutomata);
            }
        }

        function formatareAdresa(adresa) {
            let adresaCompleta = adresa.oras;
            if (adresa.strada) adresaCompleta += `, ${adresa.strada}`;
            if (adresa.numar) adresaCompleta += ` ${adresa.numar}`;
            if (adresa.numeBlocAbonat) adresaCompleta += `, ${adresa.numeBlocAbonat}`;
            if (adresa.scara) adresaCompleta += `, Sc. ${adresa.scara}`;
            if (adresa.etaj) adresaCompleta += `, Et. ${adresa.etaj}`;
            if (adresa.apartament) adresaCompleta += `, Ap. ${adresa.apartament}`;
            return adresaCompleta;
        }

        // FUNCȚII DE VERIFICARE ALERTE SPECIFICE
        function verificaAlerteAbonati() {
            const alerteContainer = document.getElementById('alerteAbonati');
            let alerteHtml = '';

            // Verifică abonații fără documente
            const abonatiLipsaDocumente = abonati.filter(abonat => !abonat.documente || abonat.documente.length === 0);
            
            // Verifică expirări în următoarele 30 de zile
            const astazi = new Date();
            const in30Zile = new Date(astazi.getTime() + 30 * 24 * 60 * 60 * 1000);
            const expiraInCurand = abonati.filter(abonat => {
                if (!abonat.dataExpirare) return false;
                const dataExp = new Date(abonat.dataExpirare);
                return dataExp >= astazi && dataExp <= in30Zile;
            });

            if (abonatiLipsaDocumente.length > 0) {
                alerteHtml += `
                    <div class="alert alert-warning">
                        <strong>📎 Documente Lipsă!</strong> ${abonatiLipsaDocumente.length} abonați nu au documente încărcate.
                    </div>
                `;
            }

            if (expiraInCurand.length > 0) {
                alerteHtml += `
                    <div class="alert alert-danger">
                        <strong>⚠️ Expirări în 30 zile!</strong> ${expiraInCurand.length} revizii expiră în următoarele 30 de zile.
                    </div>
                `;
            }

            if (alerteContainer) {
                alerteContainer.innerHTML = alerteHtml;
            }
        }

        function verificaAlerteProgramari() {
            const alerteContainer = document.getElementById('alerteProgramari');
            let alerteHtml = '';

            const astazi = new Date();
            const programariAstazi = programari.filter(p => {
                const dataProgramare = new Date(p.data);
                return dataProgramare.toDateString() === astazi.toDateString() && p.status === 'Programată';
            });

            if (programariAstazi.length > 0) {
                alerteHtml += `
                    <div class="alert alert-info">
                        <strong>📅 Programări Astăzi!</strong> Ai ${programariAstazi.length} programări pentru astăzi.
                    </div>
                `;
            }

            if (alerteContainer) {
                alerteContainer.innerHTML = alerteHtml;
            }
        }

        function verificaAlerteRemindere() {
            const alerteContainer = document.getElementById('alerteRemindere');
            let alerteHtml = '';

            const astazi = new Date();
            const remindereUrgente = remindere.filter(r => {
                const dataReminder = new Date(r.data);
                const diferenta = Math.ceil((dataReminder - astazi) / (1000 * 60 * 60 * 24));
                return diferenta >= 0 && diferenta <= 1 && r.status === 'Activ';
            });

            if (remindereUrgente.length > 0) {
                alerteHtml += `
                    <div class="alert alert-warning">
                        <strong>🔔 Remindere Urgente!</strong> ${remindereUrgente.length} remindere expiră în următoarele 24 ore.
                    </div>
                `;
            }

            if (alerteContainer) {
                alerteContainer.innerHTML = alerteHtml;
            }
        }

        // Abonați Functions
        function adaugaAbonat() {
            const tipClient = document.getElementById('tipClient').value;
            const nume = document.getElementById('numeAbonat').value.trim();
            const telefon = document.getElementById('telefonAbonat').value.trim();
            const email = document.getElementById('emailAbonat').value.trim();
            const cnp = document.getElementById('cnpAbonat').value.trim();
            const oras = document.getElementById('orasAbonat').value;
            const strada = document.getElementById('stradaAbonat').value.trim();
            const numar = document.getElementById('numarAbonat').value.trim();
            const tipAdresa = document.getElementById('tipAdresa').value;
            const numeBlocAbonat = document.getElementById('numeBlocAbonat').value.trim();
            const scara = document.getElementById('scaraAbonat').value.trim();
            const etaj = document.getElementById('etajAbonat').value.trim();
            const apartament = document.getElementById('apartamentAbonat').value.trim();
            const dataRevizieEfectuata = document.getElementById('dataRevizieEfectuata').value;
            const dataExpirare = document.getElementById('dataExpirare').value;
            const dataPrimaRevizie = document.getElementById('dataPrimaRevizie').value;
            const periodicitateRevizie = document.getElementById('periodicitateRevizie').value;
            const dataUrmatoareaRevizie = document.getElementById('dataUrmatoareaRevizie').value;
            const zileNotificare = document.getElementById('zileNotificare').value;
            const serviciiContractate = getServiciiSelectate();

            if (!tipClient) {
                showNotification('Te rog selectează tipul clientului!', 'warning');
                return;
            }

            if (!nume || !telefon || !oras) {
                showNotification('Te rog completează toate câmpurile obligatorii!', 'warning');
                return;
            }

            // Verifică dacă abonatul există deja
            const abonatExistent = abonati.find(abonat => 
                abonat.telefon === telefon || (cnp && abonat.cnp === cnp)
            );

            if (abonatExistent) {
                showNotification('Abonatul există deja în baza de date!', 'error');
                return;
            }

            const abonatNou = {
                id: Date.now(),
                tipClient,
                nume,
                telefon,
                email,
                cnp,
                adresa: {
                    oras,
                    strada,
                    numar,
                    tipAdresa,
                    numeBlocAbonat,
                    scara,
                    etaj,
                    apartament
                },
                serviciiContractate,
                dataRevizieEfectuata,
                dataExpirare,
                dataPrimaRevizie,
                periodicitateRevizie,
                dataUrmatoareaRevizie,
                zileNotificare,
                documente: [...documenteTemp], // Adaugă documentele încărcate
                dataCreare: new Date().toISOString(),
                status: 'Activ'
            };

            abonati.push(abonatNou);

            // Creează reminder și programare automată pentru revizie
            if (dataUrmatoareaRevizie && zileNotificare) {
                creeazaReminderAutomat(abonatNou);
            }

            <!-- NOTIFICARE AUTOMATĂ PENTRU ABONAT NOU -->
            setTimeout(async () => {
                const servicii = serviciiContractate.join(', ');
                const mesaj = messageTemplates.abonatNou(nume, servicii);
                
                console.log('📱 MESAJ ABONAT NOU:');
                console.log('='.repeat(50));
                console.log(mesaj);
                console.log('='.repeat(50));
                
                await trimiteNotificare(telefon, mesaj, 'SMS');
                abonatNou.numarNotificari = 1;
                abonatNou.ultimaNotificare = new Date().toISOString();
                saveData();
            }, 1000);

            saveData();
            resetFormAbonat();
            
            const costTotal = calculeazaCostTotal();
            showNotification(`Abonatul ${nume} a fost adăugat cu succes! ${documenteTemp.length > 0 ? `(${documenteTemp.length} documente încărcate)` : ''} ${dataUrmatoareaRevizie ? 'Reminder și programare automată create!' : ''} 📱 Notificare trimisă!`, 'success');
        }

        function resetFormAbonat() {
            document.getElementById('tipClient').value = '';
            document.getElementById('numeAbonat').value = '';
            document.getElementById('telefonAbonat').value = '';
            document.getElementById('emailAbonat').value = '';
            document.getElementById('cnpAbonat').value = '';
            document.getElementById('orasAbonat').value = '';
            document.getElementById('stradaAbonat').value = '';
            document.getElementById('numarAbonat').value = '';
            document.getElementById('tipAdresa').value = '';
            document.getElementById('numeBlocAbonat').value = '';
            document.getElementById('scaraAbonat').value = '';
            document.getElementById('etajAbonat').value = '';
            document.getElementById('apartamentAbonat').value = '';
            document.getElementById('dataRevizieEfectuata').value = '';
            document.getElementById('dataExpirare').value = '';
            document.getElementById('dataPrimaRevizie').value = '';
            document.getElementById('periodicitateRevizie').value = '2';
            document.getElementById('dataUrmatoareaRevizie').value = '';
            document.getElementById('zileNotificare').value = '2';
            
            // Reset checkboxes
            document.querySelectorAll('#serviciu_verificare_gaz, #serviciu_revizie_gaz, #serviciu_verificare_centrala, #serviciu_pachet_complet').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset documente
            documenteTemp = [];
            afiseazaListaFisiere();
            
            // Reset cost display
            actualizareaCostului();
        }

        function updateListaAbonati() {
            const container = document.getElementById('listaAbonati');
            
            if (abonati.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <h3>Nu există abonați înregistrați</h3>
                        <p>Adaugă primul abonat folosind formularul de mai jos.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nume</th>
                            <th>Telefon</th>
                            <th>Adresă</th>
                            <th>Servicii</th>
                            <th>Data Revizie</th>
                            <th>Data Expirare</th>
                            <th>Documente & Acțiuni</th>
                            <th>Notificări Trimise</th>
                            <th>Status</th>
                            <th>Editare</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            abonati.forEach(abonat => {
                const adresaCompleta = formatareAdresa(abonat.adresa);
                const servicii = abonat.serviciiContractate ? abonat.serviciiContractate.join(', ') : '-';
                const dataRevizie = abonat.dataRevizieEfectuata ? new Date(abonat.dataRevizieEfectuata).toLocaleDateString('ro-RO') : '-';
                const dataExpirare = abonat.dataExpirare ? new Date(abonat.dataExpirare).toLocaleDateString('ro-RO') : '-';
                const numarDocumente = abonat.documente ? abonat.documente.length : 0;
                
                // Verifică dacă revizia expiră în curând
                let statusExpirare = 'status-active';
                if (abonat.dataExpirare) {
                    const expirare = new Date(abonat.dataExpirare);
                    const astazi = new Date();
                    const zilePanaLaExpirare = Math.ceil((expirare - astazi) / (1000 * 60 * 60 * 24));
                    
                    if (zilePanaLaExpirare < 0) {
                        statusExpirare = 'status-urgent'; // Expirat
                    } else if (zilePanaLaExpirare <= 30) {
                        statusExpirare = 'status-inactive'; // Expiră în 30 zile
                    } else if (zilePanaLaExpirare <= 90) {
                        statusExpirare = 'status-pending'; // Expiră în 90 zile
                    }
                }
                
                html += `
                    <tr>
                        <td><strong>${abonat.nume}</strong><br><small>${abonat.email || ''}</small></td>
                        <td>${abonat.telefon}</td>
                        <td><small>${adresaCompleta}</small></td>
                        <td><small>${servicii}</small></td>
                        <td><small>${dataRevizie}</small></td>
                        <td><span class="status-badge ${statusExpirare}"><small>${dataExpirare}</small></span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-small" onclick="gestioneazaDocumente(${abonat.id})" title="Gestionează documente">
                                    📎 ${numarDocumente}
                                </button>
                                <button class="btn btn-primary btn-small" onclick="trimiteNotificareExpirare(${abonat.id})" title="📱 SMS Expirare">
                                    📱 SMS
                                </button>
                                <button class="btn btn-success btn-small" onclick="trimiteWhatsAppExpirare(${abonat.id})" title="💬 WhatsApp Expirare" style="background: #25d366; color: white;">
                                    💬 WA
                                </button>
                                <button class="btn btn-warning btn-small" onclick="trimiteNotificarePlata(${abonat.id})" title="💰 Notificare plată" style="background: #f6ad55; color: white;">
                                    💰
                                </button>
                            </div>
                        </td>
                        <td>
                            <div style="text-align: center;">
                                <span class="status-badge status-pending" style="font-size: 10px;">
                                    📱 ${abonat.numarNotificari || 0}
                                </span>
                                ${abonat.ultimaNotificare ? `<br><small style="color: #718096; font-size: 10px;">${new Date(abonat.ultimaNotificare).toLocaleDateString('ro-RO')}</small>` : ''}
                            </div>
                        </td>
                        <td><span class="status-badge status-active">${abonat.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-small" onclick="editaAbonat(${abonat.id})" title="Editează">✏️</button>
                                <button class="btn btn-danger btn-small" onclick="stergeAbonat(${abonat.id})" title="Șterge">🗑️</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function stergeAbonat(id) {
            if (confirm('Ești sigur că vrei să ștergi acest abonat? Vor fi șterse și programările și reminder-urile asociate.')) {
                abonati = abonati.filter(abonat => abonat.id !== id);
                programari = programari.filter(programare => programare.clientId != id);
                remindere = remindere.filter(reminder => reminder.clientId != id);
                saveData();
                showNotification('Abonatul și datele asociate au fost șterse cu succes!', 'success');
            }
        }

        // Update client dropdowns with SYNC
        function updateClientDropdowns() {
            const dropdowns = ['clientProgramare', 'clientReminder'];
            
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    const currentValue = dropdown.value; // Păstrează valoarea selectată
                    let html = '<option value="">Selectează clientul</option><option value="nou">➕ Client Nou</option>';
                    
                    abonati.forEach(abonat => {
                        html += `<option value="${abonat.id}" ${currentValue == abonat.id ? 'selected' : ''}>${abonat.nume} - ${abonat.telefon}</option>`;
                    });
                    
                    dropdown.innerHTML = html;
                }
            });
        }

        // Programări Functions
        function adaugaProgramare() {
            const clientId = document.getElementById('clientProgramare').value;
            const tipServiciu = document.getElementById('tipServiciu').value;
            const data = document.getElementById('dataProgramare').value;
            const status = document.getElementById('statusProgramare').value;
            const observatii = document.getElementById('observatiiProgramare').value.trim();

            if (!clientId || !tipServiciu || !data) {
                showNotification('Te rog completează toate câmpurile obligatorii!', 'warning');
                return;
            }

            const programareNoua = {
                id: Date.now(),
                clientId,
                clientNume: clientId === 'nou' ? 'Client Nou' : abonati.find(a => a.id == clientId)?.nume || 'Client Necunoscut',
                tipServiciu,
                data,
                status,
                observatii,
                dataCreare: new Date().toISOString()
            };

            programari.push(programareNoua);

            // NOTIFICARE AUTOMATĂ PENTRU PROGRAMARE
            setTimeout(async () => {
                if (clientId !== 'nou') {
                    await confirmareProgramare(programareNoua);
                }
            }, 500);

            saveData();
            resetFormProgramare();
            
            showNotification('Programarea a fost adăugată cu succes! 📱 Notificare trimisă!', 'success');
        }

        function resetFormProgramare() {
            document.getElementById('clientProgramare').value = '';
            document.getElementById('tipServiciu').value = '';
            document.getElementById('dataProgramare').value = '';
            document.getElementById('statusProgramare').value = 'Programată';
            document.getElementById('observatiiProgramare').value = '';
        }

        function updateListaProgramari() {
            const container = document.getElementById('listaProgramari');
            
            if (programari.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <h3>Nu există programări</h3>
                        <p>Adaugă prima programare folosind formularul de mai jos.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Serviciu</th>
                            <th>Data</th>
                            <th>Status</th>
                            <th>Observații</th>
                            <th>Acțiuni</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            programari.forEach(programare => {
                const dataFormatata = new Date(programare.data).toLocaleString('ro-RO');
                const clasaUrgenta = programare.tipAutomat === 'revizie' ? 'urgent-reminder' : '';
                
                html += `
                    <tr class="${clasaUrgenta}">
                        <td><strong>${programare.clientNume}</strong></td>
                        <td>${programare.tipServiciu}${programare.tipAutomat === 'revizie' ? ' 🔄' : ''}</td>
                        <td>${dataFormatata}</td>
                        <td><span class="status-badge ${getStatusClass(programare.status)}">${programare.status}</span></td>
                        <td><small>${programare.observatii || '-'}</small></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-small" onclick="editaProgramare(${programare.id})" title="Editează">✏️</button>
                                <button class="btn btn-danger btn-small" onclick="stergeProgramare(${programare.id})" title="Șterge">🗑️</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function stergeProgramare(id) {
            if (confirm('Ești sigur că vrei să ștergi această programare?')) {
                programari = programari.filter(programare => programare.id !== id);
                saveData();
                showNotification('Programarea a fost ștearsă cu succes!', 'success');
            }
        }

        // Remindere Functions
        function adaugaReminder() {
            const clientId = document.getElementById('clientReminder').value;
            const tip = document.getElementById('tipReminder').value;
            const problemaSpecifica = document.getElementById('problemaSpecifica').value;
            const data = document.getElementById('dataReminder').value;
            const prioritate = document.getElementById('prioritateReminder').value;
            const mesaj = document.getElementById('mesajReminder').value.trim();

            if (!clientId || !tip || !data) {
                showNotification('Te rog completează toate câmpurile obligatorii!', 'warning');
                return;
            }

            // Construiește mesajul final
            let mesajFinal = mesaj;
            if (problemaSpecifica) {
                mesajFinal = `${problemaSpecifica}${mesaj ? ' - ' + mesaj : ''}`;
            }

            const reminderNou = {
                id: Date.now(),
                clientId,
                clientNume: clientId === 'nou' ? 'Client Nou' : abonati.find(a => a.id == clientId)?.nume || 'Client Necunoscut',
                tip,
                problemaSpecifica: problemaSpecifica || null,
                data,
                prioritate,
                mesaj: mesajFinal,
                status: 'Activ',
                dataCreare: new Date().toISOString()
            };

            remindere.push(reminderNou);
            
            // TRIMITE AUTOMAT PE WHATSAPP DACĂ E EXPIRARE URGENTĂ
            if ((problemaSpecifica && problemaSpecifica.includes('Expirat')) || 
                (prioritate === 'Urgentă' && (tip.includes('Verificare') || tip.includes('Revizie')))) {
                setTimeout(() => {
                    if (clientId !== 'nou') {
                        trimiteWhatsAppReminder(clientId, tip, problemaSpecifica || tip);
                    }
                }, 500);
            }

            saveData();
            resetFormReminder();
            
            const messageExtra = (problemaSpecifica && problemaSpecifica.includes('Expirat')) ? '📱 WhatsApp trimis automat!' : '';
            showNotification(`Reminder adăugat cu succes! ${messageExtra}`, 'success');
        }

        function resetFormReminder() {
            document.getElementById('clientReminder').value = '';
            document.getElementById('tipReminder').value = '';
            document.getElementById('problemaSpecifica').value = '';
            document.getElementById('dataReminder').value = '';
            document.getElementById('prioritateReminder').value = 'Joasă';
            document.getElementById('mesajReminder').value = '';
        }

        function updateListaRemindere() {
            const container = document.getElementById('listaRemindere');
            
            if (remindere.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔔</div>
                        <h3>Nu există remindere</h3>
                        <p>Adaugă primul reminder folosind formularul de mai jos.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Tip</th>
                            <th>Problemă</th>
                            <th>Data</th>
                            <th>Prioritate</th>
                            <th>Mesaj</th>
                            <th>Acțiuni</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            remindere.forEach(reminder => {
                const dataFormatata = new Date(reminder.data).toLocaleString('ro-RO');
                const clasaUrgenta = reminder.tipAutomat === 'revizie' ? 'urgent-reminder' : '';
                const problemaAfisata = reminder.problemaSpecifica || '-';
                
                html += `
                    <tr class="${clasaUrgenta}">
                        <td><strong>${reminder.clientNume}</strong></td>
                        <td>${reminder.tip}${reminder.tipAutomat === 'revizie' ? ' 🔄' : ''}</td>
                        <td><small style="color: ${reminder.problemaSpecifica && reminder.problemaSpecifica.includes('🚨') ? '#e53e3e' : '#4a5568'};">${problemaAfisata}</small></td>
                        <td>${dataFormatata}</td>
                        <td><span class="status-badge ${getPriorityClass(reminder.prioritate)}">${reminder.prioritate}</span></td>
                        <td><small>${reminder.mesaj || '-'}</small></td>
                        <td>
                            <div class="action-buttons">
                                ${reminder.problemaSpecifica ? `<button class="btn btn-success btn-small" onclick="trimiteWhatsAppReminder('${reminder.clientId}', '${reminder.tip}', '${reminder.problemaSpecifica}')" title="💬 Trimite pe WhatsApp" style="background: #25d366; color: white;">💬 WA</button>` : ''}
                                <button class="btn btn-secondary btn-small" onclick="editaReminder(${reminder.id})" title="Editează">✏️</button>
                                <button class="btn btn-danger btn-small" onclick="stergeReminder(${reminder.id})" title="Șterge">🗑️</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function stergeReminder(id) {
            if (confirm('Ești sigur că vrei să ștergi acest reminder?')) {
                remindere = remindere.filter(reminder => reminder.id !== id);
                saveData();
                showNotification('Reminder-ul a fost șters cu succes!', 'success');
            }
        }

        // Check for pending reminders
        function verificaReminderePendente() {
            const astazi = new Date();
            const alerteContainer = document.getElementById('alerteUrgente');
            let alerteHtml = '';

            // Verifică reminder-urile care expiră astăzi sau mâine
            const reminderePendente = remindere.filter(reminder => {
                const dataReminder = new Date(reminder.data);
                const diferenta = Math.ceil((dataReminder - astazi) / (1000 * 60 * 60 * 24));
                return diferenta >= 0 && diferenta <= 2 && reminder.status === 'Activ';
            });

            // Verifică reviziile care expiră în următoarele 7 zile
            const reviziiExpira = abonati.filter(abonat => {
                if (!abonat.dataUrmatoareaRevizie) return false;
                const dataRevizie = new Date(abonat.dataUrmatoareaRevizie);
                const diferenta = Math.ceil((dataRevizie - astazi) / (1000 * 60 * 60 * 24));
                return diferenta >= 0 && diferenta <= 7;
            });

            if (reminderePendente.length > 0) {
                alerteHtml += `
                    <div class="alert alert-warning">
                        <strong>🔔 Reminder-e Urgente!</strong> Ai ${reminderePendente.length} reminder-e care expiră în următoarele 2 zile.
                    </div>
                `;
                
                // Afișează notificare și pentru reminder-urile urgente
                if (reminderePendente.length > 0) {
                    showNotification(`⚠️ Ai ${reminderePendente.length} reminder-e urgente!`, 'warning');
                }
            }

            if (reviziiExpira.length > 0) {
                alerteHtml += `
                    <div class="alert alert-info">
                        <strong>🔍 Revizii Programate!</strong> ${reviziiExpira.length} revizii programate în următoarele 7 zile.
                    </div>
                `;
            }

            if (alerteContainer) {
                alerteContainer.innerHTML = alerteHtml;
            }
        }

        // Utility functions
        function getStatusClass(status) {
            switch(status) {
                case 'Programată': return 'status-pending';
                case 'În Progres': return 'status-active';
                case 'Finalizată': return 'status-active';
                case 'Anulată': return 'status-inactive';
                default: return 'status-pending';
            }
        }

        function getPriorityClass(prioritate) {
            switch(prioritate) {
                case 'Joasă': return 'status-active';
                case 'Medie': return 'status-pending';
                case 'Înaltă': return 'status-inactive';
                case 'Urgentă': return 'status-urgent';
                default: return 'status-pending';
            }
        }

        // Dashboard update
        function updateDashboard() {
            document.getElementById('totalAbonati').textContent = abonati.length;
            
            const astazi = new Date().toDateString();
            const programariAstazi = programari.filter(p => 
                new Date(p.data).toDateString() === astazi
            ).length;
            document.getElementById('programariAstazi').textContent = programariAstazi;
            
            const remindereActive = remindere.filter(r => r.status === 'Activ').length;
            document.getElementById('remindereActive').textContent = remindereActive;

            // Calculează reviziile din următoarele 7 zile
            const astazi7Zile = new Date();
            astazi7Zile.setDate(astazi7Zile.getDate() + 7);
            const reviziiSaptamana = abonati.filter(abonat => {
                if (!abonat.dataUrmatoareaRevizie) return false;
                const dataRevizie = new Date(abonat.dataUrmatoareaRevizie);
                return dataRevizie >= new Date() && dataRevizie <= astazi7Zile;
            }).length;
            document.getElementById('reviziiSaptamana').textContent = reviziiSaptamana;
        }

        // Reports update
        function updateRapoarte() {
            document.getElementById('raportTotalAbonati').textContent = abonati.length;
            document.getElementById('raportProgramari').textContent = programari.length;
            document.getElementById('raportRemindere').textContent = remindere.filter(r => r.status === 'Activ').length;

            // Calculează reviziile următoarea lună
            const astazi = new Date();
            const lunaViitoare = new Date(astazi.getFullYear(), astazi.getMonth() + 1, astazi.getDate());
            const reviziiLunaViitoare = abonati.filter(abonat => {
                if (!abonat.dataUrmatoareaRevizie) return false;
                const dataRevizie = new Date(abonat.dataUrmatoareaRevizie);
                return dataRevizie >= astazi && dataRevizie <= lunaViitoare;
            }).length;
            document.getElementById('raportRevizii').textContent = reviziiLunaViitoare;

            // Distribuție pe orașe
            const distributie = {};
            abonati.forEach(abonat => {
                const oras = abonat.adresa.oras;
                distributie[oras] = (distributie[oras] || 0) + 1;
            });

            let distributieHtml = '';
            Object.entries(distributie).forEach(([oras, count]) => {
                distributieHtml += `<p style="color: #718096;">${oras}: <strong>${count}</strong></p>`;
            });

            document.getElementById('distributieOrase').innerHTML = distributieHtml || '<p style="color: #718096;">Nu există date disponibile</p>';

            // Distribuție servicii
            const serviciiDistributie = {};
            abonati.forEach(abonat => {
                if (abonat.serviciiContractate) {
                    abonat.serviciiContractate.forEach(serviciu => {
                        serviciiDistributie[serviciu] = (serviciiDistributie[serviciu] || 0) + 1;
                    });
                }
            });

            let serviciiHtml = '';
            Object.entries(serviciiDistributie).forEach(([serviciu, count]) => {
                serviciiHtml += `<p style="color: #718096;">${serviciu}: <strong>${count}</strong></p>`;
            });

            document.getElementById('distributieServicii').innerHTML = serviciiHtml || '<p style="color: #718096;">Nu există date disponibile</p>';
        }

        // Export PDF functionality
        function exportRaportPDF() {
            if (typeof window.jsPDF === 'undefined') {
                showNotification('Biblioteca PDF nu este încărcată. Încearcă din nou.', 'error');
                return;
            }

            const { jsPDF } = window.jsPDF;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(20);
            doc.text('RAPORT COMPLET - GAZTECH SERVICES', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`Generat pe: ${new Date().toLocaleDateString('ro-RO')}`, 20, 30);
            
            let yPosition = 50;
            
            // Statistici generale
            doc.setFontSize(16);
            doc.text('STATISTICI GENERALE', 20, yPosition);
            yPosition += 10;
            
            doc.setFontSize(12);
            doc.text(`Total Abonați: ${abonati.length}`, 20, yPosition);
            yPosition += 7;
            doc.text(`Total Programări: ${programari.length}`, 20, yPosition);
            yPosition += 7;
            doc.text(`Total Remindere: ${remindere.length}`, 20, yPosition);
            yPosition += 15;
            
            // Abonați
            doc.setFontSize(16);
            doc.text('LISTA ABONAȚI', 20, yPosition);
            yPosition += 10;
            
            abonati.forEach((abonat, index) => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                const servicii = abonat.serviciiContractate ? abonat.serviciiContractate.join(', ') : 'N/A';
                const adresa = formatareAdresa(abonat.adresa);
                const dataRevizie = abonat.dataRevizieEfectuata ? new Date(abonat.dataRevizieEfectuata).toLocaleDateString('ro-RO') : 'N/A';
                const dataExpirare = abonat.dataExpirare ? new Date(abonat.dataExpirare).toLocaleDateString('ro-RO') : 'N/A';
                const numarDocumente = abonat.documente ? abonat.documente.length : 0;
                
                doc.setFontSize(12);
                doc.text(`${index + 1}. ${abonat.nume}`, 20, yPosition);
                yPosition += 6;
                doc.setFontSize(10);
                doc.text(`   Tel: ${abonat.telefon} | Email: ${abonat.email || 'N/A'}`, 20, yPosition);
                yPosition += 5;
                doc.text(`   Adresa: ${adresa}`, 20, yPosition);
                yPosition += 5;
                doc.text(`   Servicii: ${servicii}`, 20, yPosition);
                yPosition += 5;
                doc.text(`   Data Revizie: ${dataRevizie} | Expirare: ${dataExpirare}`, 20, yPosition);
                yPosition += 5;
                doc.text(`   Documente: ${numarDocumente}`, 20, yPosition);
                yPosition += 10;
            });
            
            // Salvare
            doc.save(`GazTech_Raport_Complet_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Raportul PDF a fost generat cu succes!', 'success');
        }

        // Export Excel functionality
        function exportRaportExcel() {
            if (typeof XLSX === 'undefined') {
                showNotification('Biblioteca Excel nu este încărcată. Încearcă din nou.', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();
            
            // Foi Excel
            const foaieAbonati = [];
            const foaieProgramari = [];
            const foaieRemindere = [];
            const foaieStatistici = [];
            
            // Date abonați
            foaieAbonati.push(['Nume', 'Telefon', 'Email', 'CNP', 'Oraș', 'Strada', 'Număr', 'Bloc', 'Scara', 'Etaj', 'Apartament', 'Servicii Contractate', 'Cost Total', 'Data Revizie', 'Data Expirare', 'Tip Client', 'Număr Documente', 'Status']);
            
            abonati.forEach(abonat => {
                let costTotal = 0;
                if (abonat.serviciiContractate) {
                    abonat.serviciiContractate.forEach(serviciu => {
                        switch(serviciu) {
                            case 'Verificare Instalație Gaz': costTotal += 150; break;
                            case 'Revizie Instalație Gaz': costTotal += 250; break;
                            case 'Verificare Centrală': costTotal += 150; break;
                            case 'Instalații Gaz + Centrală': costTotal += 250; break;
                        }
                    });
                }
                
                const servicii = abonat.serviciiContractate ? abonat.serviciiContractate.join('; ') : '';
                const dataRevizie = abonat.dataRevizieEfectuata || '';
                const dataExpirare = abonat.dataExpirare || '';
                const numarDocumente = abonat.documente ? abonat.documente.length : 0;
                
                foaieAbonati.push([
                    abonat.nume,
                    abonat.telefon,
                    abonat.email || '',
                    abonat.cnp || '',
                    abonat.adresa.oras,
                    abonat.adresa.strada || '',
                    abonat.adresa.numar || '',
                    abonat.adresa.numeBlocAbonat || '',
                    abonat.adresa.scara || '',
                    abonat.adresa.etaj || '',
                    abonat.adresa.apartament || '',
                    servicii,
                    costTotal + ' Lei',
                    dataRevizie,
                    dataExpirare,
                    abonat.tipClient === 'nou' ? 'Client Nou' : 'Client Actual',
                    numarDocumente,
                    abonat.status
                ]);
            });
            
            // Date programări
            foaieProgramari.push(['Client', 'Serviciu', 'Data', 'Status', 'Observații', 'Tip', 'Data Creare']);
            programari.forEach(p => {
                foaieProgramari.push([
                    p.clientNume,
                    p.tipServiciu,
                    new Date(p.data).toLocaleString('ro-RO'),
                    p.status,
                    p.observatii || '',
                    p.tipAutomat || 'Manual',
                    new Date(p.dataCreare).toLocaleDateString('ro-RO')
                ]);
            });
            
            // Date remindere
            foaieRemindere.push(['Client', 'Tip', 'Data', 'Prioritate', 'Mesaj', 'Status', 'Tip', 'Data Creare']);
            remindere.forEach(r => {
                foaieRemindere.push([
                    r.clientNume,
                    r.tip,
                    new Date(r.data).toLocaleString('ro-RO'),
                    r.prioritate,
                    r.mesaj || '',
                    r.status,
                    r.tipAutomat || 'Manual',
                    new Date(r.dataCreare).toLocaleDateString('ro-RO')
                ]);
            });
            
            // Statistici
            foaieStatistici.push(['Statistică', 'Valoare']);
            foaieStatistici.push(['Total Abonați', abonati.length]);
            foaieStatistici.push(['Total Programări', programari.length]);
            foaieStatistici.push(['Total Remindere', remindere.length]);
            foaieStatistici.push(['Data Generare', new Date().toLocaleDateString('ro-RO')]);
            
            // Adaugă foile în Excel
            const wsAbonati = XLSX.utils.aoa_to_sheet(foaieAbonati);
            const wsProgramari = XLSX.utils.aoa_to_sheet(foaieProgramari);
            const wsRemindere = XLSX.utils.aoa_to_sheet(foaieRemindere);
            const wsStatistici = XLSX.utils.aoa_to_sheet(foaieStatistici);
            
            XLSX.utils.book_append_sheet(wb, wsAbonati, 'Abonați');
            XLSX.utils.book_append_sheet(wb, wsProgramari, 'Programări');
            XLSX.utils.book_append_sheet(wb, wsRemindere, 'Remindere');
            XLSX.utils.book_append_sheet(wb, wsStatistici, 'Statistici');
            
            // Salvare
            XLSX.writeFile(wb, `GazTech_Raport_Excel_${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Raportul Excel a fost generat cu succes!', 'success');
        }

        // Export functions
        function exportAbonati() {
            let csvContent = "data:text/csv;charset=utf-8,Nume,Telefon,Email,CNP,Oraș,Strada,Număr,Tip Adresă,Bloc,Scara,Etaj,Apartament,Servicii Contractate,Tip Client,Prima Revizie,Următoarea Revizie,Status\n";
            
            abonati.forEach(a => {
                const servicii = a.serviciiContractate ? a.serviciiContractate.join(';') : '';
                const primaRevizie = a.dataPrimaRevizie || '';
                const urmatoareaRevizie = a.dataUrmatoareaRevizie || '';
                
                csvContent += `"${a.nume}","${a.telefon}","${a.email || ''}","${a.cnp || ''}","${a.adresa.oras}","${a.adresa.strada || ''}","${a.adresa.numar || ''}","${a.adresa.tipAdresa || ''}","${a.adresa.numeBlocAbonat || ''}","${a.adresa.scara || ''}","${a.adresa.etaj || ''}","${a.adresa.apartament || ''}","${servicii}","${a.tipClient}","${primaRevizie}","${urmatoareaRevizie}","${a.status}"\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "gaztech_abonati.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Datele abonaților au fost exportate!', 'success');
        }

        function exportProgramari() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Client,Serviciu,Data,Status,Observații,Tip\n"
                + programari.map(p => 
                    `"${p.clientNume}","${p.tipServiciu}","${new Date(p.data).toLocaleString('ro-RO')}","${p.status}","${p.observatii || ''}","${p.tipAutomat || 'Manual'}"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "gaztech_programari.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Datele programărilor au fost exportate!', 'success');
        }

        function exportRemindere() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Client,Tip,Data,Prioritate,Mesaj,Status,Tip\n"
                + remindere.map(r => 
                    `"${r.clientNume}","${r.tip}","${new Date(r.data).toLocaleString('ro-RO')}","${r.prioritate}","${r.mesaj || ''}","${r.status}","${r.tipAutomat || 'Manual'}"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "gaztech_remindere.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Datele reminder-urilor au fost exportate!', 'success');
        }

        function exportRevizii() {
            let csvContent = "data:text/csv;charset=utf-8,Nume,Telefon,Adresă Completă,Servicii,Prima Revizie,Următoarea Revizie,Periodicitate,Zile Notificare\n";
            
            abonati.filter(a => a.dataUrmatoareaRevizie).forEach(a => {
                const adresaCompleta = formatareAdresa(a.adresa);
                const servicii = a.serviciiContractate ? a.serviciiContractate.join(';') : '';
                
                csvContent += `"${a.nume}","${a.telefon}","${adresaCompleta}","${servicii}","${a.dataPrimaRevizie || ''}","${a.dataUrmatoareaRevizie}","${a.periodicitateRevizie} ani","${a.zileNotificare} zile"\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "gaztech_revizii.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Datele reviziilor au fost exportate!', 'success');
        }

        // Search functionality
        document.getElementById('searchAbonati')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#listaAbonati tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('modalDocumente');
            if (e.target === modal) {
                inchideModalDocumente();
            }
        });

        // ADAUGĂ DATE DE TEST PENTRU DEMONSTRAȚIA SINCRONIZĂRII
        function adaugaDateDeTest() {
            if (abonati.length === 0) {
                // Abonați de test
                const abonatiTest = [
                    {
                        id: 1000001,
                        tipClient: 'nou',
                        nume: 'Popescu Ion',
                        telefon: '0721234567',
                        email: 'ion.popescu@email.ro',
                        cnp: '1801010120001',
                        adresa: {
                            oras: 'Alexandria',
                            strada: 'Str. Libertății',
                            numar: '12',
                            tipAdresa: 'Casa',
                            numeBlocAbonat: '',
                            scara: '',
                            etaj: '',
                            apartament: ''
                        },
                        serviciiContractate: ['Verificare Instalație Gaz', 'Verificare Centrală'],
                        dataRevizieEfectuata: '2023-06-15',
                        dataExpirare: '2025-06-15',
                        dataPrimaRevizie: '2023-06-15',
                        periodicitateRevizie: '2',
                        dataUrmatoareaRevizie: '2025-06-15',
                        zileNotificare: '7',
                        documente: [
                            {
                                id: 1001,
                                nume: 'Certificat_Instalatie.pdf',
                                tip: 'application/pdf',
                                marime: 245760,
                                continut: 'JVBERi0xLjQKJcOkw7zDtsO2CjIgMCBvYmoKPDwvTGVuZ3==',
                                dataIncarcare: '2024-01-15T10:30:00.000Z'
                            }
                        ],
                        numarNotificari: 2,
                        ultimaNotificare: '2024-12-01T10:00:00.000Z',
                        dataCreare: '2024-01-15T10:30:00.000Z',
                        status: 'Activ'
                    },
                    {
                        id: 1000002,
                        tipClient: 'actual',
                        nume: 'Ionescu Maria',
                        telefon: '0734567890',
                        email: 'maria.ionescu@yahoo.ro',
                        cnp: '2850505110002',
                        adresa: {
                            oras: 'Roșiorii de Vede',
                            strada: 'Bd. Republicii',
                            numar: '45',
                            tipAdresa: 'Bloc',
                            numeBlocAbonat: 'Bl. A3',
                            scara: 'B',
                            etaj: '4',
                            apartament: '23'
                        },
                        serviciiContractate: ['Instalații Gaz + Centrală'],
                        dataRevizieEfectuata: '2024-01-20',
                        dataExpirare: '2026-01-20',
                        dataPrimaRevizie: '2024-01-20',
                        periodicitateRevizie: '2',
                        dataUrmatoareaRevizie: '2026-01-20',
                        zileNotificare: '3',
                        documente: [],
                        numarNotificari: 0,
                        ultimaNotificare: null,
                        dataCreare: '2024-02-10T14:20:00.000Z',
                        status: 'Activ'
                    },
                    {
                        id: 1000003,
                        tipClient: 'nou',
                        nume: 'Georgescu Andrei',
                        telefon: '0745123789',
                        email: '',
                        cnp: '',
                        adresa: {
                            oras: 'Turnu Măgurele',
                            strada: 'Str. Mihai Viteazu',
                            numar: '78',
                            tipAdresa: 'Casa',
                            numeBlocAbonat: '',
                            scara: '',
                            etaj: '',
                            apartament: ''
                        },
                        serviciiContractate: ['Revizie Instalație Gaz'],
                        dataRevizieEfectuata: '2024-11-01',
                        dataExpirare: '2026-11-01',
                        dataPrimaRevizie: '2024-11-01',
                        periodicitateRevizie: '2',
                        dataUrmatoareaRevizie: '2026-11-01',
                        zileNotificare: '2',
                        documente: [
                            {
                                id: 1002,
                                nume: 'Plan_Instalatie.jpg',
                                tip: 'image/jpeg',
                                marime: 524288,
                                continut: '/9j/4AAQSkZJRgABAQAAAQABAAD/2wBD==',
                                dataIncarcare: '2024-11-02T09:15:00.000Z'
                            },
                            {
                                id: 1003,
                                nume: 'Factura_Revizie.pdf',
                                tip: 'application/pdf',
                                marime: 180224,
                                continut: 'JVBERi0xLjQKJcOkw7zDtsO2CjIgMCB==',
                                dataIncarcare: '2024-11-02T09:20:00.000Z'
                            }
                        ],
                        numarNotificari: 1,
                        ultimaNotificare: '2024-11-25T16:00:00.000Z',
                        dataCreare: '2024-11-01T16:45:00.000Z',
                        status: 'Activ'
                    }
                ];

                // Programări de test
                const programariTest = [
                    {
                        id: 2000001,
                        clientId: 1000001,
                        clientNume: 'Popescu Ion',
                        tipServiciu: 'Verificare Instalație Gaz',
                        data: new Date().toISOString(), // Astăzi
                        status: 'Programată',
                        observatii: 'Verificare anuală programată automat',
                        tipAutomat: 'revizie',
                        dataCreare: '2024-12-01T08:00:00.000Z'
                    },
                    {
                        id: 2000002,
                        clientId: 1000002,
                        clientNume: 'Ionescu Maria',
                        tipServiciu: 'Instalații Gaz + Centrală',
                        data: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // Mâine
                        status: 'Programată',
                        observatii: 'Client prioritar - apartament',
                        dataCreare: '2024-12-02T10:30:00.000Z'
                    },
                    {
                        id: 2000003,
                        clientId: 1000003,
                        clientNume: 'Georgescu Andrei',
                        tipServiciu: 'Revizie Instalație Gaz',
                        data: '2024-11-25T14:00:00.000Z',
                        status: 'Finalizată',
                        observatii: 'Revizie completată cu succes',
                        dataCreare: '2024-11-20T12:00:00.000Z'
                    }
                ];

                // Remindere de test
                const remindereTest = [
                    {
                        id: 3000001,
                        clientId: 1000001,
                        clientNume: 'Popescu Ion',
                        tip: 'Verificare/Revizie Automată',
                        data: new Date(Date.now() + 12 * 60 * 60 * 1000).toISOString(), // În 12 ore
                        prioritate: 'Înaltă',
                        mesaj: 'REVIZIE EXPIRING pentru Popescu Ion - Servicii: Verificare Instalație Gaz, Verificare Centrală - Cost total: 300 Lei - Adresa: Alexandria, Str. Libertății 12 - Tel: 0721234567',
                        status: 'Activ',
                        tipAutomat: 'revizie',
                        dataCreare: '2024-11-01T09:00:00.000Z'
                    },
                    {
                        id: 3000002,
                        clientId: 1000002,
                        clientNume: 'Ionescu Maria',
                        tip: 'Urmărire Client',
                        data: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(), // În 2 zile
                        prioritate: 'Medie',
                        mesaj: 'Urmărire pentru încărcarea documentelor lipsă',
                        status: 'Activ',
                        dataCreare: '2024-12-01T15:00:00.000Z'
                    },
                    {
                        id: 3000003,
                        clientId: 1000003,
                        clientNume: 'Georgescu Andrei',
                        tip: 'Facturare',
                        data: new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString(), // În 48 ore
                        prioritate: 'Urgentă',
                        mesaj: 'Facturare pentru revizia efectuată',
                        status: 'Activ',
                        dataCreare: '2024-11-25T16:00:00.000Z'
                    }
                ];

                // Adaugă datele de test
                abonati.push(...abonatiTest);
                programari.push(...programariTest);
                remindere.push(...remindereTest);
                
                // Salvează datele
                saveData();
                
                showNotification('✅ Date de test adăugate pentru demonstrația sincronizării!', 'success');
                console.log('📊 Date de test adăugate:', {
                    abonati: abonatiTest.length,
                    programari: programariTest.length, 
                    remindere: remindereTest.length
                });
            }
        }

        // FUNCȚIE AVANSATĂ DE SINCRONIZARE CU PROGRESS
        function sincronizareAvansata() {
            showNotification('🔄 Începe sincronizarea avansată...', 'info');
            
            setTimeout(() => {
                // Actualizează toate componentele
                updateClientDropdowns();
                updateDashboard();
                updateRapoarte();
                
                // Verifică și curăță datele
                verificaConsistentaDatele();
                
                showNotification('✅ Sincronizare avansată completă!', 'success');
                showSyncIndicator();
            }, 1000);
        }

        function verificaConsistentaDatele() {
            let problemeGasite = 0;
            
            // Verifică programările orfane
            programari.forEach((programare, index) => {
                if (programare.clientId !== 'nou' && !abonati.find(a => a.id == programare.clientId)) {
                    console.warn(`Programare orfană găsită: ${programare.clientNume}`);
                    problemeGasite++;
                }
            });
            
            // Verifică reminder-ele orfane
            remindere.forEach((reminder, index) => {
                if (reminder.clientId !== 'nou' && !abonati.find(a => a.id == reminder.clientId)) {
                    console.warn(`Reminder orfan găsit: ${reminder.clientNume}`);
                    problemeGasite++;
                }
            });
            
            if (problemeGasite > 0) {
                showNotification(`⚠️ ${problemeGasite} probleme de consistență găsite`, 'warning');
            }
            
            console.log(`🔍 Verificare consistență: ${problemeGasite} probleme găsite`);
        }

        // BACKUP ȘI RESTORE
        function creeazaBackup() {
            const backup = {
                timestamp: new Date().toISOString(),
                versiune: '1.0',
                abonati: abonati,
                programari: programari,
                remindere: remindere
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `GazTech_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('💾 Backup creat cu succes!', 'success');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            // Înregistrare Service Worker pentru PWA
            if ('serviceWorker' in navigator) {
                try {
                    // Service Worker inline pentru PWA
                    const swCode = `
                        const CACHE_NAME = 'gaztech-v1';
                        const urlsToCache = ['/'];
                        
                        self.addEventListener('install', event => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then(cache => cache.addAll(urlsToCache))
                            );
                        });
                        
                        self.addEventListener('fetch', event => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => {
                                        if (response) {
                                            return response;
                                        }
                                        return fetch(event.request);
                                    })
                            );
                        });
                    `;
                    
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    
                    await navigator.serviceWorker.register(swUrl);
                    console.log('✅ PWA Service Worker înregistrat cu succes!');
                    
                    // Afișează prompt pentru instalare PWA
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        showNotification('📱 Poți instala GazTech ca aplicație pe telefon!', 'info');
                        
                        setTimeout(() => {
                            e.prompt();
                        }, 3000);
                    });
                    
                } catch (error) {
                    console.warn('⚠️ Service Worker nu s-a putut înregistra:', error);
                }
            }

            // Actualizează interfața cu valorile corecte
            actualizeazaInterfata();
            
            // Verifică statusul Firebase
            verificaStatusFirebase();
            
            // Încearcă să încarce datele din Firebase
            await incarcareInitialaDinFirebase();
            
            // Adaugă date de test dacă nu există
            if (abonati.length === 0) {
                adaugaDateDeTest();
            }
            
            // Sincronizare inițială
            sincronizeazaDatele();
            
            // Inițializează upload-ul de fișiere
            initializeFileUpload();
            
            // Adaugă event listeners pentru calculul costului
            adaugaListeneriCost();
            actualizareaCostului();
            
            // Check for urgent reminders every 5 minutes
            setInterval(verificaReminderePendente, 5 * 60 * 1000);
            
            // Verificare automată notificări la fiecare 30 minute
            setInterval(verificaNotificariAutomated, 30 * 60 * 1000);
            
            // Sincronizare avansată la fiecare 30 secunde
            setInterval(sincronizareAvansata, 30000);
            
            // Sincronizare cu Firebase la fiecare 2 minute
            if (db) {
                setInterval(sincronizareCuFirestore, 2 * 60 * 1000);
            }
            
            console.log('✅ GazTech Services s-a încărcat complet cu NOTIFICĂRI & PWA!');
            console.log('📊 Abonați:', abonati.length);
            console.log('📅 Programări:', programari.length);
            console.log('🔔 Remindere:', remindere.length);
            console.log('🔄 Sincronizare: ACTIVĂ');
            console.log('📎 Gestionare documente: COMPLETĂ');
            console.log('💾 Backup: DISPONIBIL');
            console.log('📱 Notificări expirări/plăți: ACTIVE');
            console.log('💬 WhatsApp: INTEGRAT');
            console.log('🔥 Firebase:', db ? 'CONECTAT' : 'OFFLINE');
            console.log('📱 PWA: Service Worker înregistrat');
            console.log('📞 Telefon firmă:', CONFIGURARI_FIRMA.telefon);
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Error captat și gestionat:', e.error);
            showNotification('A apărut o eroare, dar aplicația continuă să funcționeze.', 'warning');
        });
    </script>
</body>
</html>
