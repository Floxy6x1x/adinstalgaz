<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdInstalGaz - Sistem Management</title>
    
    <!-- ğŸ”¥ Firebase Dependencies v9+ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, limit, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9yoIQ__cK0zIPlvSRlu1h7O1MtmrfLXA",
            authDomain: "adinstalgaz-pwa.firebaseapp.com",
            projectId: "adinstalgaz-pwa",
            storageBucket: "adinstalgaz-pwa.firebasestorage.app",
            messagingSenderId: "623851795901",
            appId: "1:623851795901:web:63072fdef30693f4698ed4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.storage = storage;
        window.firebase = {
            firestore: {
                FieldValue: {
                    serverTimestamp: serverTimestamp
                }
            }
        };
        
        // Import Firebase functions for global use
        window.addDoc = addDoc;
        window.collection = collection;
        window.doc = doc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.limit = limit;
        window.serverTimestamp = serverTimestamp;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.setDoc = setDoc;
    </script>
    
    <!-- ğŸ“¦ Export Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .header h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .header .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .company-info {
            text-align: center;
            margin: 10px 0;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }
        
        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 400px;
            margin: 50px auto;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .tab-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #d68910);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #545b62);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .data-table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #e74c3c;
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .alert-success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .alert-error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tabs {
                justify-content: center;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .export-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ”§ AdInstalGaz SRL</h1>
            <p class="subtitle">Sistem de Management InstalaÈ›ii</p>
            <div class="company-info">
                ğŸ“ <strong>0762 614 401</strong> | ğŸ“§ <strong>office@adinstalgaz.ro</strong> | ğŸŒ <strong>adinstalgaz.ro</strong><br>
                ğŸ“ <strong>Str. MÄƒrÄƒÈ™eÈ™ti, Nr.97, RoÈ™iorii de Vede, Teleorman</strong>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userEmail"></span>
                <span id="userRole"></span>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Authentication Forms -->
        <div id="authContainer" class="auth-container">
            <!-- Login Form -->
            <div id="loginForm">
                <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">ğŸ” Autentificare</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="loginEmail">ğŸ“§ Email:</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">ğŸ”’ ParolÄƒ:</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">ConecteazÄƒ-te</button>
                </form>
                <p style="text-align: center; margin-top: 20px;">
                    Nu ai cont? <a href="#" onclick="showRegisterForm()" style="color: #3498db;">ÃnregistreazÄƒ-te</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">ğŸ“ Ãnregistrare</h2>
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label for="registerName">ğŸ‘¤ Nume complet:</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">ğŸ“§ Email:</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">ğŸ”’ ParolÄƒ:</label>
                        <input type="password" id="registerPassword" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">CreeazÄƒ cont</button>
                </form>
                <p style="text-align: center; margin-top: 20px;">
                    Ai deja cont? <a href="#" onclick="showLoginForm()" style="color: #3498db;">ConecteazÄƒ-te</a>
                </p>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" style="display: none;">
            <!-- Navigation Tabs -->
            <div class="tabs" id="navigationTabs">
                <!-- Tabs will be populated by JavaScript based on user role -->
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="tab-content">
                <h2>ğŸ“Š Dashboard</h2>
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be loaded by JavaScript -->
                </div>
                <div id="recentActivity">
                    <h3>ğŸ“ˆ Activitate RecentÄƒ</h3>
                    <div id="activityList" class="card">
                        <!-- Recent activity will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- ClienÈ›i Tab (Admin only) -->
            <div id="clienti" class="tab-content" style="display: none;">
                <h2>ğŸ‘¥ Gestionare ClienÈ›i</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showAddClientModal()">â• AdaugÄƒ Client</button>
                    <button class="btn btn-info" onclick="refreshClients()">ğŸ”„ ActualizeazÄƒ</button>
                </div>
                <div id="clientsList">
                    <table class="data-table" id="clientsTable">
                        <thead>
                            <tr>
                                <th>ğŸ‘¤ Client</th>
                                <th>ğŸ“ Telefon</th>
                                <th>ğŸ“§ Email</th>
                                <th>ğŸ  AdresÄƒ</th>
                                <th>ğŸ”§ Servicii Active</th>
                                <th>ğŸ“… ExpirÄƒri</th>
                                <th>âš¡ AcÈ›iuni</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <!-- Clients will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- LucrÄƒtori Tab (Admin only) -->
            <div id="lucratori" class="tab-content" style="display: none;">
                <h2>ğŸ‘¨â€ğŸ”§ Gestionare LucrÄƒtori</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showAddWorkerModal()">â• AdaugÄƒ LucrÄƒtor</button>
                    <button class="btn btn-info" onclick="refreshWorkers()">ğŸ”„ ActualizeazÄƒ</button>
                </div>
                <div id="workersList">
                    <table class="data-table" id="workersTable">
                        <thead>
                            <tr>
                                <th>ğŸ‘¤ Nume</th>
                                <th>ğŸ“§ Email</th>
                                <th>ğŸ“ Telefon</th>
                                <th>ğŸŒ ZonÄƒ</th>
                                <th>ğŸ“Š Status</th>
                                <th>âš¡ AcÈ›iuni</th>
                            </tr>
                        </thead>
                        <tbody id="workersTableBody">
                            <!-- Workers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- LucrÄƒrile Mele Tab (Worker only) -->
            <div id="lucrarile-mele" class="tab-content" style="display: none;">
                <h2>ğŸ”§ LucrÄƒrile Mele</h2>
                <div id="myWorksList">
                    <table class="data-table" id="myWorksTable">
                        <thead>
                            <tr>
                                <th>ğŸ‘¤ Client</th>
                                <th>ğŸ”§ Tip Lucrare</th>
                                <th>ğŸ“… Data AsignÄƒrii</th>
                                <th>ğŸ“Š Status</th>
                                <th>âš¡ AcÈ›iuni</th>
                            </tr>
                        </thead>
                        <tbody id="myWorksTableBody">
                            <!-- My works will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- LucrÄƒri Finalizate Tab (Worker only) -->
            <div id="finalizate" class="tab-content" style="display: none;">
                <h2>âœ… LucrÄƒri Finalizate</h2>
                <div id="completedWorksList">
                    <table class="data-table" id="completedWorksTable">
                        <thead>
                            <tr>
                                <th>ğŸ‘¤ Client</th>
                                <th>ğŸ”§ Tip Lucrare</th>
                                <th>ğŸ“… Data FinalizÄƒrii</th>
                                <th>â­ Evaluare</th>
                                <th>ğŸ“„ Documente</th>
                            </tr>
                        </thead>
                        <tbody id="completedWorksTableBody">
                            <!-- Completed works will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AsignÄƒri Tab (Admin only) -->
            <div id="asignari" class="tab-content" style="display: none;">
                <h2>ğŸ“‹ Asignare LucrÄƒri</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showAssignWorkModal()">â• AsigneazÄƒ Lucrare</button>
                </div>
                <div id="assignmentsList">
                    <table class="data-table" id="assignmentsTable">
                        <thead>
                            <tr>
                                <th>ğŸ‘¤ Client</th>
                                <th>ğŸ‘¨â€ğŸ”§ LucrÄƒtor</th>
                                <th>ğŸ”§ Tip Lucrare</th>
                                <th>ğŸ“… Data AsignÄƒrii</th>
                                <th>ğŸ“Š Status</th>
                                <th>âš¡ AcÈ›iuni</th>
                            </tr>
                        </thead>
                        <tbody id="assignmentsTableBody">
                            <!-- Assignments will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SMS Management Tab (Admin only) -->
            <div id="sms-management" class="tab-content" style="display: none;">
                <h2>ğŸ“± Gestionare SMS NotificÄƒri</h2>
                
                <!-- SMS Statistics -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-number" id="smsToday">0</div>
                        <div>ğŸ“¤ SMS Azi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="smsThisMonth">0</div>
                        <div>ğŸ“Š SMS Luna</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingReminders">0</div>
                        <div>â° Reminder-uri Pendinte</div>
                    </div>
                </div>

                <!-- Manual SMS -->
                <div class="card">
                    <h3>ğŸ“ Trimite SMS Manual</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="showSendSMSModal()">ğŸ“± Trimite SMS</button>
                        <button class="btn btn-info" onclick="showBulkSMSModal()">ğŸ“¢ SMS Ã®n masÄƒ</button>
                        <button class="btn btn-warning" onclick="checkExpiringServices()">âš ï¸ VerificÄƒ expirÄƒri</button>
                    </div>
                </div>

                <!-- SMS History -->
                <div class="card">
                    <h3>ğŸ“‹ Istoric SMS</h3>
                    <table class="data-table" id="smsHistoryTable">
                        <thead>
                            <tr>
                                <th>ğŸ“… Data</th>
                                <th>ğŸ‘¤ Client</th>
                                <th>ğŸ“ NumÄƒr</th>
                                <th>ğŸ“ Mesaj</th>
                                <th>ğŸ“Š Status</th>
                                <th>ğŸ’° Cost</th>
                            </tr>
                        </thead>
                        <tbody id="smsHistoryTableBody">
                            <!-- SMS history will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Upcoming Reminders -->
                <div class="card">
                    <h3>â° Reminder-uri Programate</h3>
                    <table class="data-table" id="remindersTable">
                        <thead>
                            <tr>
                                <th>ğŸ‘¤ Client</th>
                                <th>ğŸ”§ Serviciu</th>
                                <th>ğŸ“… Data Expirare</th>
                                <th>ğŸ“± SMS Program</th>
                                <th>âš¡ AcÈ›iuni</th>
                            </tr>
                        </thead>
                        <tbody id="remindersTableBody">
                            <!-- Reminders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Security & Logs Tab (Admin only) -->
            <div id="security" class="tab-content" style="display: none;">
                <h2>ğŸ”’ Securitate È™i Monitorizare</h2>
                
                <!-- Security Statistics -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-number" id="totalLogins">0</div>
                        <div>ğŸ” ConectÄƒri Azi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div>ğŸ‘¥ Utilizatori Activi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="failedAttempts">0</div>
                        <div>âŒ ÃncercÄƒri EÈ™uate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lastBackup">N/A</div>
                        <div>ğŸ’¾ Ultimul Backup</div>
                    </div>
                </div>

                <!-- Security Actions -->
                <div class="card">
                    <h3>ğŸ›¡ï¸ AcÈ›iuni de Securitate</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="createBackup()">ğŸ’¾ CreazÄƒ Backup Manual</button>
                        <button class="btn btn-info" onclick="downloadLogs()">ğŸ“¥ DescarcÄƒ Logs</button>
                        <button class="btn btn-warning" onclick="viewFailedLogins()">ğŸš¨ Vezi ConectÄƒri EÈ™uate</button>
                        <button class="btn btn-danger" onclick="resetSecuritySettings()">ğŸ”„ Reset SetÄƒri</button>
                    </div>
                </div>

                <!-- Activity Logs -->
                <div class="card">
                    <h3>ğŸ“‹ Istoric Activitate (Ultimele 50)</h3>
                    <div style="margin-bottom: 15px;">
                        <select id="logFilter" onchange="filterLogs()">
                            <option value="all">Toate activitÄƒÈ›ile</option>
                            <option value="auth">Autentificare</option>
                            <option value="client">ClienÈ›i</option>
                            <option value="worker">LucrÄƒtori</option>
                            <option value="sms">SMS</option>
                            <option value="error">Erori</option>
                        </select>
                        <button class="btn btn-info" onclick="refreshLogs()">ğŸ”„ ActualizeazÄƒ</button>
                    </div>
                    <table class="data-table" id="logsTable">
                        <thead>
                            <tr>
                                <th>ğŸ“… Data/Ora</th>
                                <th>ğŸ‘¤ Utilizator</th>
                                <th>ğŸ¯ AcÈ›iune</th>
                                <th>ğŸ“Š Tip</th>
                                <th>ğŸ“ Detalii</th>
                                <th>ğŸŒ IP</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <!-- Logs will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Data Validation Rules -->
                <div class="card">
                    <h3>âœ… Reguli de Validare Active</h3>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                        <h4>ğŸ“ Validarea Telefoanelor:</h4>
                        <ul>
                            <li>âœ… Format: 10 cifre (07xxxxxxxx)</li>
                            <li>âœ… Verificare duplicat Ã®n baza de date</li>
                            <li>âœ… Validare numÄƒr romÃ¢nesc</li>
                        </ul>
                        
                        <h4>ğŸ“§ Validarea Email-urilor:</h4>
                        <ul>
                            <li>âœ… Format email valid</li>
                            <li>âœ… Verificare duplicat pentru lucrÄƒtori</li>
                            <li>âœ… Domenii permise: toate</li>
                        </ul>
                        
                        <h4>ğŸ  Validarea Adreselor:</h4>
                        <ul>
                            <li>âœ… Doar oraÈ™e din Teleorman</li>
                            <li>âœ… Strada obligatorie</li>
                            <li>âœ… NumÄƒr obligatoriu</li>
                        </ul>
                        
                        <h4>ğŸ”§ Validarea Serviciilor:</h4>
                        <ul>
                            <li>âœ… Minimum un serviciu obligatoriu</li>
                            <li>âœ… Data de Ã®nceput validÄƒ</li>
                            <li>âœ… Preturi Ã®n intervalul corect</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Rapoarte Tab (Admin only) -->
            <div id="rapoarte" class="tab-content" style="display: none;">
                <h2>ğŸ“Š Rapoarte È™i Export</h2>
                
                <div class="card">
                    <h3>ğŸš€ Export Rapid</h3>
                    <div class="export-buttons">
                        <button class="btn btn-primary" onclick="quickExport.completePDF()">
                            ğŸ“„ Export PDF Complet
                        </button>
                        <button class="btn btn-success" onclick="quickExport.completeExcel()">
                            ğŸ“Š Export Excel Complet
                        </button>
                        <button class="btn btn-info" onclick="quickExport.monthlyPDF()">
                            ğŸ“… Raport Lunar PDF
                        </button>
                        <button class="btn btn-warning" onclick="quickExport.clientsPDF()">
                            ğŸ‘¥ Doar ClienÈ›i PDF
                        </button>
                        <button class="btn btn-secondary" onclick="quickExport.worksExcel()">
                            ğŸ”§ Doar LucrÄƒri Excel
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>ğŸ¯ Export Personalizat</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="startDate">ğŸ“… Data Ã®nceput:</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group">
                            <label for="endDate">ğŸ“… Data sfÃ¢rÈ™it:</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="form-group">
                            <label for="reportStatus">ğŸ“Š Status lucrÄƒri:</label>
                            <select id="reportStatus">
                                <option value="">Toate</option>
                                <option value="pending">Ãn aÈ™teptare</option>
                                <option value="in_progress">Ãn progres</option>
                                <option value="completed">Completate</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="generateCustomReport('pdf')">
                            ğŸ“„ GenereazÄƒ PDF
                        </button>
                        <button class="btn btn-success" onclick="generateCustomReport('excel')">
                            ğŸ“Š GenereazÄƒ Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Se Ã®ncarcÄƒ...</p>
        </div>

        <!-- Modals -->
        <!-- Add Client Modal -->
        <div id="addClientModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close" onclick="closeModal('addClientModal')">&times;</span>
                <h2>â• AdaugÄƒ Client Nou cu Servicii</h2>
                <form onsubmit="addClient(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- Date personale -->
                        <div class="form-group">
                            <label for="clientName">ğŸ‘¤ Nume:</label>
                            <input type="text" id="clientName" required>
                        </div>
                        <div class="form-group">
                            <label for="clientSurname">ğŸ‘¤ Prenume:</label>
                            <input type="text" id="clientSurname" required>
                        </div>
                        <div class="form-group">
                            <label for="clientPhone">ğŸ“ Telefon:</label>
                            <input type="tel" id="clientPhone" required pattern="[0-9]{10}">
                        </div>
                        <div class="form-group">
                            <label for="clientEmail">ğŸ“§ Email:</label>
                            <input type="email" id="clientEmail">
                        </div>
                    </div>

                    <!-- AdresÄƒ -->
                    <h4 style="margin: 20px 0 10px 0; color: #2c3e50;">ğŸ  AdresÄƒ</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="clientCity">ğŸ˜ï¸ OraÈ™ (doar Teleorman):</label>
                            <select id="clientCity" required>
                                <option value="">SelecteazÄƒ oraÈ™ul</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="clientStreet">ğŸ›£ï¸ Strada:</label>
                            <input type="text" id="clientStreet" required>
                        </div>
                        <div class="form-group">
                            <label for="clientNumber">ğŸ”¢ NumÄƒr:</label>
                            <input type="text" id="clientNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="clientBlock">ğŸ¢ Bloc:</label>
                            <input type="text" id="clientBlock">
                        </div>
                        <div class="form-group">
                            <label for="clientStaircase">ğŸƒ ScarÄƒ:</label>
                            <input type="text" id="clientStaircase">
                        </div>
                        <div class="form-group">
                            <label for="clientFloor">ğŸ”¼ Etaj:</label>
                            <input type="text" id="clientFloor">
                        </div>
                        <div class="form-group">
                            <label for="clientApartment">ğŸšª Apartament:</label>
                            <input type="text" id="clientApartment">
                        </div>
                    </div>

                    <!-- Servicii -->
                    <h4 style="margin: 20px 0 10px 0; color: #2c3e50;">ğŸ”§ Servicii Contractate</h4>
                    <div class="form-group">
                        <label for="selectedServices">SelecteazÄƒ serviciile:</label>
                        <div id="servicesCheckboxes" style="border: 2px solid #ecf0f1; border-radius: 8px; padding: 15px; max-height: 200px; overflow-y: auto;">
                            <!-- Serviciile vor fi generate dinamic -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="servicesStartDate">ğŸ“… Data Ã®nceput servicii:</label>
                        <input type="date" id="servicesStartDate" required>
                    </div>

                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <small><strong>â„¹ï¸ InformaÈ›ii:</strong> Toate serviciile selectate vor fi valabile 2 ani de la data de Ã®nceput. 
                        SMS-urile de notificare se vor trimite automat cu 7 zile È™i 1 zi Ã®nainte de expirare.</small>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">AdaugÄƒ Client cu Servicii</button>
                </form>
            </div>
        </div>

        <!-- Add Worker Modal -->
        <div id="addWorkerModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('addWorkerModal')">&times;</span>
                <h2>â• AdaugÄƒ LucrÄƒtor Nou</h2>
                <form onsubmit="addWorker(event)">
                    <div class="form-group">
                        <label for="workerName">ğŸ‘¤ Nume:</label>
                        <input type="text" id="workerName" required>
                    </div>
                    <div class="form-group">
                        <label for="workerEmail">ğŸ“§ Email:</label>
                        <input type="email" id="workerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="workerPhone">ğŸ“ Telefon:</label>
                        <input type="tel" id="workerPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="workerZone">ğŸŒ ZonÄƒ:</label>
                        <select id="workerZone" required>
                            <option value="">SelecteazÄƒ zona</option>
                            <option value="Bucuresti">BucureÈ™ti</option>
                            <option value="Cluj">Cluj</option>
                            <option value="Timisoara">TimiÈ™oara</option>
                            <option value="Constanta">ConstanÈ›a</option>
                            <option value="Brasov">BraÈ™ov</option>
                            <option value="Iasi">IaÈ™i</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">AdaugÄƒ LucrÄƒtor</button>
                </form>
            </div>
        </div>

        <!-- Assign Work Modal -->
        <div id="assignWorkModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('assignWorkModal')">&times;</span>
                <h2>ğŸ“‹ AsigneazÄƒ Lucrare</h2>
                <form onsubmit="assignWork(event)">
                    <div class="form-group">
                        <label for="assignClient">ğŸ‘¤ Client:</label>
                        <select id="assignClient" required>
                            <option value="">SelecteazÄƒ clientul</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assignWorker">ğŸ‘¨â€ğŸ”§ LucrÄƒtor:</label>
                        <select id="assignWorker" required>
                            <option value="">SelecteazÄƒ lucrÄƒtorul</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="workType">ğŸ”§ Tip Lucrare:</label>
                        <select id="workType" required>
                            <option value="">SelecteazÄƒ tipul</option>
                            <option value="instalare_gaz">Instalare Gaz</option>
                            <option value="reparatie_gaz">ReparaÈ›ie Gaz</option>
                            <option value="verificare_gaz">Verificare Gaz</option>
                            <option value="instalare_termica">Instalare TermicÄƒ</option>
                            <option value="reparatie_termica">ReparaÈ›ie TermicÄƒ</option>
                            <option value="mentenanta">MentenanÈ›Äƒ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="workDescription">ğŸ“ Descriere:</label>
                        <textarea id="workDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="workPriority">âš¡ Prioritate:</label>
                        <select id="workPriority" required>
                            <option value="normal">NormalÄƒ</option>
                            <option value="urgent">UrgentÄƒ</option>
                            <option value="critical">CriticÄƒ</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">AsigneazÄƒ Lucrarea</button>
                </form>
            </div>
        </div>

        <!-- Send SMS Modal -->
        <div id="sendSMSModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('sendSMSModal')">&times;</span>
                <h2>ğŸ“± Trimite SMS</h2>
                <form onsubmit="sendManualSMS(event)">
                    <div class="form-group">
                        <label for="smsClient">ğŸ‘¤ Client:</label>
                        <select id="smsClient" required>
                            <option value="">SelecteazÄƒ clientul</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="smsPhone">ğŸ“ NumÄƒr telefon:</label>
                        <input type="tel" id="smsPhone" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="smsTemplate">ğŸ“ Template mesaj:</label>
                        <select id="smsTemplate" onchange="loadSMSTemplate()">
                            <option value="">Mesaj personalizat</option>
                            <option value="reminder_7">Reminder 7 zile</option>
                            <option value="reminder_1">Reminder 1 zi</option>
                            <option value="renewed">Serviciu reÃ®nnoit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="smsMessage">ğŸ’¬ Mesaj:</label>
                        <textarea id="smsMessage" rows="4" maxlength="160" required></textarea>
                        <small>Caractere rÄƒmase: <span id="smsCharCount">160</span>/160</small>
                    </div>
                    <button type="submit" class="btn btn-primary">ğŸ“¤ Trimite SMS</button>
                </form>
            </div>
        </div>

        <!-- Bulk SMS Modal -->
        <div id="bulkSMSModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('bulkSMSModal')">&times;</span>
                <h2>ğŸ“¢ SMS Ã®n MasÄƒ</h2>
                <form onsubmit="sendBulkSMS(event)">
                    <div class="form-group">
                        <label for="bulkSMSFilter">ğŸ¯ FiltreazÄƒ clienÈ›ii:</label>
                        <select id="bulkSMSFilter" onchange="updateBulkSMSList()">
                            <option value="all">ToÈ›i clienÈ›ii</option>
                            <option value="expiring_7">Servicii care expirÄƒ Ã®n 7 zile</option>
                            <option value="expiring_1">Servicii care expirÄƒ mÃ¢ine</option>
                            <option value="city">DupÄƒ oraÈ™</option>
                        </select>
                    </div>
                    <div class="form-group" id="cityFilterDiv" style="display: none;">
                        <label for="bulkSMSCity">ğŸ˜ï¸ OraÈ™:</label>
                        <select id="bulkSMSCity">
                            <option value="">SelecteazÄƒ oraÈ™ul</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸ‘¥ ClienÈ›i selectaÈ›i:</label>
                        <div id="bulkSMSList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                            <!-- Lista va fi populatÄƒ dinamic -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bulkSMSMessage">ğŸ’¬ Mesaj:</label>
                        <textarea id="bulkSMSMessage" rows="4" maxlength="160" required></textarea>
                        <small>Caractere rÄƒmase: <span id="bulkSMSCharCount">160</span>/160</small>
                    </div>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <small><strong>âš ï¸ AtenÈ›ie:</strong> AceastÄƒ acÈ›iune va trimite SMS la <span id="bulkSMSCount">0</span> clienÈ›i. 
                        Cost estimat: <span id="bulkSMSCost">0</span> RON</small>
                    </div>
                    <button type="submit" class="btn btn-warning">ğŸ“¢ Trimite la toÈ›i</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background: rgba(44, 62, 80, 0.9); color: white; text-align: center; padding: 20px; margin-top: 40px;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <h3 style="margin-bottom: 10px;">ğŸ”§ AdInstalGaz SRL</h3>
            <p style="margin: 5px 0;">ğŸ“ <strong>0762 614 401</strong> | ğŸ“§ <strong>office@adinstalgaz.ro</strong> | ğŸŒ <strong>adinstalgaz.ro</strong></p>
            <p style="margin: 5px 0; font-size: 0.9em;">ğŸ“ Str. MÄƒrÄƒÈ™eÈ™ti, Nr.97, RoÈ™iorii de Vede, Teleorman</p>
            <p style="margin-top: 15px; font-size: 0.8em; opacity: 0.8;">Â© 2025 AdInstalGaz SRL - InstalaÈ›ii de gaz È™i termice</p>
        </div>
    </footer>

    <script>
        // Global variables
        let currentUser = null;
        let userRole = null;
        let workerId = null;

        // ğŸ¢ DATELE FIRMEI
        const companyInfo = {
            name: 'AdInstalGaz SRL',
            address: 'Str. MÄƒrÄƒÈ™eÈ™ti, Nr.97, RoÈ™iorii de Vede, Teleorman',
            phone: '0762 614 401',
            email: 'office@adinstalgaz.ro',
            website: 'adinstalgaz.ro',
            
            // FuncÈ›ie pentru formatarea completÄƒ
            getFullInfo: function() {
                return `${this.name}\nğŸ“ ${this.phone}\nğŸ“§ ${this.email}\nğŸŒ ${this.website}\nğŸ“ ${this.address}`;
            },
            
            // Pentru utilizare Ã®n SMS-uri
            getContactInfo: function() {
                return `${this.phone} | ${this.website}`;
            }
        };

        // ğŸ˜ï¸ ORAÈ˜E TELEORMAN
        const teleormanCities = [
            'RoÈ™iorii de Vede',
            'Alexandria', 
            'Videle',
            'Zimnicea',
            'Turnu MÄƒgurele'
        ];

        // ğŸ”§ SERVICII DISPONIBILE
        const services = {
            'verificare_gaz': {
                name: 'Verificare InstalaÈ›ie Gaz',
                price: 150,
                duration: 24, // luni
                description: 'Verificare tehnicÄƒ instalaÈ›ie gaz'
            },
            'revizie_gaz': {
                name: 'Revizie InstalaÈ›ie Gaz', 
                price: 250,
                duration: 24,
                description: 'Revizie completÄƒ instalaÈ›ie gaz'
            },
            'verificare_centrala': {
                name: 'Verificare CentralÄƒ',
                price: 150, 
                duration: 24,
                description: 'Verificare tehnicÄƒ centralÄƒ termicÄƒ'
            },
            'oferta_completa': {
                name: 'OFERTÄ‚: InstalaÈ›ii Gaz + CentralÄƒ',
                price: 250,
                duration: 24,
                description: 'Pachet complet instalaÈ›ii gaz È™i centralÄƒ'
            },
            'urgenta': {
                name: 'Servicii de UrgenÈ›Äƒ',
                price: 0, // Se seteazÄƒ manual
                duration: 24,
                description: 'IntervenÈ›ii de urgenÈ›Äƒ'
            }
        };

        // ğŸ“± SMS TEMPLATES
        const smsTemplates = {
            reminder_7_days: function(clientName, serviceName, expiryDate) {
                return `Buna ziua, ${clientName}! Serviciul "${serviceName}" va expira pe ${expiryDate}. Pentru reinnoire contactati ${companyInfo.phone}. AdInstalGaz`;
            },
            reminder_1_day: function(clientName, serviceName, expiryDate) {
                return `URGENT! ${clientName}, serviciul "${serviceName}" expira MAINE (${expiryDate})! Contactati ${companyInfo.phone}. AdInstalGaz`;
            },
            service_renewed: function(clientName, serviceName, newExpiryDate) {
                return `${clientName}, serviciul "${serviceName}" a fost reinnoit pana la ${newExpiryDate}. Multumim! AdInstalGaz ${companyInfo.phone}`;
            }
        };

        // ğŸ” FUNCÈšII DE ÃNREGISTRARE AUTOMATÄ‚
        const handleRegistration = async (name, email, password) => {
            try {
                console.log('ğŸ”„ Ãncepe Ã®nregistrarea pentru:', email);
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                
                console.log('âœ… Cont Auth creat:', userId);
                
                const workersQuery = query(collection(db, 'workers'), where('email', '==', email));
                const workerSnapshot = await getDocs(workersQuery);
                
                let userData = {
                    name: name,
                    email: email,
                    createdAt: serverTimestamp()
                };
                
                if (!workerSnapshot.empty) {
                    const workerDoc = workerSnapshot.docs[0];
                    userData.role = 'worker';
                    userData.workerId = workerDoc.id;
                    
                    console.log('ğŸ‘¨â€ğŸ”§ Utilizator detectat ca LUCRÄ‚TOR:', workerDoc.id);
                    
                    await updateDoc(doc(db, 'workers', workerDoc.id), {
                        userId: userId,
                        registeredAt: serverTimestamp()
                    });
                    
                } else {
                    userData.role = 'admin';
                    console.log('ğŸ‘¤ Utilizator Ã®nregistrat ca ADMIN');
                }
                
                await setDoc(doc(db, 'users', userId), userData);
                
                console.log('âœ… Ãnregistrare completÄƒ cu rolul:', userData.role);
                
                return {
                    success: true,
                    role: userData.role,
                    message: userData.role === 'worker' ? 
                        'Cont lucrÄƒtor creat cu succes!' : 
                        'Cont admin creat cu succes!'
                };
                
            } catch (error) {
                console.error('âŒ Eroare Ã®nregistrare:', error);
                
                let errorMessage = 'Eroare la Ã®nregistrare';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Acest email este deja folosit';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Parola trebuie sÄƒ aibÄƒ cel puÈ›in 6 caractere';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email invalid';
                }
                
                return {
                    success: false,
                    message: errorMessage
                };
            }
        };

        // ğŸ”’ SECURITY & LOGGING SYSTEM
        
        // FuncÈ›ii de validare avansatÄƒ
        const validation = {
            // ValideazÄƒ numÄƒrul de telefon romÃ¢nesc
            phone: function(phone) {
                const phoneRegex = /^07[0-9]{8}$/;
                if (!phoneRegex.test(phone)) {
                    return { valid: false, message: 'NumÄƒrul de telefon trebuie sÄƒ aibÄƒ formatul 07xxxxxxxx (10 cifre)' };
                }
                return { valid: true };
            },
            
            // ValideazÄƒ email-ul
            email: function(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    return { valid: false, message: 'Formatul email-ului nu este valid' };
                }
                return { valid: true };
            },
            
            // ValideazÄƒ numele (minim 2 caractere, doar litere È™i spaÈ›ii)
            name: function(name) {
                const nameRegex = /^[a-zA-ZÄƒÃ¢Ã®È™È›Ä‚Ã‚ÃÈ˜Èš\s]{2,50}$/;
                if (!nameRegex.test(name)) {
                    return { valid: false, message: 'Numele trebuie sÄƒ conÈ›inÄƒ doar litere È™i sÄƒ aibÄƒ minim 2 caractere' };
                }
                return { valid: true };
            },
            
            // ValideazÄƒ oraÈ™ul (doar din Teleorman)
            city: function(city) {
                if (!teleormanCities.includes(city)) {
                    return { valid: false, message: 'OraÈ™ul trebuie sÄƒ fie din judeÈ›ul Teleorman' };
                }
                return { valid: true };
            },
            
            // ValideazÄƒ serviciile (minim unul selectat)
            services: function(services) {
                if (!services || services.length === 0) {
                    return { valid: false, message: 'Trebuie sÄƒ selectaÈ›i cel puÈ›in un serviciu' };
                }
                return { valid: true };
            }
        };

        // Sistem de loguri
        const logger = {
            // ÃnregistreazÄƒ o activitate
            log: async function(action, type, details = '', targetId = '') {
                try {
                    const logData = {
                        timestamp: serverTimestamp(),
                        userId: currentUser?.uid || 'anonymous',
                        userEmail: currentUser?.email || 'unknown',
                        userRole: userRole || 'unknown',
                        action: action,
                        type: type, // 'auth', 'client', 'worker', 'sms', 'error', 'security'
                        details: details,
                        targetId: targetId,
                        userAgent: navigator.userAgent,
                        ip: await this.getIP()
                    };
                    
                    await addDoc(collection(db, 'activity_logs'), logData);
                    console.log('ğŸ“ Log Ã®nregistrat:', action);
                    
                } catch (error) {
                    console.error('âŒ Eroare la Ã®nregistrarea log-ului:', error);
                }
            },
            
            // ObÈ›ine IP-ul utilizatorului
            getIP: async function() {
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    return data.ip;
                } catch (error) {
                    return 'unknown';
                }
            },
            
            // ÃnregistreazÄƒ o conectare eÈ™uatÄƒ
            logFailedLogin: async function(email, reason) {
                await this.log(`Failed login attempt for ${email}`, 'auth', reason);
            },
            
            // ÃnregistreazÄƒ o conectare reuÈ™itÄƒ
            logSuccessfulLogin: async function(email) {
                await this.log(`Successful login for ${email}`, 'auth', 'Login successful');
            },
            
            // ÃnregistreazÄƒ adÄƒugarea unui client
            logClientAdded: async function(clientId, clientName) {
                await this.log(`Client added: ${clientName}`, 'client', `New client created`, clientId);
            },
            
            // ÃnregistreazÄƒ È™tergerea unui client
            logClientDeleted: async function(clientId, clientName) {
                await this.log(`Client deleted: ${clientName}`, 'client', `Client removed from system`, clientId);
            },
            
            // ÃnregistreazÄƒ trimiterea unui SMS
            logSMSSent: async function(phone, message, success) {
                const status = success ? 'SMS sent successfully' : 'SMS failed to send';
                await this.log(`SMS to ${phone}`, 'sms', `${status}: ${message.substring(0, 50)}...`);
            }
        };

        // Sistem de backup automat
        const backup = {
            // CreeazÄƒ un backup manual
            create: async function() {
                try {
                    showLoading(true);
                    console.log('ğŸ’¾ Ãncepe crearea backup-ului...');
                    
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        createdBy: currentUser.uid,
                        data: {}
                    };
                    
                    // Backup clienÈ›i
                    const clientsSnapshot = await getDocs(collection(db, 'clients'));
                    backupData.data.clients = clientsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Backup lucrÄƒtori
                    const workersSnapshot = await getDocs(collection(db, 'workers'));
                    backupData.data.workers = workersSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Backup utilizatori
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    backupData.data.users = usersSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Backup lucrÄƒri
                    const worksSnapshot = await getDocs(collection(db, 'lucrari'));
                    backupData.data.works = worksSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // SalveazÄƒ backup-ul
                    const backupRef = await addDoc(collection(db, 'backups'), backupData);
                    
                    // DescarcÄƒ backup-ul local
                    const filename = `backup_adinstalgaz_${new Date().toISOString().split('T')[0]}.json`;
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    await logger.log('Manual backup created', 'security', `Backup ID: ${backupRef.id}`);
                    
                    alert(`âœ… Backup creat cu succes!\nğŸ“ FiÈ™ier: ${filename}\nğŸ“Š ClienÈ›i: ${backupData.data.clients.length}\nğŸ‘¨â€ğŸ”§ LucrÄƒtori: ${backupData.data.workers.length}`);
                    
                    showLoading(false);
                    
                } catch (error) {
                    console.error('âŒ Eroare la crearea backup-ului:', error);
                    alert('Eroare la crearea backup-ului: ' + error.message);
                    showLoading(false);
                }
            },
            
            // ProgrameazÄƒ backup automat (ruleazÄƒ zilnic)
            scheduleAutoBackup: function() {
                setInterval(async () => {
                    const now = new Date();
                    // RuleazÄƒ backup la ora 2:00 AM
                    if (now.getHours() === 2 && now.getMinutes() === 0) {
                        console.log('ğŸ”„ Backup automat programat...');
                        await this.create();
                    }
                }, 60000); // VerificÄƒ Ã®n fiecare minut
            }
        };

        // ğŸ“¦ FUNCÈšII DE EXPORT (din artifact-ul anterior)
        const collectReportData = async (filters = {}) => {
            try {
                console.log('ğŸ“Š Colectez date pentru raport...');
                
                let clientsQuery = collection(db, 'clients');
                
                if (filters.startDate) {
                    clientsQuery = query(clientsQuery, where('createdAt', '>=', filters.startDate));
                }
                if (filters.endDate) {
                    clientsQuery = query(clientsQuery, where('createdAt', '<=', filters.endDate));
                }
                
                const clientsSnapshot = await getDocs(clientsQuery);
                const clients = clientsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    createdAt: doc.data().createdAt?.toDate ? doc.data().createdAt.toDate() : new Date()
                }));
                
                let worksQuery = collection(db, 'lucrari');
                
                if (filters.startDate) {
                    worksQuery = query(worksQuery, where('createdAt', '>=', filters.startDate));
                }
                if (filters.endDate) {
                    worksQuery = query(worksQuery, where('createdAt', '<=', filters.endDate));
                }
                if (filters.status) {
                    worksQuery = query(worksQuery, where('status', '==', filters.status));
                }
                if (filters.workerId) {
                    worksQuery = query(worksQuery, where('assignedTo', '==', filters.workerId));
                }
                
                const worksSnapshot = await getDocs(worksQuery);
                const works = worksSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    createdAt: doc.data().createdAt?.toDate ? doc.data().createdAt.toDate() : new Date(),
                    completedAt: doc.data().completedAt?.toDate ? doc.data().completedAt.toDate() : null
                }));
                
                const workersSnapshot = await getDocs(collection(db, 'workers'));
                const workers = workersSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log(`âœ… Date colectate: ${clients.length} clienÈ›i, ${works.length} lucrÄƒri, ${workers.length} lucrÄƒtori`);
                
                return {
                    clients,
                    works,
                    workers,
                    summary: {
                        totalClients: clients.length,
                        totalWorks: works.length,
                        completedWorks: works.filter(w => w.status === 'completed').length,
                        pendingWorks: works.filter(w => w.status === 'pending').length,
                        inProgressWorks: works.filter(w => w.status === 'in_progress').length
                    }
                };
                
            } catch (error) {
                console.error('âŒ Eroare colectare date:', error);
                throw error;
            }
        };

        const exportToPDF = async (data, reportType = 'complete') => {
            try {
                console.log('ğŸ“„ Generez raport PDF...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.setTextColor(44, 62, 80);
                doc.text('AdInstalGaz SRL', 20, 20);
                
                doc.setFontSize(10);
                doc.setTextColor(127, 140, 141);
                doc.text('ğŸ“ 0762 614 401 | ğŸ“§ office@adinstalgaz.ro | ğŸŒ adinstalgaz.ro', 20, 28);
                doc.text('ğŸ“ Str. MÄƒrÄƒÈ™eÈ™ti, Nr.97, RoÈ™iorii de Vede, Teleorman', 20, 34);
                
                doc.setFontSize(12);
                doc.text('Raport Activitate', 20, 44);
                doc.text(`Data generÄƒrii: ${new Date().toLocaleDateString('ro-RO')}`, 20, 51);
                
                let yPos = 65;
                
                doc.setFontSize(16);
                doc.setTextColor(52, 73, 94);
                doc.text('ğŸ“Š Sumar General', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text(`Total clienÈ›i: ${data.summary.totalClients}`, 25, yPos);
                doc.text(`Total lucrÄƒri: ${data.summary.totalWorks}`, 25, yPos + 7);
                doc.text(`LucrÄƒri completate: ${data.summary.completedWorks}`, 25, yPos + 14);
                doc.text(`LucrÄƒri Ã®n progres: ${data.summary.inProgressWorks}`, 25, yPos + 21);
                doc.text(`LucrÄƒri Ã®n aÈ™teptare: ${data.summary.pendingWorks}`, 25, yPos + 28);
                
                yPos += 45;
                
                if (reportType === 'complete' || reportType === 'clients') {
                    doc.setFontSize(14);
                    doc.setTextColor(52, 73, 94);
                    doc.text('ğŸ‘¥ ClienÈ›i', 20, yPos);
                    yPos += 5;
                    
                    const clientsTableData = data.clients.map(client => [
                        client.name || 'N/A',
                        client.phone || 'N/A',
                        client.address || 'N/A',
                        client.createdAt ? client.createdAt.toLocaleDateString('ro-RO') : 'N/A'
                    ]);
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Nume Client', 'Telefon', 'AdresÄƒ', 'Data AdÄƒugÄƒrii']],
                        body: clientsTableData,
                        theme: 'striped',
                        headStyles: { fillColor: [52, 73, 94] },
                        margin: { left: 20, right: 20 }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 15;
                }
                
                if (reportType === 'complete' || reportType === 'works') {
                    if (yPos > 220) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(52, 73, 94);
                    doc.text('ğŸ”§ LucrÄƒri', 20, yPos);
                    yPos += 5;
                    
                    const worksTableData = data.works.map(work => {
                        const client = data.clients.find(c => c.id === work.clientId);
                        const worker = data.workers.find(w => w.id === work.assignedTo);
                        
                        return [
                            client?.name || 'Client necunoscut',
                            work.workType || 'N/A',
                            worker?.name || 'Neasignat',
                            work.status === 'completed' ? 'âœ… CompletatÄƒ' : 
                            work.status === 'in_progress' ? 'ğŸ”„ Ãn progres' : 'â³ Ãn aÈ™teptare',
                            work.createdAt ? work.createdAt.toLocaleDateString('ro-RO') : 'N/A'
                        ];
                    });
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Client', 'Tip Lucrare', 'LucrÄƒtor', 'Status', 'Data CreÄƒrii']],
                        body: worksTableData,
                        theme: 'striped',
                        headStyles: { fillColor: [52, 73, 94] },
                        margin: { left: 20, right: 20 }
                    });
                }
                
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(127, 140, 141);
                    doc.text(`Pagina ${i} din ${pageCount}`, 20, 285);
                    doc.text('AdInstalGaz SRL - ğŸ“ 0762 614 401 - office@adinstalgaz.ro', 120, 285);
                }
                
                const filename = `Raport_AdInstalGaz_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                
                console.log('âœ… PDF generat cu succes:', filename);
                return { success: true, filename };
                
            } catch (error) {
                console.error('âŒ Eroare generare PDF:', error);
                return { success: false, error: error.message };
            }
        };

        const exportToExcel = async (data, reportType = 'complete') => {
            try {
                console.log('ğŸ“Š Generez raport Excel...');
                
                const workbook = XLSX.utils.book_new();
                
                const summaryData = [
                    ['ADINSTALGAZ SRL', '', '', ''],
                    ['ğŸ“ 0762 614 401 | ğŸ“§ office@adinstalgaz.ro', '', '', ''],
                    ['ğŸ“ Str. MÄƒrÄƒÈ™eÈ™ti, Nr.97, RoÈ™iorii de Vede, Teleorman', '', '', ''],
                    ['Data generÄƒrii:', new Date().toLocaleDateString('ro-RO'), '', ''],
                    ['', '', '', ''],
                    ['SUMAR GENERAL', '', '', ''],
                    ['Total clienÈ›i:', data.summary.totalClients, '', ''],
                    ['Total lucrÄƒri:', data.summary.totalWorks, '', ''],
                    ['LucrÄƒri completate:', data.summary.completedWorks, '', ''],
                    ['LucrÄƒri Ã®n progres:', data.summary.inProgressWorks, '', ''],
                    ['LucrÄƒri Ã®n aÈ™teptare:', data.summary.pendingWorks, '', ''],
                ];
                
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(workbook, summarySheet, 'Sumar');
                
                if (reportType === 'complete' || reportType === 'clients') {
                    const clientsData = [
                        ['Nume Client', 'Telefon', 'Email', 'AdresÄƒ', 'Data AdÄƒugÄƒrii', 'Nr. LucrÄƒri']
                    ];
                    
                    data.clients.forEach(client => {
                        const clientWorks = data.works.filter(w => w.clientId === client.id).length;
                        clientsData.push([
                            client.name || 'N/A',
                            client.phone || 'N/A',
                            client.email || 'N/A',
                            client.address || 'N/A',
                            client.createdAt ? client.createdAt.toLocaleDateString('ro-RO') : 'N/A',
                            clientWorks
                        ]);
                    });
                    
                    const clientsSheet = XLSX.utils.aoa_to_sheet(clientsData);
                    clientsSheet['!cols'] = [
                        { wch: 20 }, { wch: 15 }, { wch: 25 }, { wch: 30 }, { wch: 15 }, { wch: 12 }
                    ];
                    XLSX.utils.book_append_sheet(workbook, clientsSheet, 'ClienÈ›i');
                }
                
                if (reportType === 'complete' || reportType === 'works') {
                    const worksData = [
                        ['Client', 'Tip Lucrare', 'LucrÄƒtor Asignat', 'Status', 'Data CreÄƒrii', 'Data FinalizÄƒrii', 'ObservaÈ›ii']
                    ];
                    
                    data.works.forEach(work => {
                        const client = data.clients.find(c => c.id === work.clientId);
                        const worker = data.workers.find(w => w.id === work.assignedTo);
                        
                        worksData.push([
                            client?.name || 'Client necunoscut',
                            work.workType || 'N/A',
                            worker?.name || 'Neasignat',
                            work.status === 'completed' ? 'CompletatÄƒ' : 
                            work.status === 'in_progress' ? 'Ãn progres' : 'Ãn aÈ™teptare',
                            work.createdAt ? work.createdAt.toLocaleDateString('ro-RO') : 'N/A',
                            work.completedAt ? work.completedAt.toLocaleDateString('ro-RO') : 'N/A',
                            work.notes || ''
                        ]);
                    });
                    
                    const worksSheet = XLSX.utils.aoa_to_sheet(worksData);
                    worksSheet['!cols'] = [
                        { wch: 20 }, { wch: 15 }, { wch: 18 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 25 }
                    ];
                    XLSX.utils.book_append_sheet(workbook, worksSheet, 'LucrÄƒri');
                }
                
                const workersData = [
                    ['Nume LucrÄƒtor', 'Email', 'Telefon', 'ZonÄƒ', 'Total LucrÄƒri', 'Completate', 'Ãn Progres', 'Rata Succes']
                ];
                
                data.workers.forEach(worker => {
                    const workerTasks = data.works.filter(w => w.assignedTo === worker.id);
                    const completedTasks = workerTasks.filter(w => w.status === 'completed');
                    const inProgressTasks = workerTasks.filter(w => w.status === 'in_progress');
                    const successRate = workerTasks.length > 0 ? 
                        ((completedTasks.length / workerTasks.length) * 100).toFixed(1) + '%' : '0%';
                    
                    workersData.push([
                        worker.name || 'N/A',
                        worker.email || 'N/A',
                        worker.phone || 'N/A',
                        worker.zone || 'N/A',
                        workerTasks.length,
                        completedTasks.length,
                        inProgressTasks.length,
                        successRate
                    ]);
                });
                
                const workersSheet = XLSX.utils.aoa_to_sheet(workersData);
                workersSheet['!cols'] = [
                    { wch: 18 }, { wch: 25 }, { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }
                ];
                XLSX.utils.book_append_sheet(workbook, workersSheet, 'PerformanÈ›Äƒ LucrÄƒtori');
                
                const filename = `Raport_AdInstalGaz_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, filename);
                
                console.log('âœ… Excel generat cu succes:', filename);
                return { success: true, filename };
                
            } catch (error) {
                console.error('âŒ Eroare generare Excel:', error);
                return { success: false, error: error.message };
            }
        };

        const generateReport = async (filters = {}, format = 'pdf', reportType = 'complete') => {
            try {
                console.log(`ğŸ¯ Generez raport ${format.toUpperCase()} - tip: ${reportType}`);
                
                const data = await collectReportData(filters);
                
                let result;
                if (format === 'pdf') {
                    result = await exportToPDF(data, reportType);
                } else if (format === 'excel' || format === 'xlsx') {
                    result = await exportToExcel(data, reportType);
                } else {
                    throw new Error('Format nesuportat. FoloseÈ™te "pdf" sau "excel"');
                }
                
                return result;
                
            } catch (error) {
                console.error('âŒ Eroare generare raport:', error);
                return { success: false, error: error.message };
            }
        };

        const quickExport = {
            completePDF: () => generateReport({}, 'pdf', 'complete'),
            completeExcel: () => generateReport({}, 'excel', 'complete'),
            clientsPDF: () => generateReport({}, 'pdf', 'clients'),
            clientsExcel: () => generateReport({}, 'excel', 'clients'),
            worksPDF: () => generateReport({}, 'pdf', 'works'),
            worksExcel: () => generateReport({}, 'excel', 'works'),
            monthlyPDF: () => {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
                return generateReport({ startDate, endDate }, 'pdf', 'complete');
            },
            workerReport: (workerId) => generateReport({ workerId }, 'excel', 'works')
        };

        // ğŸ¯ Authentication Functions - Cu logging
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                showLoading(true);
                
                // ValideazÄƒ email-ul
                const emailValidation = validation.email(email);
                if (!emailValidation.valid) {
                    await logger.logFailedLogin(email, 'Invalid email format');
                    alert('âŒ ' + emailValidation.message);
                    showLoading(false);
                    return;
                }
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                await logger.logSuccessfulLogin(email);
                console.log('âœ… Login successful');
                
            } catch (error) {
                console.error('âŒ Login error:', error);
                
                let errorMessage = 'Eroare la conectare';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Nu existÄƒ un cont cu acest email';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'ParolÄƒ incorectÄƒ';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Prea multe Ã®ncercÄƒri eÈ™uate. ÃncearcaÈ›i mai tÃ¢rziu';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'Acest cont a fost dezactivat';
                }
                
                await logger.logFailedLogin(email, errorMessage);
                alert('âŒ ' + errorMessage);
            } finally {
                showLoading(false);
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                showLoading(true);
                
                // ValidÄƒri
                const nameValidation = validation.name(name);
                if (!nameValidation.valid) {
                    alert('âŒ ' + nameValidation.message);
                    showLoading(false);
                    return;
                }
                
                const emailValidation = validation.email(email);
                if (!emailValidation.valid) {
                    alert('âŒ ' + emailValidation.message);
                    showLoading(false);
                    return;
                }
                
                if (password.length < 6) {
                    alert('âŒ Parola trebuie sÄƒ aibÄƒ cel puÈ›in 6 caractere');
                    showLoading(false);
                    return;
                }
                
                const result = await handleRegistration(name, email, password);
                
                if (result.success) {
                    await logger.log(`New account registered: ${email}`, 'auth', `Role: ${result.role}`);
                    alert('âœ… ' + result.message);
                } else {
                    await logger.log(`Registration failed: ${email}`, 'error', result.message);
                    alert('âŒ ' + result.message);
                }
                
            } catch (error) {
                console.error('âŒ Register error:', error);
                await logger.log(`Registration error: ${email}`, 'error', error.message);
                alert('Eroare la Ã®nregistrare: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        async function logout() {
            try {
                await logger.log(`User logout: ${currentUser?.email}`, 'auth', 'User signed out');
                await signOut(auth);
            } catch (error) {
                console.error('âŒ Logout error:', error);
            }
        }

        // ğŸ¯ UI Functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.style.display = 'none');
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).style.display = 'block';
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load tab-specific data
            loadTabData(tabName);
        }

        function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'clienti':
                    loadClients();
                    break;
                case 'lucratori':
                    loadWorkers();
                    break;
                case 'lucrarile-mele':
                    loadMyWorks();
                    break;
                case 'finalizate':
                    loadCompletedWorks();
                    break;
                case 'asignari':
                    loadAssignments();
                    break;
                case 'sms-management':
                    loadSMSManagement();
                    break;
                case 'security':
                    loadSecurityDashboard();
                    break;
            }
        }

        function createNavigationTabs(role) {
            const navigationTabs = document.getElementById('navigationTabs');
            let tabsHTML = '';
            
            if (role === 'admin') {
                tabsHTML = `
                    <button class="tab active" onclick="showTab('dashboard')">ğŸ“Š Dashboard</button>
                    <button class="tab" onclick="showTab('clienti')">ğŸ‘¥ ClienÈ›i</button>
                    <button class="tab" onclick="showTab('lucratori')">ğŸ‘¨â€ğŸ”§ LucrÄƒtori</button>
                    <button class="tab" onclick="showTab('asignari')">ğŸ“‹ AsignÄƒri</button>
                    <button class="tab" onclick="showTab('sms-management')">ğŸ“± SMS</button>
                    <button class="tab" onclick="showTab('security')">ğŸ”’ Securitate</button>
                    <button class="tab" onclick="showTab('rapoarte')">ğŸ“Š Rapoarte</button>
                `;
            } else if (role === 'worker') {
                tabsHTML = `
                    <button class="tab active" onclick="showTab('dashboard')">ğŸ  Dashboard</button>
                    <button class="tab" onclick="showTab('lucrarile-mele')">ğŸ”§ LucrÄƒrile Mele</button>
                    <button class="tab" onclick="showTab('finalizate')">âœ… Finalizate</button>
                `;
            }
            
            navigationTabs.innerHTML = tabsHTML;
        }

        // ğŸ¯ Data Loading Functions
        async function loadDashboard() {
            try {
                const statsGrid = document.getElementById('statsGrid');
                
                if (userRole === 'admin') {
                    // Admin dashboard
                    const clientsSnapshot = await getDocs(collection(db, 'clients'));
                    const workersSnapshot = await getDocs(collection(db, 'workers'));
                    const worksSnapshot = await getDocs(collection(db, 'lucrari'));
                    
                    const completedWorks = worksSnapshot.docs.filter(doc => doc.data().status === 'completed').length;
                    
                    statsGrid.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${clientsSnapshot.size}</div>
                            <div>ğŸ‘¥ Total ClienÈ›i</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workersSnapshot.size}</div>
                            <div>ğŸ‘¨â€ğŸ”§ Total LucrÄƒtori</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${worksSnapshot.size}</div>
                            <div>ğŸ”§ Total LucrÄƒri</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${completedWorks}</div>
                            <div>âœ… Completate</div>
                        </div>
                    `;
                } else if (userRole === 'worker') {
                    // Worker dashboard
                    const myWorksQuery = query(
                        collection(db, 'lucrari'),
                        where('assignedTo', '==', workerId)
                    );
                    const myWorksSnapshot = await getDocs(myWorksQuery);
                    
                    const myCompletedWorks = myWorksSnapshot.docs.filter(doc => doc.data().status === 'completed').length;
                    const myInProgressWorks = myWorksSnapshot.docs.filter(doc => doc.data().status === 'in_progress').length;
                    
                    statsGrid.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${myWorksSnapshot.size}</div>
                            <div>ğŸ”§ Total LucrÄƒri</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${myCompletedWorks}</div>
                            <div>âœ… Completate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${myInProgressWorks}</div>
                            <div>ğŸ”„ Ãn Progres</div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea dashboard-ului:', error);
            }
        }

        async function loadClients() {
            try {
                const clientsTableBody = document.getElementById('clientsTableBody');
                const clientsQuery = query(collection(db, 'clients'), orderBy('createdAt', 'desc'));
                const clientsSnapshot = await getDocs(clientsQuery);
                
                let html = '';
                clientsSnapshot.forEach(docSnapshot => {
                    const client = docSnapshot.data();
                    const fullName = `${client.name || ''} ${client.surname || ''}`.trim();
                    const services = client.services || [];
                    
                    // AfiÈ™eazÄƒ serviciile active
                    const activeServices = services.filter(s => s.status === 'active');
                    const servicesText = activeServices.length > 0 ? 
                        activeServices.map(s => s.serviceName).join(', ') : 
                        'FÄƒrÄƒ servicii';
                    
                    // GÄƒseÈ™te cea mai apropiatÄƒ expirare
                    const expiryDates = activeServices.map(s => new Date(s.endDate?.seconds ? s.endDate.seconds * 1000 : s.endDate));
                    const nextExpiry = expiryDates.length > 0 ? 
                        new Date(Math.min(...expiryDates)).toLocaleDateString('ro-RO') : 
                        'N/A';
                    
                    // VerificÄƒ dacÄƒ are expirÄƒri Ã®n curÃ¢nd
                    const today = new Date();
                    const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                    const hasUpcomingExpiry = expiryDates.some(date => date <= weekFromNow && date >= today);
                    const expiryClass = hasUpcomingExpiry ? 'style="background-color: #fff3cd;"' : '';
                    
                    html += `
                        <tr ${expiryClass}>
                            <td>
                                <strong>${fullName}</strong>
                                <br><small>${client.address?.city || 'N/A'}</small>
                            </td>
                            <td>${client.phone || 'N/A'}</td>
                            <td>${client.email || 'N/A'}</td>
                            <td>${client.fullAddress || 'N/A'}</td>
                            <td>
                                <small>${servicesText}</small>
                                ${activeServices.length > 0 ? `<br><span class="btn btn-info" style="font-size: 10px; padding: 2px 6px;">${activeServices.length} servicii</span>` : ''}
                            </td>
                            <td>
                                ${hasUpcomingExpiry ? 'âš ï¸ ' : ''}${nextExpiry}
                            </td>
                            <td>
                                <button class="btn btn-primary" onclick="viewClientDetails('${docSnapshot.id}')">ğŸ‘ï¸ Vezi</button>
                                <button class="btn btn-success" onclick="sendSMSToClient('${docSnapshot.id}')">ğŸ“± SMS</button>
                                <button class="btn btn-warning" onclick="manageClientServices('${docSnapshot.id}')">ğŸ”§ Servicii</button>
                                <button class="btn btn-danger" onclick="deleteClient('${docSnapshot.id}')">ğŸ—‘ï¸ È˜terge</button>
                            </td>
                        </tr>
                    `;
                });
                
                clientsTableBody.innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea clienÈ›ilor:', error);
            }
        }

        async function loadWorkers() {
            try {
                const workersTableBody = document.getElementById('workersTableBody');
                const workersSnapshot = await getDocs(collection(db, 'workers'));
                
                let html = '';
                workersSnapshot.forEach(doc => {
                    const worker = doc.data();
                    const status = worker.userId ? 'âœ… Ãnregistrat' : 'â³ Ãn aÈ™teptare';
                    
                    html += `
                        <tr>
                            <td>${worker.name || 'N/A'}</td>
                            <td>${worker.email || 'N/A'}</td>
                            <td>${worker.phone || 'N/A'}</td>
                            <td>${worker.zone || 'N/A'}</td>
                            <td>${status}</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteWorker('${doc.id}')">ğŸ—‘ï¸ È˜terge</button>
                            </td>
                        </tr>
                    `;
                });
                
                workersTableBody.innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea lucrÄƒtorilor:', error);
            }
        }

        async function loadMyWorks() {
            try {
                const myWorksTableBody = document.getElementById('myWorksTableBody');
                const worksQuery = query(
                    collection(db, 'lucrari'),
                    where('assignedTo', '==', workerId),
                    where('status', 'in', ['pending', 'in_progress'])
                );
                const worksSnapshot = await getDocs(worksQuery);
                
                let html = '';
                for (const docSnapshot of worksSnapshot.docs) {
                    const work = docSnapshot.data();
                    
                    // Get client info
                    const clientDoc = await getDoc(doc(db, 'clients', work.clientId));
                    const clientName = clientDoc.exists() ? clientDoc.data().name : 'Client necunoscut';
                    
                    const createdAt = work.createdAt ? work.createdAt.toDate().toLocaleDateString('ro-RO') : 'N/A';
                    const statusText = work.status === 'pending' ? 'â³ Ãn aÈ™teptare' : 'ğŸ”„ Ãn progres';
                    
                    html += `
                        <tr>
                            <td>${clientName}</td>
                            <td>${work.workType || 'N/A'}</td>
                            <td>${createdAt}</td>
                            <td>${statusText}</td>
                            <td>
                                ${work.status === 'pending' ? 
                                    `<button class="btn btn-primary" onclick="startWork('${docSnapshot.id}')">ğŸš€ Ãncepe</button>` :
                                    `<button class="btn btn-success" onclick="completeWork('${docSnapshot.id}')">âœ… FinalizeazÄƒ</button>`
                                }
                            </td>
                        </tr>
                    `;
                }
                
                myWorksTableBody.innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea lucrÄƒrilor:', error);
            }
        }

        async function loadCompletedWorks() {
            try {
                const completedWorksTableBody = document.getElementById('completedWorksTableBody');
                const worksQuery = query(
                    collection(db, 'lucrari'),
                    where('assignedTo', '==', workerId),
                    where('status', '==', 'completed')
                );
                const worksSnapshot = await getDocs(worksQuery);
                
                let html = '';
                for (const docSnapshot of worksSnapshot.docs) {
                    const work = docSnapshot.data();
                    
                    // Get client info
                    const clientDoc = await getDoc(doc(db, 'clients', work.clientId));
                    const clientName = clientDoc.exists() ? clientDoc.data().name : 'Client necunoscut';
                    
                    const completedAt = work.completedAt ? work.completedAt.toDate().toLocaleDateString('ro-RO') : 'N/A';
                    
                    html += `
                        <tr>
                            <td>${clientName}</td>
                            <td>${work.workType || 'N/A'}</td>
                            <td>${completedAt}</td>
                            <td>â­â­â­â­â­</td>
                            <td>ğŸ“„ Vezi documente</td>
                        </tr>
                    `;
                }
                
                completedWorksTableBody.innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea lucrÄƒrilor finalizate:', error);
            }
        }

        // ğŸ¯ Modal Functions
        function showAddClientModal() {
            populateCitiesDropdown();
            populateServicesCheckboxes();
            setDefaultServiceDate();
            document.getElementById('addClientModal').style.display = 'block';
        }

        function populateCitiesDropdown() {
            const citySelect = document.getElementById('clientCity');
            citySelect.innerHTML = '<option value="">SelecteazÄƒ oraÈ™ul</option>';
            
            teleormanCities.forEach(city => {
                citySelect.innerHTML += `<option value="${city}">${city}</option>`;
            });
        }

        function populateServicesCheckboxes() {
            const servicesDiv = document.getElementById('servicesCheckboxes');
            let html = '';
            
            Object.keys(services).forEach(serviceKey => {
                const service = services[serviceKey];
                const priceText = service.price > 0 ? `${service.price} RON` : 'PreÈ› variabil';
                
                html += `
                    <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #eee; border-radius: 5px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="services" value="${serviceKey}" style="margin-right: 10px;">
                            <div>
                                <strong>${service.name}</strong> - ${priceText}
                                <br><small style="color: #666;">${service.description}</small>
                            </div>
                        </label>
                    </div>
                `;
            });
            
            servicesDiv.innerHTML = html;
        }

        function setDefaultServiceDate() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            document.getElementById('servicesStartDate').value = todayString;
        }

        function showSendSMSModal() {
            populateClientsForSMS();
            document.getElementById('sendSMSModal').style.display = 'block';
        }

        function showBulkSMSModal() {
            populateCitiesForBulkSMS();
            updateBulkSMSList();
            document.getElementById('bulkSMSModal').style.display = 'block';
        }

        async function populateClientsForSMS() {
            try {
                const clientSelect = document.getElementById('smsClient');
                const clientsSnapshot = await getDocs(collection(db, 'clients'));
                
                clientSelect.innerHTML = '<option value="">SelecteazÄƒ clientul</option>';
                clientsSnapshot.forEach(docSnapshot => {
                    const client = docSnapshot.data();
                    clientSelect.innerHTML += `<option value="${docSnapshot.id}" data-phone="${client.phone}">${client.name} ${client.surname} - ${client.phone}</option>`;
                });
                
                // Event listener pentru popularea automatÄƒ a telefonului
                clientSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const phone = selectedOption.getAttribute('data-phone') || '';
                    document.getElementById('smsPhone').value = phone;
                });
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea clienÈ›ilor pentru SMS:', error);
            }
        }

        function populateCitiesForBulkSMS() {
            const citySelect = document.getElementById('bulkSMSCity');
            citySelect.innerHTML = '<option value="">Toate oraÈ™ele</option>';
            
            teleormanCities.forEach(city => {
                citySelect.innerHTML += `<option value="${city}">${city}</option>`;
            });
        }

        // ğŸ“± SMS Character counting
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const smsMessage = document.getElementById('smsMessage');
                const bulkSMSMessage = document.getElementById('bulkSMSMessage');
                
                if (smsMessage) {
                    smsMessage.addEventListener('input', function() {
                        const remaining = 160 - this.value.length;
                        document.getElementById('smsCharCount').textContent = remaining;
                    });
                }
                
                if (bulkSMSMessage) {
                    bulkSMSMessage.addEventListener('input', function() {
                        const remaining = 160 - this.value.length;
                        document.getElementById('bulkSMSCharCount').textContent = remaining;
                    });
                }
            }, 1000);
        });

        function loadSMSTemplate() {
            const template = document.getElementById('smsTemplate').value;
            const messageField = document.getElementById('smsMessage');
            
            switch(template) {
                case 'reminder_7':
                    messageField.value = 'Buna ziua! Serviciul dumneavoastra va expira in 7 zile. Pentru reinnoire contactati 0762 614 401. AdInstalGaz';
                    break;
                case 'reminder_1':
                    messageField.value = 'URGENT! Serviciul dumneavoastra expira MAINE! Contactati 0762 614 401. AdInstalGaz';
                    break;
                case 'renewed':
                    messageField.value = 'Serviciul dumneavoastra a fost reinnoit cu succes. Multumim! AdInstalGaz 0762 614 401';
                    break;
                default:
                    messageField.value = '';
            }
            
            // Update character count
            const remaining = 160 - messageField.value.length;
            document.getElementById('smsCharCount').textContent = remaining;
        }

        function showAddWorkerModal() {
            document.getElementById('addWorkerModal').style.display = 'block';
        }

        function showAssignWorkModal() {
            loadClientsAndWorkersForAssignment();
            document.getElementById('assignWorkModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function loadClientsAndWorkersForAssignment() {
            try {
                const clientSelect = document.getElementById('assignClient');
                const workerSelect = document.getElementById('assignWorker');
                
                // Load clients
                const clientsSnapshot = await getDocs(collection(db, 'clients'));
                clientSelect.innerHTML = '<option value="">SelecteazÄƒ clientul</option>';
                clientsSnapshot.forEach(docSnapshot => {
                    const client = docSnapshot.data();
                    clientSelect.innerHTML += `<option value="${docSnapshot.id}">${client.name}</option>`;
                });
                
                // Load workers
                const workersSnapshot = await getDocs(collection(db, 'workers'));
                workerSelect.innerHTML = '<option value="">SelecteazÄƒ lucrÄƒtorul</option>';
                workersSnapshot.forEach(docSnapshot => {
                    const worker = docSnapshot.data();
                    workerSelect.innerHTML += `<option value="${docSnapshot.id}">${worker.name}</option>`;
                });
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea datelor pentru asignare:', error);
            }
        }

        // ğŸ¯ CRUD Functions - Cu validare È™i logging
        async function addClient(event) {
            event.preventDefault();
            
            try {
                // ğŸ” VALIDÄ‚RI AVANSATE
                const name = document.getElementById('clientName').value;
                const surname = document.getElementById('clientSurname').value;
                const phone = document.getElementById('clientPhone').value;
                const email = document.getElementById('clientEmail').value;
                const city = document.getElementById('clientCity').value;
                
                // ValideazÄƒ toate cÃ¢mpurile
                const nameValidation = validation.name(name);
                if (!nameValidation.valid) {
                    alert('âŒ ' + nameValidation.message);
                    return;
                }
                
                const surnameValidation = validation.name(surname);
                if (!surnameValidation.valid) {
                    alert('âŒ Prenume: ' + surnameValidation.message);
                    return;
                }
                
                const phoneValidation = validation.phone(phone);
                if (!phoneValidation.valid) {
                    alert('âŒ ' + phoneValidation.message);
                    return;
                }
                
                if (email) {
                    const emailValidation = validation.email(email);
                    if (!emailValidation.valid) {
                        alert('âŒ ' + emailValidation.message);
                        return;
                    }
                }
                
                const cityValidation = validation.city(city);
                if (!cityValidation.valid) {
                    alert('âŒ ' + cityValidation.message);
                    return;
                }
                
                // VerificÄƒ dacÄƒ telefonul existÄƒ deja
                const existingClientQuery = query(
                    collection(db, 'clients'),
                    where('phone', '==', phone)
                );
                const existingClientSnapshot = await getDocs(existingClientQuery);
                
                if (!existingClientSnapshot.empty) {
                    alert('âŒ ExistÄƒ deja un client cu acest numÄƒr de telefon!');
                    await logger.log(`Duplicate phone attempted: ${phone}`, 'error', 'Client creation failed - duplicate phone');
                    return;
                }
                
                // ColecteazÄƒ serviciile selectate
                const selectedServices = [];
                document.querySelectorAll('input[name="services"]:checked').forEach(checkbox => {
                    const serviceKey = checkbox.value;
                    const service = services[serviceKey];
                    const startDate = new Date(document.getElementById('servicesStartDate').value);
                    const endDate = new Date(startDate);
                    endDate.setFullYear(endDate.getFullYear() + 2); // +2 ani
                    
                    selectedServices.push({
                        serviceKey: serviceKey,
                        serviceName: service.name,
                        price: service.price,
                        startDate: startDate,
                        endDate: endDate,
                        status: 'active'
                    });
                });

                // ValideazÄƒ serviciile
                const servicesValidation = validation.services(selectedServices);
                if (!servicesValidation.valid) {
                    alert('âŒ ' + servicesValidation.message);
                    return;
                }

                // ConstruieÈ™te adresa completÄƒ
                const address = {
                    city: city,
                    street: document.getElementById('clientStreet').value,
                    number: document.getElementById('clientNumber').value,
                    block: document.getElementById('clientBlock').value || '',
                    staircase: document.getElementById('clientStaircase').value || '',
                    floor: document.getElementById('clientFloor').value || '',
                    apartment: document.getElementById('clientApartment').value || ''
                };

                const fullAddress = `${address.street} ${address.number}${address.block ? ', Bl.' + address.block : ''}${address.staircase ? ', Sc.' + address.staircase : ''}${address.floor ? ', Et.' + address.floor : ''}${address.apartment ? ', Ap.' + address.apartment : ''}, ${address.city}`;

                const clientData = {
                    name: name,
                    surname: surname,
                    phone: phone,
                    email: email,
                    address: address,
                    fullAddress: fullAddress,
                    services: selectedServices,
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid,
                    lastUpdated: serverTimestamp()
                };
                
                showLoading(true);
                const clientRef = await addDoc(collection(db, 'clients'), clientData);
                
                // ProgrameazÄƒ SMS-urile de reminder pentru fiecare serviciu
                for (const service of selectedServices) {
                    await scheduleServiceReminders(clientRef.id, service);
                }
                
                // ğŸ“ LOG ACTIVITATE
                await logger.logClientAdded(clientRef.id, `${name} ${surname}`);
                
                alert(`âœ… Client ${name} ${surname} adÄƒugat cu succes cu ${selectedServices.length} servicii!`);
                closeModal('addClientModal');
                loadClients();
                
                // Reset form
                document.getElementById('addClientModal').querySelector('form').reset();
                document.querySelectorAll('input[name="services"]').forEach(cb => cb.checked = false);
                
                showLoading(false);
                
            } catch (error) {
                console.error('âŒ Eroare la adÄƒugarea clientului:', error);
                await logger.log(`Client creation failed`, 'error', error.message);
                alert('Eroare la adÄƒugarea clientului: ' + error.message);
                showLoading(false);
            }
        }

        // ğŸ“… ProgrameazÄƒ reminder-urile pentru un serviciu
        async function scheduleServiceReminders(clientId, service) {
            try {
                const reminder7Days = new Date(service.endDate);
                reminder7Days.setDate(reminder7Days.getDate() - 7);
                
                const reminder1Day = new Date(service.endDate);
                reminder1Day.setDate(reminder1Day.getDate() - 1);
                
                const reminderData = {
                    clientId: clientId,
                    serviceKey: service.serviceKey,
                    serviceName: service.serviceName,
                    expiryDate: service.endDate,
                    reminders: [
                        {
                            type: '7_days',
                            scheduledDate: reminder7Days,
                            sent: false
                        },
                        {
                            type: '1_day', 
                            scheduledDate: reminder1Day,
                            sent: false
                        }
                    ],
                    createdAt: serverTimestamp()
                };
                
                await addDoc(collection(db, 'reminders'), reminderData);
                console.log(`âœ… Reminder-uri programate pentru serviciul ${service.serviceName}`);
                
            } catch (error) {
                console.error('âŒ Eroare la programarea reminder-urilor:', error);
            }
        }

        // ğŸ“± SMS Functions
        async function loadSMSManagement() {
            try {
                await loadSMSStatistics();
                await loadSMSHistory();
                await loadUpcomingReminders();
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea gestionÄƒrii SMS:', error);
            }
        }

        async function loadSMSStatistics() {
            try {
                // CalculeazÄƒ statistici SMS
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const thisMonth = new Date();
                thisMonth.setDate(1);
                thisMonth.setHours(0, 0, 0, 0);
                
                const smsSnapshot = await getDocs(collection(db, 'sms_logs'));
                const smsData = smsSnapshot.docs.map(doc => ({
                    ...doc.data(),
                    sentAt: doc.data().sentAt?.toDate()
                }));
                
                const smsToday = smsData.filter(sms => 
                    sms.sentAt && sms.sentAt >= today
                ).length;
                
                const smsThisMonth = smsData.filter(sms => 
                    sms.sentAt && sms.sentAt >= thisMonth
                ).length;
                
                const remindersQuery = query(
                    collection(db, 'reminders'),
                    where('reminders', 'array-contains', { sent: false })
                );
                const remindersSnapshot = await getDocs(remindersQuery);
                
                document.getElementById('smsToday').textContent = smsToday;
                document.getElementById('smsThisMonth').textContent = smsThisMonth;
                document.getElementById('pendingReminders').textContent = remindersSnapshot.size;
                
            } catch (error) {
                console.error('âŒ Eroare la calcularea statisticilor SMS:', error);
            }
        }

        async function loadSMSHistory() {
            try {
                const smsHistoryTableBody = document.getElementById('smsHistoryTableBody');
                const smsQuery = query(
                    collection(db, 'sms_logs'),
                    orderBy('sentAt', 'desc'),
                    limit(50)
                );
                const smsSnapshot = await getDocs(smsQuery);
                
                let html = '';
                smsSnapshot.forEach(docSnapshot => {
                    const sms = docSnapshot.data();
                    const sentAt = sms.sentAt ? sms.sentAt.toDate().toLocaleString('ro-RO') : 'N/A';
                    const status = sms.success ? 'âœ… Trimis' : 'âŒ EÈ™uat';
                    const cost = sms.cost ? `${sms.cost} RON` : 'N/A';
                    
                    html += `
                        <tr>
                            <td>${sentAt}</td>
                            <td>${sms.clientName || 'N/A'}</td>
                            <td>${sms.phone || 'N/A'}</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${sms.message || 'N/A'}</td>
                            <td>${status}</td>
                            <td>${cost}</td>
                        </tr>
                    `;
                });
                
                smsHistoryTableBody.innerHTML = html || '<tr><td colspan="6">Nu existÄƒ istoric SMS</td></tr>';
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea istoricului SMS:', error);
            }
        }

        async function loadUpcomingReminders() {
            try {
                const remindersTableBody = document.getElementById('remindersTableBody');
                const remindersSnapshot = await getDocs(collection(db, 'reminders'));
                
                let html = '';
                for (const docSnapshot of remindersSnapshot.docs) {
                    const reminder = docSnapshot.data();
                    
                    // ObÈ›ine datele clientului
                    const clientDoc = await getDoc(doc(db, 'clients', reminder.clientId));
                    const client = clientDoc.exists() ? clientDoc.data() : { name: 'Client necunoscut', surname: '' };
                    
                    const expiryDate = reminder.expiryDate ? reminder.expiryDate.toDate().toLocaleDateString('ro-RO') : 'N/A';
                    
                    // VerificÄƒ ce reminder-uri nu au fost trimise
                    const pendingReminders = reminder.reminders?.filter(r => !r.sent) || [];
                    
                    if (pendingReminders.length > 0) {
                        html += `
                            <tr>
                                <td>${client.name} ${client.surname}</td>
                                <td>${reminder.serviceName}</td>
                                <td>${expiryDate}</td>
                                <td>${pendingReminders.map(r => r.type === '7_days' ? '7 zile' : '1 zi').join(', ')}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="sendReminderNow('${docSnapshot.id}', '7_days')">ğŸ“¤ 7 zile</button>
                                    <button class="btn btn-warning" onclick="sendReminderNow('${docSnapshot.id}', '1_day')">ğŸ“¤ 1 zi</button>
                                </td>
                            </tr>
                        `;
                    }
                }
                
                remindersTableBody.innerHTML = html || '<tr><td colspan="5">Nu existÄƒ reminder-uri pendinte</td></tr>';
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea reminder-urilor:', error);
            }
        }

        // FuncÈ›ii pentru tab-ul de securitate
        async function loadSecurityDashboard() {
            try {
                await loadSecurityStatistics();
                await loadActivityLogs();
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea dashboard-ului de securitate:', error);
            }
        }

        async function loadSecurityStatistics() {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Statistici conectÄƒri
                const logsQuery = query(
                    collection(db, 'activity_logs'),
                    where('timestamp', '>=', today),
                    where('type', '==', 'auth')
                );
                const logsSnapshot = await getDocs(logsQuery);
                
                let totalLogins = 0;
                let failedAttempts = 0;
                const activeUsers = new Set();
                
                logsSnapshot.forEach(docSnapshot => {
                    const log = docSnapshot.data();
                    if (log.action.includes('Successful login')) {
                        totalLogins++;
                        activeUsers.add(log.userEmail);
                    } else if (log.action.includes('Failed login')) {
                        failedAttempts++;
                    }
                });
                
                // Ultimul backup
                const backupsQuery = query(
                    collection(db, 'backups'),
                    orderBy('timestamp', 'desc'),
                    limit(1)
                );
                const backupsSnapshot = await getDocs(backupsQuery);
                let lastBackup = 'NiciodatÄƒ';
                
                if (!backupsSnapshot.empty) {
                    const lastBackupData = backupsSnapshot.docs[0].data();
                    lastBackup = new Date(lastBackupData.timestamp).toLocaleDateString('ro-RO');
                }
                
                // ActualizeazÄƒ statisticile
                document.getElementById('totalLogins').textContent = totalLogins;
                document.getElementById('activeUsers').textContent = activeUsers.size;
                document.getElementById('failedAttempts').textContent = failedAttempts;
                document.getElementById('lastBackup').textContent = lastBackup;
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea statisticilor de securitate:', error);
            }
        }

        async function loadActivityLogs(filter = 'all') {
            try {
                const logsTableBody = document.getElementById('logsTableBody');
                
                let logsQuery = query(
                    collection(db, 'activity_logs'),
                    orderBy('timestamp', 'desc'),
                    limit(50)
                );
                
                if (filter !== 'all') {
                    logsQuery = query(
                        collection(db, 'activity_logs'),
                        where('type', '==', filter),
                        orderBy('timestamp', 'desc'),
                        limit(50)
                    );
                }
                
                const logsSnapshot = await getDocs(logsQuery);
                
                let html = '';
                logsSnapshot.forEach(docSnapshot => {
                    const log = docSnapshot.data();
                    const timestamp = log.timestamp ? log.timestamp.toDate().toLocaleString('ro-RO') : 'N/A';
                    
                    // IconiÈ›e pentru tipuri
                    const typeIcons = {
                        'auth': 'ğŸ”',
                        'client': 'ğŸ‘¥',
                        'worker': 'ğŸ‘¨â€ğŸ”§',
                        'sms': 'ğŸ“±',
                        'error': 'âŒ',
                        'security': 'ğŸ›¡ï¸'
                    };
                    
                    html += `
                        <tr>
                            <td>${timestamp}</td>
                            <td>${log.userEmail}</td>
                            <td>${log.action}</td>
                            <td>${typeIcons[log.type] || 'ğŸ“'} ${log.type}</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${log.details || 'N/A'}</td>
                            <td>${log.ip || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                logsTableBody.innerHTML = html || '<tr><td colspan="6">Nu existÄƒ loguri</td></tr>';
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea logurilor:', error);
            }
        }

        // FuncÈ›ii pentru acÈ›iunile de securitate
        function createBackup() {
            if (confirm('SunteÈ›i sigur cÄƒ doriÈ›i sÄƒ creaÈ›i un backup manual? Procesul poate dura cÃ¢teva minute.')) {
                backup.create();
            }
        }

        async function downloadLogs() {
            try {
                showLoading(true);
                
                const logsQuery = query(
                    collection(db, 'activity_logs'), 
                    orderBy('timestamp', 'desc'), 
                    limit(1000)
                );
                const logsSnapshot = await getDocs(logsQuery);
                
                const logs = logsSnapshot.docs.map(docSnapshot => ({
                    id: docSnapshot.id,
                    ...docSnapshot.data()
                }));
                
                const filename = `logs_adinstalgaz_${new Date().toISOString().split('T')[0]}.json`;
                const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                await logger.log('Activity logs downloaded', 'security', `${logs.length} logs exported`);
                alert(`âœ… Loguri descÄƒrcate cu succes!\nğŸ“ FiÈ™ier: ${filename}\nğŸ“Š Total loguri: ${logs.length}`);
                
                showLoading(false);
                
            } catch (error) {
                console.error('âŒ Eroare la descÄƒrcarea logurilor:', error);
                alert('Eroare la descÄƒrcarea logurilor: ' + error.message);
                showLoading(false);
            }
        }

        function viewFailedLogins() {
            document.getElementById('logFilter').value = 'auth';
            filterLogs();
            alert('ğŸš¨ Au fost afiÈ™ate doar logurile de autentificare. CÄƒutaÈ›i intrÄƒrile cu "Failed login" pentru tentativele eÈ™uate.');
        }

        function filterLogs() {
            const filter = document.getElementById('logFilter').value;
            loadActivityLogs(filter);
        }

        function refreshLogs() {
            const filter = document.getElementById('logFilter').value;
            loadActivityLogs(filter);
        }

        function resetSecuritySettings() {
            if (confirm('âš ï¸ ATENÈšIE! AceastÄƒ acÈ›iune va reseta toate setÄƒrile de securitate. ContinuaÈ›i?')) {
                alert('ğŸ”„ SetÄƒrile de securitate au fost resetate la valorile implicite.');
                logger.log('Security settings reset', 'security', 'All security settings restored to default');
            }
        }

        async function viewClientDetails(clientId) {
            try {
                const clientDoc = await getDoc(doc(db, 'clients', clientId));
                if (!clientDoc.exists()) {
                    alert('âŒ Client nu existÄƒ!');
                    return;
                }
                
                const client = clientDoc.data();
                const services = client.services || [];
                
                let servicesInfo = services.map(service => {
                    const startDate = new Date(service.startDate?.seconds ? service.startDate.seconds * 1000 : service.startDate).toLocaleDateString('ro-RO');
                    const endDate = new Date(service.endDate?.seconds ? service.endDate.seconds * 1000 : service.endDate).toLocaleDateString('ro-RO');
                    return `â€¢ ${service.serviceName} (${service.price} RON) - ${startDate} â†’ ${endDate}`;
                }).join('\n');
                
                await logger.log(`Viewed client details: ${client.name} ${client.surname}`, 'client', `Client ID: ${clientId}`);
                
                alert(`ğŸ‘¤ ${client.name} ${client.surname}\nğŸ“ ${client.phone}\nğŸ“§ ${client.email}\nğŸ  ${client.fullAddress}\n\nğŸ”§ Servicii:\n${servicesInfo || 'FÄƒrÄƒ servicii active'}`);
                
            } catch (error) {
                console.error('âŒ Eroare la vizualizarea detaliilor clientului:', error);
                alert('Eroare la Ã®ncÄƒrcarea detaliilor clientului');
            }
        }

        async function sendSMSToClient(clientId) {
            try {
                const clientDoc = await getDoc(doc(db, 'clients', clientId));
                if (!clientDoc.exists()) {
                    alert('âŒ Client nu existÄƒ!');
                    return;
                }
                
                const client = clientDoc.data();
                
                // Pre-populeazÄƒ datele Ã®n modal
                const clientSelect = document.getElementById('smsClient');
                clientSelect.innerHTML = `<option value="${clientId}" selected>${client.name} ${client.surname} - ${client.phone}</option>`;
                document.getElementById('smsPhone').value = client.phone;
                document.getElementById('smsMessage').value = `Buna ziua, ${client.name}! `;
                
                showSendSMSModal();
                
            } catch (error) {
                console.error('âŒ Eroare la pregÄƒtirea SMS-ului:', error);
            }
        }

        async function manageClientServices(clientId) {
            try {
                const clientDoc = await getDoc(doc(db, 'clients', clientId));
                if (!clientDoc.exists()) {
                    alert('âŒ Client nu existÄƒ!');
                    return;
                }
                
                const client = clientDoc.data();
                const services = client.services || [];
                
                let servicesManagement = 'ğŸ”§ Gestionare Servicii pentru ' + client.name + ' ' + client.surname + '\n\n';
                
                if (services.length === 0) {
                    servicesManagement += 'Nu existÄƒ servicii active.\n\nVreÈ›i sÄƒ adÄƒugaÈ›i servicii?';
                    if (confirm(servicesManagement)) {
                        alert('FuncÈ›ionalitatea de adÄƒugare servicii va fi implementatÄƒ Ã®n curÃ¢nd!');
                    }
                } else {
                    services.forEach((service, index) => {
                        const endDate = new Date(service.endDate?.seconds ? service.endDate.seconds * 1000 : service.endDate).toLocaleDateString('ro-RO');
                        servicesManagement += `${index + 1}. ${service.serviceName} - expirÄƒ pe ${endDate}\n`;
                    });
                    
                    alert(servicesManagement);
                }
                
            } catch (error) {
                console.error('âŒ Eroare la gestionarea serviciilor:', error);
            }
        }

        async function sendManualSMS(event) {
            event.preventDefault();
            
            try {
                const clientId = document.getElementById('smsClient').value;
                const phone = document.getElementById('smsPhone').value;
                const message = document.getElementById('smsMessage').value;
                
                if (!clientId || !phone || !message) {
                    alert('âŒ VÄƒ rugÄƒm completaÈ›i toate cÃ¢mpurile!');
                    return;
                }
                
                // ValideazÄƒ telefonul
                const phoneValidation = validation.phone(phone);
                if (!phoneValidation.valid) {
                    alert('âŒ ' + phoneValidation.message);
                    return;
                }
                
                // ValideazÄƒ lungimea mesajului
                if (message.length > 160) {
                    alert('âŒ Mesajul nu poate depÄƒÈ™i 160 de caractere!');
                    return;
                }
                
                showLoading(true);
                
                // SimulÄƒm trimiterea SMS-ului (Ã®n realitate ar trebui sÄƒ foloseÈ™ti un serviciu SMS)
                const success = Math.random() > 0.1; // 90% È™anse de succes pentru simulare
                
                const smsLog = {
                    clientId: clientId,
                    phone: phone,
                    message: message,
                    sentAt: serverTimestamp(),
                    sentBy: currentUser.uid,
                    type: 'manual',
                    success: success,
                    cost: success ? 0.08 : 0 // Cost estimativ Ã®n RON
                };
                
                await addDoc(collection(db, 'sms_logs'), smsLog);
                await logger.logSMSSent(phone, message, success);
                
                if (success) {
                    alert(`âœ… SMS trimis cu succes la ${phone}!\n\nğŸ’¬ Mesaj: "${message}"\nğŸ’° Cost: 0.08 RON`);
                } else {
                    alert(`âŒ Eroare la trimiterea SMS-ului la ${phone}!\nVÄƒ rugÄƒm Ã®ncercaÈ›i din nou.`);
                }
                
                closeModal('sendSMSModal');
                
                // ReseteazÄƒ formularul
                document.getElementById('smsMessage').value = '';
                document.getElementById('smsTemplate').value = '';
                
                // ActualizeazÄƒ statisticile SMS
                if (document.getElementById('sms-management').style.display !== 'none') {
                    loadSMSStatistics();
                    loadSMSHistory();
                }
                
                showLoading(false);
                
            } catch (error) {
                console.error('âŒ Eroare la trimiterea SMS-ului:', error);
                await logger.log(`SMS sending failed to ${phone}`, 'error', error.message);
                alert('Eroare la trimiterea SMS-ului: ' + error.message);
                showLoading(false);
            }
        }

        async function checkExpiringServices() {
            try {
                const today = new Date();
                const sevenDaysFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                
                const clientsSnapshot = await getDocs(collection(db, 'clients'));
                let expiringCount = 0;
                let expiringList = [];
                
                clientsSnapshot.forEach(docSnapshot => {
                    const client = docSnapshot.data();
                    const services = client.services || [];
                    
                    services.forEach(service => {
                        const expiryDate = new Date(service.endDate?.seconds ? service.endDate.seconds * 1000 : service.endDate);
                        
                        if (expiryDate >= today && expiryDate <= sevenDaysFromNow) {
                            expiringCount++;
                            expiringList.push(`â€¢ ${client.name} ${client.surname} - ${service.serviceName} (expirÄƒ pe ${expiryDate.toLocaleDateString('ro-RO')})`);
                        }
                    });
                });
                
                if (expiringCount > 0) {
                    alert(`âš ï¸ Servicii care expirÄƒ Ã®n urmÄƒtoarele 7 zile: ${expiringCount}\n\n${expiringList.join('\n')}`);
                } else {
                    alert('âœ… Nu existÄƒ servicii care sÄƒ expire Ã®n urmÄƒtoarele 7 zile!');
                }
                
            } catch (error) {
                console.error('âŒ Eroare la verificarea expirÄƒrilor:', error);
                alert('Eroare la verificarea expirÄƒrilor: ' + error.message);
            }
        }

        async function sendReminderNow(reminderId, reminderType) {
            try {
                const reminderDoc = await getDoc(doc(db, 'reminders', reminderId));
                if (!reminderDoc.exists()) {
                    alert('âŒ Reminder-ul nu existÄƒ!');
                    return;
                }
                
                const reminder = reminderDoc.data();
                const clientDoc = await getDoc(doc(db, 'clients', reminder.clientId));
                
                if (!clientDoc.exists()) {
                    alert('âŒ Clientul nu existÄƒ!');
                    return;
                }
                
                const client = clientDoc.data();
                const expiryDate = new Date(reminder.expiryDate?.seconds ? reminder.expiryDate.seconds * 1000 : reminder.expiryDate).toLocaleDateString('ro-RO');
                
                let message;
                if (reminderType === '7_days') {
                    message = smsTemplates.reminder_7_days(`${client.name} ${client.surname}`, reminder.serviceName, expiryDate);
                } else {
                    message = smsTemplates.reminder_1_day(`${client.name} ${client.surname}`, reminder.serviceName, expiryDate);
                }
                
                // SimuleazÄƒ trimiterea SMS-ului
                const smsLog = {
                    clientId: reminder.clientId,
                    clientName: `${client.name} ${client.surname}`,
                    phone: client.phone,
                    message: message,
                    sentAt: serverTimestamp(),
                    sentBy: currentUser.uid,
                    type: 'reminder_' + reminderType,
                    success: true,
                    cost: 0.08
                };
                
                await addDoc(collection(db, 'sms_logs'), smsLog);
                
                // MarcheazÄƒ reminder-ul ca trimis
                const updatedReminders = reminder.reminders.map(r => 
                    r.type === reminderType ? {...r, sent: true, sentAt: new Date()} : r
                );
                
                await updateDoc(doc(db, 'reminders', reminderId), {
                    reminders: updatedReminders
                });
                
                alert(`âœ… Reminder ${reminderType} trimis cu succes la ${client.phone}!`);
                
                // ReÃ®ncarcÄƒ datele
                loadUpcomingReminders();
                loadSMSStatistics();
                
            } catch (error) {
                console.error('âŒ Eroare la trimiterea reminder-ului:', error);
                alert('Eroare la trimiterea reminder-ului: ' + error.message);
            }
        }

        async function addWorker(event) {
            event.preventDefault();
            
            try {
                const workerData = {
                    name: document.getElementById('workerName').value,
                    email: document.getElementById('workerEmail').value,
                    phone: document.getElementById('workerPhone').value,
                    zone: document.getElementById('workerZone').value,
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                await addDoc(collection(db, 'workers'), workerData);
                
                alert('âœ… LucrÄƒtor adÄƒugat cu succes! Poate sÄƒ se Ã®nregistreze cu emailul: ' + workerData.email);
                closeModal('addWorkerModal');
                loadWorkers();
                
                // Reset form
                document.getElementById('workerName').value = '';
                document.getElementById('workerEmail').value = '';
                document.getElementById('workerPhone').value = '';
                document.getElementById('workerZone').value = '';
                
            } catch (error) {
                console.error('âŒ Eroare la adÄƒugarea lucrÄƒtorului:', error);
                alert('Eroare la adÄƒugarea lucrÄƒtorului: ' + error.message);
            }
        }

        async function assignWork(event) {
            event.preventDefault();
            
            try {
                const workData = {
                    clientId: document.getElementById('assignClient').value,
                    assignedTo: document.getElementById('assignWorker').value,
                    workType: document.getElementById('workType').value,
                    description: document.getElementById('workDescription').value,
                    priority: document.getElementById('workPriority').value,
                    status: 'pending',
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                await addDoc(collection(db, 'lucrari'), workData);
                
                alert('âœ… Lucrare asignatÄƒ cu succes!');
                closeModal('assignWorkModal');
                
                // Reset form
                document.getElementById('assignClient').value = '';
                document.getElementById('assignWorker').value = '';
                document.getElementById('workType').value = '';
                document.getElementById('workDescription').value = '';
                document.getElementById('workPriority').value = 'normal';
                
            } catch (error) {
                console.error('âŒ Eroare la asignarea lucrÄƒrii:', error);
                alert('Eroare la asignarea lucrÄƒrii: ' + error.message);
            }
        }

        async function startWork(workId) {
            try {
                await updateDoc(doc(db, 'lucrari', workId), {
                    status: 'in_progress',
                    startedAt: serverTimestamp()
                });
                
                alert('âœ… Lucrarea a fost Ã®nceputÄƒ!');
                loadMyWorks();
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®nceperea lucrÄƒrii:', error);
                alert('Eroare la Ã®nceperea lucrÄƒrii: ' + error.message);
            }
        }

        async function completeWork(workId) {
            try {
                await updateDoc(doc(db, 'lucrari', workId), {
                    status: 'completed',
                    completedAt: serverTimestamp()
                });
                
                alert('âœ… Lucrarea a fost finalizatÄƒ!');
                loadMyWorks();
                
            } catch (error) {
                console.error('âŒ Eroare la finalizarea lucrÄƒrii:', error);
                alert('Eroare la finalizarea lucrÄƒrii: ' + error.message);
            }
        }

        async function refreshClients() {
            try {
                console.log('ğŸ”„ Actualizez lista clienÈ›ilor...');
                await loadClients();
                alert('âœ… Lista clienÈ›ilor actualizatÄƒ!');
            } catch (error) {
                console.error('âŒ Eroare la actualizarea clienÈ›ilor:', error);
                alert('Eroare la actualizare: ' + error.message);
            }
        }

        async function refreshWorkers() {
            try {
                console.log('ğŸ”„ Actualizez lista lucrÄƒtorilor...');
                await loadWorkers();
                alert('âœ… Lista lucrÄƒtorilor actualizatÄƒ!');
            } catch (error) {
                console.error('âŒ Eroare la actualizarea lucrÄƒtorilor:', error);
                alert('Eroare la actualizare: ' + error.message);
            }
        }

        async function deleteClient(clientId) {
            if (confirm('âš ï¸ EÈ™ti sigur cÄƒ vrei sÄƒ È™tergi acest client? AceastÄƒ acÈ›iune nu poate fi anulatÄƒ!')) {
                try {
                    showLoading(true);
                    
                    // ObÈ›ine datele clientului Ã®nainte de È™tergere pentru log
                    const clientDoc = await getDoc(doc(db, 'clients', clientId));
                    const clientData = clientDoc.exists() ? clientDoc.data() : null;
                    const clientName = clientData ? `${clientData.name} ${clientData.surname}` : 'Client necunoscut';
                    
                    // È˜terge clientul
                    await deleteDoc(doc(db, 'clients', clientId));
                    
                    // È˜terge reminder-urile asociate
                    const remindersQuery = query(
                        collection(db, 'reminders'),
                        where('clientId', '==', clientId)
                    );
                    const remindersSnapshot = await getDocs(remindersQuery);
                    
                    for (const reminderDoc of remindersSnapshot.docs) {
                        await deleteDoc(doc(db, 'reminders', reminderDoc.id));
                    }
                    
                    // Log È™tergerea
                    await logger.logClientDeleted(clientId, clientName);
                    
                    alert('âœ… Client È™i toate datele asociate au fost È™terse cu succes!');
                    loadClients();
                    showLoading(false);
                    
                } catch (error) {
                    console.error('âŒ Eroare la È™tergerea clientului:', error);
                    await logger.log(`Client deletion failed: ${clientId}`, 'error', error.message);
                    alert('Eroare la È™tergerea clientului: ' + error.message);
                    showLoading(false);
                }
            }
        }

        async function deleteWorker(workerId) {
            if (confirm('EÈ™ti sigur cÄƒ vrei sÄƒ È™tergi acest lucrÄƒtor?')) {
                try {
                    await deleteDoc(doc(db, 'workers', workerId));
                    alert('âœ… LucrÄƒtor È™ters cu succes!');
                    loadWorkers();
                } catch (error) {
                    console.error('âŒ Eroare la È™tergerea lucrÄƒtorului:', error);
                    alert('Eroare la È™tergere: ' + error.message);
                }
            }
        }

        async function assignWorkToClient(clientId) {
            // Set the client in the modal and open it
            await loadClientsAndWorkersForAssignment();
            document.getElementById('assignClient').value = clientId;
            showAssignWorkModal();
        }

        async function loadAssignments() {
            try {
                const assignmentsTableBody = document.getElementById('assignmentsTableBody');
                const worksQuery = query(collection(db, 'lucrari'), orderBy('createdAt', 'desc'));
                const worksSnapshot = await getDocs(worksQuery);
                
                let html = '';
                for (const docSnapshot of worksSnapshot.docs) {
                    const work = docSnapshot.data();
                    
                    // Get client and worker info
                    const clientDoc = await getDoc(doc(db, 'clients', work.clientId));
                    const workerDoc = await getDoc(doc(db, 'workers', work.assignedTo));
                    
                    const clientName = clientDoc.exists() ? clientDoc.data().name : 'Client necunoscut';
                    const workerName = workerDoc.exists() ? workerDoc.data().name : 'LucrÄƒtor necunoscut';
                    const createdAt = work.createdAt ? work.createdAt.toDate().toLocaleDateString('ro-RO') : 'N/A';
                    
                    const statusText = work.status === 'completed' ? 'âœ… CompletatÄƒ' : 
                                     work.status === 'in_progress' ? 'ğŸ”„ Ãn progres' : 'â³ Ãn aÈ™teptare';
                    
                    html += `
                        <tr>
                            <td>${clientName}</td>
                            <td>${workerName}</td>
                            <td>${work.workType || 'N/A'}</td>
                            <td>${createdAt}</td>
                            <td>${statusText}</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteAssignment('${docSnapshot.id}')">ğŸ—‘ï¸ È˜terge</button>
                            </td>
                        </tr>
                    `;
                }
                
                assignmentsTableBody.innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Eroare la Ã®ncÄƒrcarea asignÄƒrilor:', error);
            }
        }

        async function deleteAssignment(assignmentId) {
            if (confirm('EÈ™ti sigur cÄƒ vrei sÄƒ È™tergi aceastÄƒ asignare?')) {
                try {
                    await deleteDoc(doc(db, 'lucrari', assignmentId));
                    alert('âœ… Asignare È™tearsÄƒ cu succes!');
                    loadAssignments();
                } catch (error) {
                    console.error('âŒ Eroare la È™tergerea asignÄƒrii:', error);
                    alert('Eroare la È™tergere: ' + error.message);
                }
            }
        }

        // Bulk SMS placeholder functions
        function updateBulkSMSList() {
            // Placeholder function for bulk SMS
            console.log('ğŸ“¢ Bulk SMS list update');
        }

        function sendBulkSMS(event) {
            event.preventDefault();
            alert('ğŸ“¢ FuncÈ›ionalitatea SMS Ã®n masÄƒ va fi implementatÄƒ Ã®n curÃ¢nd!');
        }

        // ğŸ¯ Export Functions
        const generateCustomReport = async (format) => {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const status = document.getElementById('reportStatus').value;
            
            const filters = {};
            if (startDate) filters.startDate = new Date(startDate);
            if (endDate) filters.endDate = new Date(endDate);
            if (status) filters.status = status;
            
            const result = await generateReport(filters, format, 'complete');
            
            if (result.success) {
                alert(`âœ… Raport ${format.toUpperCase()} generat: ${result.filename}`);
            } else {
                alert(`âŒ Eroare: ${result.error}`);
            }
        };

        // ğŸ¯ Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('ğŸ‘¤ User authenticated:', user.email);
                currentUser = user;
                
                try {
                    // Get user data from Firestore
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        userRole = userData.role;
                        workerId = userData.workerId;
                        
                        console.log('ğŸ­ User role:', userRole);
                        
                        // Update UI
                        document.getElementById('authContainer').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        document.getElementById('userInfo').style.display = 'flex';
                        document.getElementById('userEmail').textContent = user.email;
                        document.getElementById('userRole').textContent = userRole === 'admin' ? 'ğŸ‘‘ Administrator' : 'ğŸ‘¨â€ğŸ”§ LucrÄƒtor';
                        
                        // Create navigation based on role
                        createNavigationTabs(userRole);
                        
                        // Load initial dashboard
                        loadDashboard();
                        
                    } else {
                        console.error('âŒ User document not found in Firestore');
                        alert('Eroare: Datele utilizatorului nu au fost gÄƒsite');
                        signOut(auth);
                    }
                    
                } catch (error) {
                    console.error('âŒ Error loading user data:', error);
                    alert('Eroare la Ã®ncÄƒrcarea datelor utilizatorului');
                }
                
            } else {
                console.log('ğŸ‘¤ User not authenticated');
                currentUser = null;
                userRole = null;
                workerId = null;
                
                // Show auth forms
                document.getElementById('authContainer').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('userInfo').style.display = 'none';
            }
        });

        // ğŸ¯ Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”¥ Firebase PWA Ready - Service Worker not needed!');
            
            // IniÈ›ializeazÄƒ sistemul de securitate
            console.log('ğŸ”’ IniÈ›ializeazÄƒ sistemul de securitate...');
            
            // ProgrameazÄƒ backup automat
            backup.scheduleAutoBackup();
            
            // Log aplicaÈ›ia a pornit
            logger.log('Application started', 'security', 'AdInstalGaz system initialized');
            
            // Close modals when clicking outside
            window.onclick = function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            };
            
            // Previne submit-ul formularelor cu Enter dacÄƒ nu este explicit
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && event.target.tagName !== 'BUTTON' && event.target.type !== 'submit') {
                    // Permite Enter doar Ã®n textarea-uri
                    if (event.target.tagName !== 'TEXTAREA') {
                        event.preventDefault();
                    }
                }
            });
            
            // ProtecÈ›ie Ã®mpotriva SQL injection Ã®n cÄƒutÄƒri
            document.addEventListener('input', function(event) {
                if (event.target.type === 'search' || event.target.classList.contains('search-input')) {
                    const value = event.target.value;
                    const dangerousChars = /[<>'"%;()&+]/g;
                    if (dangerousChars.test(value)) {
                        event.target.value = value.replace(dangerousChars, '');
                        console.warn('ğŸš¨ Caractere periculoase eliminate din cÄƒutare');
                    }
                }
            });
            
            console.log('âœ… Sistem de securitate iniÈ›ializat cu succes!');
        });
    </script>
</body>
</html>
